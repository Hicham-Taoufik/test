<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Always Display Print Button</title>
  <style>
    /* Keep #createResult visible from start (no display:none) */
    #createResult {
      margin-top: 1rem;
      background: #f0f0ff;
      border-left: 4px solid #5d74f2;
      padding: 1rem;
      border-radius: 6px;
    }
    #createQrCodeImage {
      max-width: 160px;
      display: block;
      margin: 0 auto 1rem auto;
      border: 1px solid #ccc;
      background: #fff;
    }
    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-secondary {
      background: #6b7280;  /* Gray */
      color: white;
    }
    .btn-secondary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>Créer Patient</h2>
  <form id="createForm">
    <input type="text" id="prenom" placeholder="Prénom" required>
    <input type="text" id="nom" placeholder="Nom" required>
    <button type="submit">Créer Patient</button>
  </form>

  <!-- Always visible, but print button is disabled initially -->
  <div id="createResult">
    <p id="createResultMessage">QR et message apparaîtront ici.</p>
    <img id="createQrCodeImage" src="" alt="QR Code" />
    <button
      id="createPrintButton"
      class="btn btn-secondary"
      disabled
    >
      <i class="fas fa-print"></i> Imprimer QR Code
    </button>
  </div>

  <script>
    // Quick function to simulate generating a QR code URL
    function generateQrData(prenom, nom) {
      const randomIPP = 'IPP' + Math.floor(Math.random() * 100000);
      return {
        qrImageUrl:
          'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data='
          + encodeURIComponent('app://medilink/patient?ipp=' + randomIPP),
        ipp: randomIPP,
      };
    }

    // Simple print function
    function printQRCode(qrUrl) {
      const newWin = window.open('', '_blank', 'width=400,height=450');
      if (!newWin) {
        alert("Popup blocked!");
        return;
      }
      newWin.document.write(`
        <html><head><title>Print QR</title></head>
        <body style="text-align:center;">
          <img src="${qrUrl}" style="margin:20px auto;max-width:200px;border:1px solid #ccc" />
          <script>
            window.onload = function() {
              window.print();
              window.onafterprint = () => window.close();
            };
          <\/script>
        </body></html>
      `);
      newWin.document.close();
    }

    const createForm = document.getElementById('createForm');
    const createResultMessage = document.getElementById('createResultMessage');
    const createQrCodeImage = document.getElementById('createQrCodeImage');
    const createPrintButton = document.getElementById('createPrintButton');

    createForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const prenom = document.getElementById('prenom').value.trim();
      const nom = document.getElementById('nom').value.trim();

      // Simulate success
      const { qrImageUrl, ipp } = generateQrData(prenom, nom);

      // Fill #createResult with data
      createResultMessage.textContent =
        `Patient créé: ${prenom} ${nom} (IPP: ${ipp})`;
      createQrCodeImage.src = qrImageUrl;
      createQrCodeImage.alt = `QR pour ${prenom} ${nom}`;

      // ENABLE the print button, attach function
      createPrintButton.disabled = false;
      createPrintButton.onclick = () => printQRCode(qrImageUrl);
    });
  </script>
</body>
</html>
