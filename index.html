<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Dashboard de réception pour la gestion des patients - MediClinic">
  <title>Réception - MediClinic</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <a href="#main-content" class="skip-link">Passer au contenu principal</a>
  <div class="container">
    <header class="header no-print">
      <div class="header-main-content">
        <div class="logo">
          <img src="./clinique-nakhil-logo-horizontal.webp" alt="MediClinic Logo" class="logo-img"> 
        </div>
        <h1 class="header-title">Réception</h1>
      </div>
      <div class="header-logout">
        <button onclick="window.logout()" class="btn btn-outline logout-btn" aria-label="Déconnexion">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion
        </button>
      </div>
    </header>

    <main id="main-content" class="flex-row">
      <!-- Create Patient Card -->
      <section class="card" aria-labelledby="create-patient-heading">
        <header class="card-header no-print">
          <h2 id="create-patient-heading" class="card-title">
            <i class="fas fa-user-plus" aria-hidden="true"></i> Créer un Patient
          </h2>
        </header>
        <div class="card-body">
          <!-- ID Capture Section -->
          <div class="id-capture-section mb-4 no-print">
            <button id="captureIdButton" type="button" class="btn btn-primary">
              <i class="fas fa-camera"></i> Scanner CIN
            </button>
            <div id="idCaptureContainer" style="display:none;">
              <p id="captureInstruction">Positionnez le RECTO de la CIN et prenez la photo.</p>
              <video id="idVideo" playsinline></video>
              <canvas id="idCanvas" style="display:none;"></canvas>
              <div class="d-flex justify-content-center gap-2 my-2">
                <img id="frontPreview" class="capture-preview" alt="Aperçu Recto" style="display: none;">
                <img id="backPreview" class="capture-preview" alt="Aperçu Verso" style="display: none;">
              </div>
              <div class="d-flex justify-content-center gap-2 mt-2">
                <button id="takePhotoButton" type="button" class="btn btn-success" disabled>
                  <i class="fas fa-camera-retro"></i> Prendre Photo
                </button>
                <button id="cancelCaptureButton" type="button" class="btn btn-secondary" disabled>
                  Annuler
                </button>
              </div>
              <div id="captureMessage" class="message mt-2" style="display: none;" role="alert"></div>
            </div>
          </div>
          <!-- Patient Creation Form -->
          <form id="createForm" class="no-print" novalidate>
            <div class="form-grid">
              <div class="input-group">
                <label for="nom">Nom <span class="req-star" aria-hidden="true">*</span></label>
                <input id="nom" name="nom" type="text" placeholder="Nom de famille" required autocomplete="family-name">
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="prenom">Prénom <span class="req-star" aria-hidden="true">*</span></label>
                <input id="prenom" name="prenom" type="text" placeholder="Prénom" required autocomplete="given-name">
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="cin">CIN <span class="req-star" aria-hidden="true">*</span></label>
                <input id="cin" name="cin" type="text" placeholder="Ex: AB123456" required pattern="^[A-Za-z]{1,2}\d{5,6}$" autocomplete="off">
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="telephone">Téléphone <span class="req-star" aria-hidden="true">*</span></label>
                <input id="telephone" name="telephone" type="tel" placeholder="Ex: 0612345678" required autocomplete="tel" pattern="^0[5-7]\d{8}$">
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="adresse">Adresse <span class="req-star" aria-hidden="true">*</span></label>
                <textarea id="adresse" name="adresse" class="professional" placeholder="Rue, Code postal, Ville, Pays" required autocomplete="address-line1"></textarea>
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="ville">Ville <span class="req-star" aria-hidden="true">*</span></label>
                <input id="ville" name="ville" type="text" placeholder="Ville" required autocomplete="address-level2">
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="date_naissance">Date de Naissance <span class="req-star" aria-hidden="true">*</span></label>
                <input id="date_naissance" name="date_naissance" type="date" required autocomplete="bday" max="9999-12-31">
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="sexe">Sexe <span class="req-star" aria-hidden="true">*</span></label>
                <select id="sexe" name="sexe" required autocomplete="sex">
                  <option value="">-- Sélectionnez --</option>
                  <option value="M">Homme</option>
                  <option value="F">Femme</option>
                </select>
                <div class="error-text"></div>
              </div>
              <div class="input-group">
                <label for="medecin_referent">Médecin référent</label>
                <input type="text" list="doctors" id="medecin_referent" name="medecin_referent" placeholder="Rechercher un médecin" autocomplete="off">
                <datalist id="doctors"></datalist>
                <div class="error-text"></div>
              </div>
              <div class="input-group mutuelle-group">
                <div>
                  <input type="checkbox" id="has_insurance" name="has_insurance">
                  <label for="has_insurance" class="checkbox-label">A une mutuelle ?</label>
                </div>
                <div id="mutuelle-input-container">
                  <input type="text" id="mutuelle" name="mutuelle" list="mutuelles" placeholder="Rechercher ou sélectionner une mutuelle" disabled autocomplete="off">
                  <datalist id="mutuelles"></datalist>
                  <div class="error-text"></div>
                </div>
              </div>
              <div class="form-submit-button">
                <button type="submit" class="btn btn-success" id="createPatientBtn">
                  <i class="fas fa-plus-circle" aria-hidden="true"></i> Créer Patient
                </button>
              </div>
              <div id="message" class="message" role="alert" aria-live="polite" style="display: none;"></div>
            </div>
          </form>
          <div id="createResult" style="display: none;">
            <p id="createResultMessage"></p>
            <img id="createQrCodeImage" src="" alt="QR Code Patient" loading="lazy">
            <button id="createPrintButton" class="btn btn-secondary no-print" disabled>
              <i class="fas fa-print" aria-hidden="true"></i> Imprimer QR Code
            </button>
          </div>
        </div>
      </section>

      <!-- Search Patient Card -->
      <section class="card" aria-labelledby="search-patient-heading">
        <header class="card-header no-print">
          <h2 id="search-patient-heading" class="card-title">
            <i class="fas fa-search" aria-hidden="true"></i> Rechercher un Patient
          </h2>
        </header>
        <div class="card-body">
          <div class="search-bar no-print">
            <input id="getCin" type="text" placeholder="Entrer le CIN du patient" aria-label="Numéro CIN du patient" class="input-group">
            <button id="searchBtn" class="btn btn-primary">
              <i class="fas fa-search" aria-hidden="true"></i> Rechercher
            </button>
          </div>
          <div id="getResult" role="region" aria-live="polite"></div>
        </div>
      </section>
    </main>

    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
  </div>

  <script>
  (function() {
    'use strict';

    // Configuration and endpoints
    const CONFIG = {
      API_BASE_URL: 'https://workflows.aphelionxinnovations.com',
      LOGIN_PAGE_URL: 'https://hicham-taoufik.github.io/login/',
      QR_TARGET_BASE_URL: 'app://medilink/patient',
      TOKEN_KEY: 'authToken',
      SESSION_TIMEOUT: 30 * 60 * 1000,
      TOAST_DISPLAY_TIME: 4000
    };
    const DOCTORS_ENDPOINT   = CONFIG.API_BASE_URL + '/webhook/get-doctors';
    const MUTUELLES_ENDPOINT = CONFIG.API_BASE_URL + '/webhook/get-mutuelles';
    const EXTRACT_ID_ENDPOINT = CONFIG.API_BASE_URL + '/webhook/extract-id-info';
    const CREATE_PATIENT_ENDPOINT = CONFIG.API_BASE_URL + '/webhook/create-patient';
    const GET_PATIENT_ENDPOINT = CONFIG.API_BASE_URL + '/webhook/get-patient';

    let doctorsList = [], mutuellesList = [];
    let sessionTimeoutId = null, idCaptureStream = null;
    let frontImageBlob = null, backImageBlob = null, isCapturingFront = true;

    const DOM = {
      createForm: document.getElementById('createForm'),
      nom: document.getElementById('nom'),
      prenom: document.getElementById('prenom'),
      cin: document.getElementById('cin'),
      telephone: document.getElementById('telephone'),
      adresse: document.getElementById('adresse'),
      ville: document.getElementById('ville'),
      dateNaissance: document.getElementById('date_naissance'),
      sexe: document.getElementById('sexe'),
      hasInsurance: document.getElementById('has_insurance'),
      mutuelle: document.getElementById('mutuelle'),
      medecinReferent: document.getElementById('medecin_referent'),
      doctorsDatalist: document.getElementById('doctors'),
      mutuellesDatalist: document.getElementById('mutuelles'),
      captureIdButton: document.getElementById('captureIdButton'),
      idCaptureContainer: document.getElementById('idCaptureContainer'),
      idVideo: document.getElementById('idVideo'),
      idCanvas: document.getElementById('idCanvas'),
      takePhotoButton: document.getElementById('takePhotoButton'),
      cancelCaptureButton: document.getElementById('cancelCaptureButton'),
      frontPreview: document.getElementById('frontPreview'),
      backPreview: document.getElementById('backPreview'),
      captureInstruction: document.getElementById('captureInstruction'),
      captureMessage: document.getElementById('captureMessage'),
      createPatientBtn: document.getElementById('createPatientBtn'),
      createResult: document.getElementById('createResult'),
      createResultMessage: document.getElementById('createResultMessage'),
      createQrCodeImage: document.getElementById('createQrCodeImage'),
      createPrintButton: document.getElementById('createPrintButton'),
      message: document.getElementById('message'),
      searchBtn: document.getElementById('searchBtn'),
      getCin: document.getElementById('getCin'),
      resultDiv: document.getElementById('getResult'),
      toast: document.getElementById('toast')
    };

    // For testing: if no token is set, add a dummy token so we don't redirect.
    if (!localStorage.getItem(CONFIG.TOKEN_KEY)) {
      console.warn('Aucun token trouvé, utilisation d’un token de test.');
      localStorage.setItem(CONFIG.TOKEN_KEY, 'dummy-token');
    }

    function sanitize(input) {
      const temp = document.createElement('div');
      temp.textContent = input || '';
      return temp.innerHTML;
    }

    function showToast(msg, type = 'info') {
      if (!msg || !DOM.toast) return;
      const icons = { success: '<i class="fas fa-check-circle"></i>', error: '<i class="fas fa-exclamation-triangle"></i>', info: '<i class="fas fa-info-circle"></i>' };
      DOM.toast.innerHTML = `${icons[type] || icons.info} ${sanitize(msg)}`;
      DOM.toast.className = `toast ${type}`;
      if (DOM.toast.timeoutId) clearTimeout(DOM.toast.timeoutId);
      if (DOM.toast.animationFrameId) cancelAnimationFrame(DOM.toast.animationFrameId);
      DOM.toast.animationFrameId = requestAnimationFrame(() => {
        DOM.toast.classList.add('show');
        DOM.toast.timeoutId = setTimeout(() => { DOM.toast.classList.remove('show'); }, CONFIG.TOAST_DISPLAY_TIME);
      });
    }

    function showMessage(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      if (!el) return;
      const icons = { info: 'fas fa-info-circle', success: 'fas fa-check-circle', warning: 'fas fa-exclamation-triangle', error: 'fas fa-times-circle', loading: 'fas fa-spinner fa-spin' };
      const iconHtml = message && type !== 'result' && icons[type] ? `<i class="${icons[type]} me-2" aria-hidden="true"></i>` : '';
      el.innerHTML = message ? `${iconHtml}${sanitize(message)}` : '';
      el.style.display = message ? 'flex' : 'none';
      el.className = type === 'result' ? '' : `message message-${type}`;
      if (elementId === 'captureMessage' && el.parentElement) {
          el.parentElement.style.display = message ? 'block' : 'none';
          if (message) el.style.display = 'flex';
      }
    }

    async function fetchWithAuth(url, opts = {}) {
      const token = localStorage.getItem(CONFIG.TOKEN_KEY);
      if (!token) {
        alert('Session expirée. Redirection vers la page de connexion.');
        window.location.href = CONFIG.LOGIN_PAGE_URL;
        throw new Error('No auth token found.');
      }
      resetSessionTimeout();
      opts.headers = { ...opts.headers, 'Authorization': `Bearer ${token}` };
      if (opts.body && !(opts.body instanceof FormData) && !opts.headers['Content-Type'] && typeof opts.body === 'string') {
         opts.headers['Content-Type'] = 'application/json';
      }
      try {
        const response = await fetch(url, opts);
        if ([401, 403].includes(response.status)) {
          localStorage.removeItem(CONFIG.TOKEN_KEY);
          alert('Session invalide ou expirée.');
          window.location.href = CONFIG.LOGIN_PAGE_URL;
          throw new Error('Authentication failed.');
        }
        if (!response.ok) {
          let errorBody = '';
          try {
            const ct = response.headers.get('content-type');
            errorBody = ct && ct.includes('application/json') ? (await response.json()).message : await response.text();
          } catch (e) {}
          throw new Error(errorBody || `HTTP error ${response.status}`);
        }
        return response;
      } catch (error) {
        if (!['Authentication failed.', 'No auth token found.'].includes(error.message))
          showToast(`Erreur réseau ou serveur: ${error.message}`, 'error');
        throw error;
      }
    }

    function resetSessionTimeout() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      sessionTimeoutId = setTimeout(window.logout, CONFIG.SESSION_TIMEOUT);
    }

    function validateField(input, testFn, errorMessage) {
      if (!input) return true;
      const value = input.value.trim();
      const group = input.closest('.input-group');
      const errorDiv = group ? group.querySelector('.error-text') : null;
      let isValid = input.required ? value !== '' : true;
      let message = input.required && !value ? 'Ce champ est requis.' : errorMessage || 'Valeur invalide.';
      if (isValid && value && testFn) { isValid = testFn(value); }
      if (isValid && input.type === 'date' && value) {
         const inputDate = new Date(value + 'T00:00:00'), today = new Date();
         today.setHours(0, 0, 0, 0);
         if (inputDate > today) { isValid = false; message = 'La date ne peut pas être dans le futur.'; }
      }
      if (group) group.classList.toggle('has-error', !isValid);
      input.classList.toggle('input-error', !isValid);
      if (errorDiv) errorDiv.textContent = isValid ? '' : message;
      return isValid;
    }

    function clearErrors() {
      DOM.createForm.querySelectorAll('.input-group').forEach(group => {
        group.classList.remove('has-error');
        group.querySelectorAll('input, textarea, select').forEach(input => input.classList.remove('input-error'));
        const err = group.querySelector('.error-text');
        if (err) err.textContent = '';
      });
      showMessage('message', '', 'info');
    }

    function validateForm() {
      clearErrors();
      let valid = true;
      valid &= validateField(DOM.nom, v => v.length > 0, 'Nom requis');
      valid &= validateField(DOM.prenom, v => v.length > 0, 'Prénom requis');
      valid &= validateField(DOM.cin, v => /^[A-Za-z]{1,2}\d{5,6}$/.test(v), 'Format CIN invalide (ex: AB123456)');
      valid &= validateField(DOM.telephone, v => /^0[5-7]\d{8}$/.test(v), 'Format téléphone invalide (ex: 0612345678)');
      valid &= validateField(DOM.adresse, v => v.length > 0, 'Adresse requise');
      valid &= validateField(DOM.ville, v => v.length > 0, 'Ville requise');
      valid &= validateField(DOM.dateNaissance, v => v !== '', 'Date de naissance requise');
      valid &= validateField(DOM.sexe, v => v !== '', 'Sélection du sexe requise');
      if (DOM.hasInsurance.checked) {
        valid &= validateField(DOM.mutuelle, v => v !== '', 'Mutuelle requise si cochée');
        valid &= validateField(DOM.mutuelle, v => v && mutuellesList.some(m => m.toLowerCase() === v.toLowerCase()), 'Sélectionnez une mutuelle valide');
      }
      if (DOM.medecinReferent.value.trim() !== '') {
         const doctorChk = v => doctorsList.some(d => `${d.nom} ${d.prenom} - ${d.specialite}`.toLowerCase() === v.toLowerCase());
         valid &= validateField(DOM.medecinReferent, doctorChk, 'Médecin référent invalide');
      }
      if (!valid) {
        showToast('Veuillez corriger les erreurs dans le formulaire.', 'error');
        const firstErr = DOM.createForm.querySelector('.has-error input, .has-error select, .has-error textarea');
        if (firstErr) firstErr.focus();
      }
      return valid;
    }

    function resetForm() {
      DOM.createForm.reset();
      clearErrors();
      handleMutuelleChange();
      DOM.createResult.style.display = 'none';
      DOM.createResultMessage.textContent = '';
      DOM.createQrCodeImage.src = '';
      DOM.createQrCodeImage.alt = '';
      DOM.createPrintButton.disabled = true;
      DOM.createPrintButton.onclick = null;
      showMessage('message','', 'info');
    }

    function handleMutuelleChange() {
      const enabled = DOM.hasInsurance.checked;
      DOM.mutuelle.disabled = !enabled;
      DOM.mutuelle.required = enabled;
      if (!enabled) {
          DOM.mutuelle.value = '';
          validateField(DOM.mutuelle, () => true);
      } else {
          validateField(DOM.mutuelle, v => v !== '', 'Mutuelle requise si cochée');
      }
    }

    async function fetchAndPopulate(endpoint, key) {
      try {
        const res = await fetchWithAuth(endpoint);
        const txt = await res.text();
        if (!txt) { return []; }
        const data = JSON.parse(txt);
        return data.success && Array.isArray(data[key]) ? data[key] : [];
      } catch (e) {
        showToast(`Erreur lors du chargement de ${key}.`, 'error');
        return [];
      }
    }

    async function populateDataLists() {
      doctorsList = await fetchAndPopulate(DOCTORS_ENDPOINT, 'doctors');
      if (doctorsList.length) {
        DOM.doctorsDatalist.innerHTML = '';
        doctorsList.forEach(d => {
          const opt = document.createElement('option');
          opt.value = `${d.nom} ${d.prenom} - ${d.specialite}`;
          DOM.doctorsDatalist.appendChild(opt);
        });
      }
      mutuellesList = await fetchAndPopulate(MUTUELLES_ENDPOINT, 'mutuelles');
      if (mutuellesList.length) {
        DOM.mutuellesDatalist.innerHTML = '';
        mutuellesList.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          DOM.mutuellesDatalist.appendChild(opt);
        });
      }
    }

    function generateQrData(ipp) {
      const encoded = encodeURIComponent(ipp);
      const target = `${CONFIG.QR_TARGET_BASE_URL}?ipp=${encoded}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(target)}`;
      return { qrImageUrl: qrUrl, targetUrl: target };
    }

    window.printQRCode = function(imgUrl) {
      if (!imgUrl) return;
      const pw = window.open('', '_blank', 'width=400,height=450,resizable=yes,scrollbars=yes');
      if (!pw) { showToast('Veuillez autoriser les pop-ups pour imprimer.', 'warning'); return; }
      const sImgUrl = sanitize(imgUrl);
      pw.document.write(`
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <title>Imprimer QR Code</title>
          <style>
            body { margin: 20px; text-align: center; font-family: sans-serif; }
            img { max-width: 90%; height: auto; border: 1px solid #ccc; }
            @media print { body { margin: 10px; } button { display: none; } }
          </style>
        </head>
        <body>
          <img src="${sImgUrl}" alt="QR Code Patient">
          <p><button onclick="window.print(); this.style.display='none';">Imprimer</button></p>
          <script>
            window.onload = function() { setTimeout(window.print, 250); };
          <\/script>
        </body>
        </html>
      `);
      pw.document.close();
    };

    async function startIdCapture() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showMessage('captureMessage', 'La fonctionnalité caméra n’est pas supportée.', 'error');
        return;
      }
      showMessage('captureMessage', 'Demande d’accès caméra...', 'loading');
      DOM.captureIdButton.disabled = true;
      DOM.idCaptureContainer.style.display = 'block';
      DOM.frontPreview.style.display = DOM.backPreview.style.display = 'none';
      if (DOM.frontPreview.src) URL.revokeObjectURL(DOM.frontPreview.src);
      if (DOM.backPreview.src) URL.revokeObjectURL(DOM.backPreview.src);
      frontImageBlob = backImageBlob = null;
      isCapturingFront = true;
      DOM.captureInstruction.textContent = 'Positionnez le RECTO de la CIN dans le cadre et prenez la photo.';
      try {
        idCaptureStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        DOM.idVideo.srcObject = idCaptureStream;
        DOM.idVideo.onloadedmetadata = () => {
          DOM.idVideo.play().then(() => {
            showMessage('captureMessage', 'Caméra prête. Prenez la photo du RECTO.', 'info');
            DOM.takePhotoButton.disabled = false;
            DOM.cancelCaptureButton.disabled = false;
          }).catch(() => {
            showMessage('captureMessage', 'Erreur lecture vidéo.', 'error');
            stopIdCapture(true);
          });
        };
      } catch (err) {
        const msg = err.name === "NotAllowedError" ? "Permission caméra refusée." :
                    err.name === "NotFoundError" ? "Aucune caméra trouvée." :
                    "Erreur caméra.";
        showMessage('captureMessage', msg, 'error');
        stopIdCapture(true);
      }
    }

    function stopIdCapture(clear = true) {
      if (idCaptureStream) {
        idCaptureStream.getTracks().forEach(t => t.stop());
        idCaptureStream = null;
      }
      DOM.idVideo.srcObject = null;
      DOM.idCaptureContainer.style.display = 'none';
      DOM.takePhotoButton.disabled = true;
      DOM.cancelCaptureButton.disabled = true;
      DOM.captureIdButton.disabled = false;
      showMessage('captureMessage', '', 'info');
      if (clear) {
        frontImageBlob = backImageBlob = null;
        if (DOM.frontPreview.src) URL.revokeObjectURL(DOM.frontPreview.src);
        if (DOM.backPreview.src) URL.revokeObjectURL(DOM.backPreview.src);
        DOM.frontPreview.src = DOM.backPreview.src = '';
        DOM.frontPreview.style.display = DOM.backPreview.style.display = 'none';
      }
    }

    async function takePhotoAndExtract() {
      if (!idCaptureStream || DOM.idVideo.readyState < DOM.idVideo.HAVE_METADATA) {
        showMessage('captureMessage', 'Caméra non prête.', 'warning');
        return;
      }
      showMessage('captureMessage', 'Capture de l’image...', 'loading');
      DOM.takePhotoButton.disabled = true;
      DOM.cancelCaptureButton.disabled = true;
      const canvas = DOM.idCanvas;
      canvas.width = DOM.idVideo.videoWidth;
      canvas.height = DOM.idVideo.videoHeight;
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        showMessage('captureMessage', 'Impossible d’obtenir le contexte Canvas.', 'error');
        stopIdCapture(true);
        return;
      }
      ctx.drawImage(DOM.idVideo, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(async (blob) => {
        if (!blob) {
          showMessage('captureMessage', 'Erreur lors de la création de l’image.', 'error');
          stopIdCapture(true);
          return;
        }
        if (isCapturingFront) {
          if (DOM.frontPreview.src) URL.revokeObjectURL(DOM.frontPreview.src);
          frontImageBlob = blob;
          DOM.frontPreview.src = URL.createObjectURL(blob);
          DOM.frontPreview.alt = "Aperçu Recto CIN";
          DOM.frontPreview.style.display = 'inline-block';
          isCapturingFront = false;
          DOM.captureInstruction.textContent = 'Positionnez le VERSO de la CIN et prenez la photo.';
          showMessage('captureMessage', 'Image RECTO capturée. Préparez le VERSO.', 'info');
          DOM.takePhotoButton.disabled = false;
          DOM.cancelCaptureButton.disabled = false;
        } else {
          if (DOM.backPreview.src) URL.revokeObjectURL(DOM.backPreview.src);
          backImageBlob = blob;
          DOM.backPreview.src = URL.createObjectURL(blob);
          DOM.backPreview.alt = "Aperçu Verso CIN";
          DOM.backPreview.style.display = 'inline-block';
          stopIdCapture(false);
          showMessage('captureMessage', 'Images capturées. Analyse OCR en cours...', 'loading');
          if (frontImageBlob && backImageBlob) {
            const formData = new FormData();
            formData.append('id_image_front', frontImageBlob, 'cin_recto.jpg');
            formData.append('id_image_back', backImageBlob, 'cin_verso.jpg');
            try {
              const res = await fetchWithAuth(EXTRACT_ID_ENDPOINT, { method: 'POST', body: formData });
              const data = await res.json();
              if (data && data.data) {
                autofillCreateForm(data.data);
                showToast('Informations CIN extraites!', 'success');
                showMessage('captureMessage', 'Extraction réussie. Vérifiez le formulaire.', 'success');
              } else {
                throw new Error(data.message || 'Aucune donnée extraite.');
              }
            } catch (e) {
              showMessage('captureMessage', `Erreur extraction: ${e.message}`, 'error');
            } finally {
              frontImageBlob = backImageBlob = null;
              DOM.captureIdButton.disabled = false;
            }
          } else {
            showMessage('captureMessage', 'Erreur: Image manquante pour l\'extraction.', 'error');
            stopIdCapture(true);
          }
        }
      }, 'image/jpeg', 0.9);
    }

    function autofillCreateForm(data) {
      resetForm();
      DOM.nom.value = data.last_name || '';
      DOM.prenom.value = data.first_name || '';
      DOM.cin.value = data.id_number || '';
      DOM.adresse.value = data.address || '';
      DOM.ville.value = data.city || '';
      DOM.sexe.value = (data.gender === 'F' || String(data.gender).toUpperCase() === 'FEMALE') ? 'F'
                     : (data.gender === 'M' || String(data.gender).toUpperCase() === 'MALE') ? 'M' : '';
      if (data.date_of_birth) {
        let isoDate = '';
        let parts = String(data.date_of_birth).match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
        if (parts) { isoDate = `${parts[3]}-${parts[2].padStart(2,'0')}-${parts[1].padStart(2,'0')}`; }
        else {
          parts = String(data.date_of_birth).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
          if (parts) { isoDate = `${parts[1]}-${parts[2].padStart(2,'0')}-${parts[3].padStart(2,'0')}`; }
        }
        DOM.dateNaissance.value = isoDate && !isNaN(new Date(isoDate + 'T00:00:00')) ? isoDate : '';
      } else {
        DOM.dateNaissance.value = '';
      }
      DOM.telephone.value = data.phone_number || '';
      showMessage('message', 'Formulaire pré-rempli depuis la CIN. Veuillez vérifier les informations.', 'success');
    }

    async function handlePatientSearch() {
      const cinValue = DOM.getCin.value.trim();
      if (!cinValue) {
        showToast('Veuillez entrer un CIN pour la recherche.', 'warning');
        DOM.resultDiv.innerHTML = '<p class="message message-warning">Veuillez entrer un CIN.</p>';
        return;
      }
      if (!/^[A-Za-z]{1,2}\d{5,6}$/.test(cinValue)) {
        showToast('Format CIN invalide pour la recherche.', 'error');
        DOM.resultDiv.innerHTML = '<p class="message message-error">Format CIN invalide (ex: AB123456).</p>';
        return;
      }
      showToast('Recherche du patient...', 'info');
      DOM.resultDiv.innerHTML = '<p class="message message-loading"><i class="fas fa-spinner fa-spin me-2"></i>Recherche en cours...</p>';
      DOM.searchBtn.disabled = true;
      DOM.getCin.disabled = true;
      try {
        const searchUrl = `${GET_PATIENT_ENDPOINT}?cin=${encodeURIComponent(cinValue)}`;
        const res = await fetchWithAuth(searchUrl);
        const data = await res.json();
        if (data && data.data && data.data.ipp) {
          const p = data.data;
          let formattedDob = 'N/A';
          if (p.date_naissance) {
            const d = new Date(p.date_naissance + 'T00:00:00Z');
            if (!isNaN(d)) formattedDob = d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' });
          }
          const { qrImageUrl } = generateQrData(p.ipp);
          DOM.resultDiv.innerHTML = `
            <div class="patient-result-container">
              <div class="patient-result-info">
                <div><strong>Nom:</strong> ${sanitize(p.nom)}</div>
                <div><strong>Prénom:</strong> ${sanitize(p.prenom)}</div>
                <div><strong>IPP:</strong> ${sanitize(p.ipp)}</div>
                <div><strong>CIN:</strong> ${sanitize(p.cin || 'N/A')}</div>
                <div><strong>Téléphone:</strong> ${sanitize(p.telephone || 'N/A')}</div>
                <div><strong>Adresse:</strong> ${sanitize(p.adresse || 'N/A')}</div>
                <div><strong>Ville:</strong> ${sanitize(p.ville || 'N/A')}</div>
                <div><strong>Naissance:</strong> ${formattedDob}</div>
                <div><strong>Sexe:</strong> ${p.sexe === 'M' ? 'Homme' : (p.sexe === 'F' ? 'Femme' : 'N/A')}</div>
                <div><strong>Mutuelle:</strong> ${sanitize(p.mutuelle || 'Aucune')}</div>
                <div><strong>Médecin Réf.:</strong> ${sanitize(p.medecin_referent_nom || 'N/A')}</div>
              </div>
              <div class="patient-result-qr">
                <img src="${sanitize(qrImageUrl)}" alt="QR Code pour ${sanitize(p.nom)} ${sanitize(p.prenom)}">
                <button onclick="window.printQRCode('${sanitize(qrImageUrl)}')" class="btn btn-secondary btn-sm no-print">
                  <i class="fas fa-print"></i> Imprimer QR
                </button>
              </div>
            </div>`;
          showToast('Patient trouvé.', 'success');
        } else {
          DOM.resultDiv.innerHTML = '<p class="message message-info">Aucun patient trouvé avec ce CIN.</p>';
          showToast('Patient non trouvé.', 'info');
        }
      } catch (e) {
        DOM.resultDiv.innerHTML = `<p class="message message-error">Erreur lors de la recherche: ${sanitize(e.message)}</p>`;
      } finally {
        DOM.searchBtn.disabled = false;
        DOM.getCin.disabled = false;
      }
    }

    async function handleCreatePatient(e) {
      e.preventDefault();
      showMessage('message', '', 'info');
      if (!validateForm()) return;
      showToast('Création du patient en cours...', 'info');
      showMessage('message', 'Envoi des données au serveur...', 'loading');
      DOM.createPatientBtn.disabled = true;
      const medRef = DOM.medecinReferent.value.trim();
      let doctorId = '';
      if (medRef) {
        const doc = doctorsList.find(d => `${d.nom} ${d.prenom} - ${d.specialite}`.toLowerCase() === medRef.toLowerCase());
        if (doc) doctorId = doc.matricule;
      }
      const mutuelleVal = DOM.hasInsurance.checked ? DOM.mutuelle.value.trim() : null;
      const payload = {
        nom: DOM.nom.value.trim(),
        prenom: DOM.prenom.value.trim(),
        cin: DOM.cin.value.trim().toUpperCase(),
        telephone: DOM.telephone.value.trim(),
        adresse: DOM.adresse.value.trim(),
        ville: DOM.ville.value.trim(),
        date_naissance: DOM.dateNaissance.value,
        sexe: DOM.sexe.value,
        mutuelle: mutuelleVal,
        medecin_referent: doctorId
      };
      try {
        const res = await fetchWithAuth(CREATE_PATIENT_ENDPOINT, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data && data.data && data.data.ipp) {
          const patientIpp = data.data.ipp;
          const { qrImageUrl } = generateQrData(patientIpp);
          DOM.createResultMessage.textContent = `Patient créé avec succès! IPP: ${sanitize(patientIpp)}`;
          DOM.createQrCodeImage.src = sanitize(qrImageUrl);
          DOM.createQrCodeImage.alt = `QR Code pour ${sanitize(payload.nom)} ${sanitize(payload.prenom)}`;
          DOM.createPrintButton.disabled = false;
          DOM.createPrintButton.onclick = () => window.printQRCode(qrImageUrl);
          DOM.createResult.style.display = 'block';
          showMessage('message', `Patient ${sanitize(payload.nom)} ${sanitize(payload.prenom)} créé (IPP: ${patientIpp}).`, 'success');
          showToast('Patient créé avec succès!', 'success');
          resetForm();
        } else {
          throw new Error(data.message || 'Réponse inattendue du serveur.');
        }
      } catch (e) {
        showMessage('message', `Erreur lors de la création: ${sanitize(e.message)}`, 'error');
      } finally {
        DOM.createPatientBtn.disabled = false;
      }
    }

    window.logout = function() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      localStorage.removeItem(CONFIG.TOKEN_KEY);
      showToast('Déconnexion en cours...', 'info');
      setTimeout(() => { window.location.href = CONFIG.LOGIN_PAGE_URL; }, 500);
    };

    function initializeApp() {
      // Instead of redirecting immediately if no token is present,
      // we now use our dummy token (see above) for testing.
      resetSessionTimeout();
      populateDataLists();
      handleMutuelleChange();
      DOM.hasInsurance.addEventListener('change', handleMutuelleChange);
      DOM.createForm.addEventListener('submit', handleCreatePatient);
      DOM.searchBtn.addEventListener('click', handlePatientSearch);
      DOM.getCin.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handlePatientSearch(); }});
      DOM.captureIdButton.addEventListener('click', startIdCapture);
      DOM.takePhotoButton.addEventListener('click', takePhotoAndExtract);
      DOM.cancelCaptureButton.addEventListener('click', () => stopIdCapture(true));
      ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(eventType => {
        document.addEventListener(eventType, resetSessionTimeout, { passive: true });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  })();
  </script>
</body>
</html>
