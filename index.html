<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Dashboard de réception pour la gestion des patients - MediClinic">
  <title>Réception - MediClinic</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Make the address textarea look more spacious and professional */
    textarea.professional {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      min-height: 100px;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Passer au contenu principal</a>
  <div class="container">
    <header class="header">
      <div class="header-main-content">
        <div class="logo">
          <img src="./clinique-nakhil-logo-horizontal.webp" alt="MediClinic Logo" class="logo-img">
        </div>
        <h1 class="header-title">Réception</h1>
      </div>
      <div class="header-logout">
        <button onclick="logout()" class="btn btn-outline logout-btn no-print" aria-label="Déconnexion">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion
        </button>
      </div>
    </header>

    <main id="main-content" class="flex-row">
      <section class="card" aria-labelledby="create-patient-heading">
        <header class="card-header">
          <h2 id="create-patient-heading" class="card-title">
            <i class="fas fa-user-plus" aria-hidden="true"></i> Créer un Patient
          </h2>
          <div class="card-actions" aria-hidden="true"><i class="fas fa-pen"></i></div>
        </header>
        <div class="card-body">
          <!-- ID Capture Section -->
          <div class="id-capture-section mb-4 no-print">
            <button id="captureIdButton" type="button" class="btn btn-primary">
              <i class="fas fa-camera"></i> Scanner CIN
            </button>
            <div id="idCaptureContainer" style="display:none;">
              <p id="captureInstruction">Positionnez le RECTO de la CIN et prenez la photo.</p>
              <video id="idVideo" playsinline></video>
              <canvas id="idCanvas" style="display:none;"></canvas>
              <div class="d-flex justify-content-center gap-2 my-2">
                <img id="frontPreview" class="capture-preview" alt="Aperçu Recto" style="display: none;">
                <img id="backPreview" class="capture-preview" alt="Aperçu Verso" style="display: none;">
              </div>
              <div class="btn-group mt-2">
                <button id="takePhotoButton" type="button" class="btn btn-success" disabled>
                  <i class="fas fa-camera-retro"></i> Prendre Photo
                </button>
                <button id="cancelCaptureButton" type="button" class="btn btn-secondary" disabled>
                  Annuler
                </button>
              </div>
              <div id="captureMessage" class="message message-info mt-2"></div>
            </div>
          </div>
          <!-- End ID Capture Section -->

          <form id="createForm" novalidate>
            <div class="form-grid">
              <div class="input-group">
                <label for="nom">Nom <span aria-hidden="true">*</span></label>
                <input id="nom" name="nom" type="text" placeholder="Nom de famille" required autocomplete="family-name">
                <div class="error-text">Veuillez entrer un nom</div>
              </div>
              <div class="input-group">
                <label for="prenom">Prénom <span aria-hidden="true">*</span></label>
                <input id="prenom" name="prenom" type="text" placeholder="Prénom" required autocomplete="given-name">
                <div class="error-text">Veuillez entrer un prénom</div>
              </div>
              <div class="input-group">
                <label for="cin">CIN <span aria-hidden="true">*</span></label>
                <input id="cin" name="cin" type="text" placeholder="Ex: AB123456" required pattern="^[A-Za-z]{1,2}\d{5,6}$">
                <div class="error-text">Format CIN invalide (ex: AB123456)</div>
              </div>
              <div class="input-group">
                <label for="telephone">Téléphone <span aria-hidden="true">*</span></label>
                <input id="telephone" name="telephone" type="tel" placeholder="Ex: 0612345678" required autocomplete="tel" pattern="^0[5-7]\d{8}$">
                <div class="error-text">Format téléphone invalide (0XXXXXXXX)</div>
              </div>
              <div class="input-group">
                <label for="adresse">Adresse <span aria-hidden="true">*</span></label>
                <textarea
                  id="adresse"
                  name="adresse"
                  class="professional"
                  placeholder="Rue, Code postal, Ville, Pays"
                  required
                  autocomplete="address-line1"
                ></textarea>
                <div class="error-text">Veuillez entrer une adresse complète</div>
              </div>
              <div class="input-group">
                <label for="ville">Ville <span aria-hidden="true">*</span></label>
                <input id="ville" name="ville" type="text" placeholder="Ville" required autocomplete="address-level2">
                <div class="error-text">Veuillez entrer une ville</div>
              </div>
              <div class="input-group">
                <label for="date_naissance">Date de Naissance <span aria-hidden="true">*</span></label>
                <input id="date_naissance" name="date_naissance" type="date" required autocomplete="bday">
                <div class="error-text">Veuillez entrer une date valide</div>
              </div>
              <div class="input-group">
                <label for="sexe">Sexe <span aria-hidden="true">*</span></label>
                <select id="sexe" name="sexe" required autocomplete="sex">
                  <option value="">-- Sélectionnez --</option>
                  <option value="M">Homme</option>
                  <option value="F">Femme</option>
                </select>
                <div class="error-text">Veuillez sélectionner un sexe</div>
              </div>

              <!-- Mutuelle checkbox + searchable field -->
              <div class="input-group mutuelle-group">
                <div>
                  <input type="checkbox" id="has_insurance" name="has_insurance">
                  <label for="has_insurance" class="checkbox-label">A une mutuelle ?</label>
                </div>
                <div id="mutuelle-input-container">
                  <input
                    type="text"
                    id="mutuelle"
                    name="mutuelle"
                    list="mutuelles"
                    placeholder="Rechercher une mutuelle"
                    disabled
                    autocomplete="off"
                  >
                  <datalist id="mutuelles"></datalist>
                  <div class="error-text">Veuillez sélectionner une mutuelle valide</div>
                </div>
              </div>

              <!-- Médecin référent searchable field -->
              <div class="input-group">
                <label for="medecin_referent">Médecin référent</label>
                <input
                  type="text"
                  list="doctors"
                  id="medecin_referent"
                  name="medecin_referent"
                  placeholder="Rechercher un médecin"
                  autocomplete="off"
                >
                <datalist id="doctors"></datalist>
                <div class="error-text">Veuillez sélectionner un médecin</div>
              </div>

              <div class="form-submit-button">
                <button type="submit" class="btn btn-success" id="createPatientBtn">
                  <i class="fas fa-plus-circle" aria-hidden="true"></i> Créer Patient
                </button>
              </div>
              <div id="message" class="message" role="alert" aria-live="polite"></div>
            </div>
          </form>

          <div id="createResult">
            <p id="createResultMessage"></p>
            <img id="createQrCodeImage" src="" alt="" loading="lazy">
            <button id="createPrintButton" class="btn btn-secondary" disabled>
              <i class="fas fa-print" aria-hidden="true"></i> Imprimer QR Code
            </button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="search-patient-heading">
        <header class="card-header">
          <h2 id="search-patient-heading" class="card-title">
            <i class="fas fa-search" aria-hidden="true"></i> Rechercher un Patient
          </h2>
          <div class="card-actions" aria-hidden="true"><i class="fas fa-users"></i></div>
        </header>
        <div class="card-body">
          <div class="search-bar">
            <input id="getCin" type="text" placeholder="Entrer le CIN du patient" aria-label="Numéro CIN du patient">
            <button id="searchBtn" class="btn btn-primary">
              <i class="fas fa-search" aria-hidden="true"></i> Rechercher
            </button>
          </div>
          <div id="getResult" role="region" aria-live="polite"></div>
        </div>
      </section>
    </main>

    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
  </div>

  <script>
  (function() {
    // Configuration
    const CONFIG = {
      API_BASE_URL: 'https://workflows.aphelionxinnovations.com',
      QR_TARGET_BASE_URL: 'app://medilink/patient',
      LOGIN_PAGE_URL: 'https://hicham-taoufik.github.io/login/',
      TOKEN_KEY: 'authToken',
      SESSION_TIMEOUT: 30 * 60 * 1000,
      MESSAGE_DISPLAY_TIME: 7000,
      TOAST_DISPLAY_TIME: 4000
    };
    const DOCTORS_ENDPOINT   = CONFIG.API_BASE_URL + '/webhook/get-doctors';
    const MUTUELLES_ENDPOINT = CONFIG.API_BASE_URL + '/webhook/get-mutuelles';

    // State
    let doctorsList   = [];
    let mutuellesList = [];
    let sessionTimeoutId = null;
    let idCaptureStream  = null;
    let frontImageBlob   = null;
    let backImageBlob    = null;
    let isCapturingFront = true;

    // DOM refs
    const DOM = {
      body: document.body,
      createForm: document.getElementById('createForm'),
      nom: document.getElementById('nom'),
      prenom: document.getElementById('prenom'),
      cin: document.getElementById('cin'),
      telephone: document.getElementById('telephone'),
      adresse: document.getElementById('adresse'),
      ville: document.getElementById('ville'),
      dateNaissance: document.getElementById('date_naissance'),
      sexe: document.getElementById('sexe'),
      hasInsurance: document.getElementById('has_insurance'),
      mutuelle: document.getElementById('mutuelle'),
      medecinReferent: document.getElementById('medecin_referent'),
      captureIdButton: document.getElementById('captureIdButton'),
      idCaptureContainer: document.getElementById('idCaptureContainer'),
      idVideo: document.getElementById('idVideo'),
      idCanvas: document.getElementById('idCanvas'),
      takePhotoButton: document.getElementById('takePhotoButton'),
      cancelCaptureButton: document.getElementById('cancelCaptureButton'),
      frontPreview: document.getElementById('frontPreview'),
      backPreview: document.getElementById('backPreview'),
      captureInstruction: document.getElementById('captureInstruction'),
      captureMessage: document.getElementById('captureMessage'),
      createPatientBtn: document.getElementById('createPatientBtn'),
      createResult: document.getElementById('createResult'),
      createQrCodeImage: document.getElementById('createQrCodeImage'),
      createPrintButton: document.getElementById('createPrintButton'),
      message: document.getElementById('message'),
      searchBtn: document.getElementById('searchBtn'),
      getCin: document.getElementById('getCin'),
      resultDiv: document.getElementById('getResult'),
      toast: document.getElementById('toast')
    };

    // Utility: show toast
    function showToast(msg, type='success') {
      if (!msg) return;
      const icons = {
        success: '<i class="fas fa-check-circle"></i>',
        error:   '<i class="fas fa-exclamation-circle"></i>'
      };
      DOM.toast.innerHTML = `${icons[type]} ${msg}`;
      DOM.toast.className = `toast ${type} show`;
      setTimeout(()=>DOM.toast.classList.remove('show'), CONFIG.TOAST_DISPLAY_TIME);
    }

    // Utility: showMessage for arbitrary element
    function showMessage(id, message, type) {
      const el = document.getElementById(id);
      if (!el) return;
      const icons = {
        info:    'fas fa-info-circle',
        success: 'fas fa-check-circle',
        warning: 'fas fa-exclamation-triangle',
        error:   'fas fa-times-circle',
        loading: 'fas fa-spinner fa-spin'
      };
      const icon = message && type!=='result'
        ? `<i class="${icons[type]||icons.info} me-2" aria-hidden="true"></i>`
        : '';
      el.innerHTML = message ? `${icon}${message}` : '';
      el.style.display = message ? 'block' : 'none';
      el.className = type==='result' ? '' : `message message-${type}`;
    }

    // Sanitize
    function sanitize(input) {
      const tmp = document.createElement('div');
      tmp.textContent = input || '';
      return tmp.innerHTML;
    }

    // fetchWithAuth
    function fetchWithAuth(url, opts={}) {
      const token = localStorage.getItem(CONFIG.TOKEN_KEY);
      if (!token) {
        alert('Session expirée');
        window.location = CONFIG.LOGIN_PAGE_URL;
        return Promise.reject(new Error('No token'));
      }
      resetSessionTimeout();
      opts.headers = {...opts.headers, 'Authorization': `Bearer ${token}`};
      if (opts.body && !(opts.body instanceof FormData)) {
        opts.headers['Content-Type'] = 'application/json';
      }
      return fetch(url, opts).then(r=>{
        if ([401,403].includes(r.status)) {
          localStorage.removeItem(CONFIG.TOKEN_KEY);
          alert('Session invalide');
          window.location = CONFIG.LOGIN_PAGE_URL;
          throw new Error('Auth failed');
        }
        if (!r.ok) {
          return r.text().then(t=>{
            throw new Error(t||r.statusText);
          });
        }
        return r;
      });
    }

    // resetSessionTimeout
    function resetSessionTimeout() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      sessionTimeoutId = setTimeout(logout, CONFIG.SESSION_TIMEOUT);
    }

    // Validation
    function validateField(input, test, msg) {
      const v = input.value.trim();
      const grp = input.closest('.input-group');
      const ok = test(v);
      grp.classList.toggle('has-error', !ok);
      input.classList.toggle('input-error', !ok);
      const err = grp.querySelector('.error-text');
      if (err) err.textContent = ok ? '' : msg;
      return ok;
    }

    function clearErrors() {
      DOM.createForm.querySelectorAll('.input-group').forEach(g=>{
        g.classList.remove('has-error');
        g.querySelectorAll('input,textarea,select').forEach(i=>i.classList.remove('input-error'));
        const err = g.querySelector('.error-text');
        if (err) err.textContent = '';
      });
    }

    function validateForm() {
      clearErrors();
      let ok = true;
      ok &= validateField(DOM.nom,           v=>v.length,                   'Nom requis');
      ok &= validateField(DOM.prenom,        v=>v.length,                   'Prénom requis');
      ok &= validateField(DOM.cin,           v=>/^[A-Za-z]{1,2}\d{5,6}$/.test(v), 'Format CIN invalide');
      ok &= validateField(DOM.telephone,     v=>/^0[5-7]\d{8}$/.test(v),     'Format téléphone invalide');
      ok &= validateField(DOM.adresse,       v=>v.length,                   'Adresse requise');
      ok &= validateField(DOM.ville,         v=>v.length,                   'Ville requise');
      ok &= validateField(DOM.dateNaissance, v=>v,                          'Date de naissance requise');
      ok &= validateField(DOM.sexe,          v=>v,                          'Sélection du sexe requise');
      if (DOM.hasInsurance.checked) {
        ok &= validateField(DOM.mutuelle, v=>mutuellesList.includes(v), 'Veuillez sélectionner une mutuelle valide');
      }
      if (!ok) showToast('Veuillez corriger les erreurs','error');
      return !!ok;
    }

    function resetForm() {
      DOM.createForm.reset();
      clearErrors();
      handleMutuelleChange();
    }

// Populate doctors
async function populateMedecinReferent() {
  try {
    const res = await fetchWithAuth(DOCTORS_ENDPOINT);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const text = await res.text();
    if (!text) throw new Error('Empty response body');
    const data = JSON.parse(text);

    if (data.success && Array.isArray(data.doctors)) {
      doctorsList = data.doctors;
      const dl = document.getElementById('doctors');
      dl.innerHTML = '';
      data.doctors.forEach(d => {
        const o = document.createElement('option');
        o.value = `${d.nom} ${d.prenom} - ${d.specialite}`;
        dl.appendChild(o);
      });
    }
  } catch (e) {
    console.error('Error fetching doctors:', e.message);
  }
}

// Populate mutuelles
async function populateMutuelles() {
  try {
    const res = await fetchWithAuth(MUTUELLES_ENDPOINT);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const text = await res.text();
    if (!text) throw new Error('Empty response body');
    const data = JSON.parse(text);

    if (data.success && Array.isArray(data.mutuelles)) {
      mutuellesList = data.mutuelles;
      const dl = document.getElementById('mutuelles');
      dl.innerHTML = '';
      data.mutuelles.forEach(m => {
        const o = document.createElement('option');
        o.value = m;
        dl.appendChild(o);
      });
    }
  } catch (e) {
    console.error('Error fetching mutuelles:', e.message);
  }
}

    // Toggle mutuelle field
    function handleMutuelleChange() {
      const en = DOM.hasInsurance.checked;
      DOM.mutuelle.disabled = !en;
      DOM.mutuelle.required = en;
      if (!en) DOM.mutuelle.value = '';
    }

    // QR Code helpers
    function generateQrData(ipp) {
      const url = `${CONFIG.QR_TARGET_BASE_URL}?ipp=${encodeURIComponent(ipp)}`;
      return { qrImageUrl: `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(url)}` };
    }
    function printQRCode(imgUrl) {
      const w = window.open('','_blank','width=400,height=450');
      w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>QR</title></head><body style="text-align:center"><img src="${imgUrl}" style="width:200px"/><script>window.print();window.onafterprint=()=>window.close();<\/script></body></html>`);
      w.document.close();
    }

    // ID Capture
    async function startIdCapture() {
      if (!navigator.mediaDevices?.getUserMedia) {
        showMessage('captureMessage','Caméra non supportée','error');
        return;
      }
      showMessage('captureMessage','Demande caméra...','loading');
      DOM.captureIdButton.disabled = true;
      DOM.idCaptureContainer.style.display = 'block';
      DOM.frontPreview.style.display = 'none';
      DOM.backPreview.style.display = 'none';
      isCapturingFront = true;
      DOM.captureInstruction.textContent = 'Positionnez le RECTO et prenez la photo.';
      try {
        idCaptureStream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
        });
        DOM.idVideo.srcObject = idCaptureStream;
        await DOM.idVideo.play();
        showMessage('captureMessage','Caméra prête. Prenez la photo du RECTO.','info');
        DOM.takePhotoButton.disabled = false;
        DOM.cancelCaptureButton.disabled = false;
      } catch(err){
        showMessage('captureMessage',`Erreur caméra: ${err.message}`,'error');
        stopIdCapture();
      }
    }

    function stopIdCapture(clearBlobs=true) {
      idCaptureStream?.getTracks().forEach(t=>t.stop());
      DOM.idVideo.srcObject = null;
      DOM.idCaptureContainer.style.display = 'none';
      DOM.takePhotoButton.disabled = true;
      DOM.cancelCaptureButton.disabled = true;
      DOM.captureIdButton.disabled = false;
      showMessage('captureMessage','','info');
      if (clearBlobs) {
        frontImageBlob = backImageBlob = null;
        DOM.frontPreview.src = '';
        DOM.backPreview.src = '';
        DOM.frontPreview.style.display = 'none';
        DOM.backPreview.style.display = 'none';
      }
    }

    function takePhotoAndExtract() {
      if (!idCaptureStream || DOM.idVideo.readyState<2) {
        showMessage('captureMessage','Caméra non prête','warning');
        return;
      }
      showMessage('captureMessage','Capture et analyse...','loading');
      DOM.takePhotoButton.disabled = true;
      DOM.cancelCaptureButton.disabled = true;
      const canvas = DOM.idCanvas;
      canvas.width  = DOM.idVideo.videoWidth;
      canvas.height = DOM.idVideo.videoHeight;
      canvas.getContext('2d').drawImage(DOM.idVideo,0,0,canvas.width,canvas.height);
      canvas.toBlob(async blob=>{
        if (!blob) {
          showMessage('captureMessage','Erreur capture image','error');
          stopIdCapture();
          return;
        }
        if (isCapturingFront) {
          frontImageBlob = blob;
          DOM.frontPreview.src = URL.createObjectURL(blob);
          DOM.frontPreview.style.display = 'inline-block';
          isCapturingFront = false;
          showMessage('captureMessage','Recto OK. Prenez le verso.','info');
          DOM.captureInstruction.textContent = 'Positionnez le VERSO et prenez la photo.';
          DOM.takePhotoButton.disabled = false;
          DOM.cancelCaptureButton.disabled = false;
        } else {
          backImageBlob = blob;
          DOM.backPreview.src = URL.createObjectURL(blob);
          DOM.backPreview.style.display = 'inline-block';
          stopIdCapture(false);
          showMessage('captureMessage','Verso OK. Analyse en cours...','loading');
          if (frontImageBlob && backImageBlob) {
            const formData = new FormData();
            formData.append('id_image_front', frontImageBlob, 'front.jpg');
            formData.append('id_image_back',  backImageBlob,  'back.jpg');
            try {
              const res = await fetchWithAuth(CONFIG.API_BASE_URL+'/webhook/extract-id-info',{
                method:'POST', body: formData
              });
              const data = await res.json();
              if (data?.data) {
                autofillCreateForm(data.data);
                showToast('Formulaire pré-rempli!','success');
              } else {
                throw new Error(data.message||'Aucune donnée extraite');
              }
            } catch(err){
              showMessage('captureMessage',`Erreur extraction: ${err.message}`,'error');
            } finally {
              frontImageBlob = backImageBlob = null;
            }
          }
        }
      },'image/jpeg',0.9);
    }

    function autofillCreateForm(extracted) {
      const d = extracted;
      if (d.date_of_birth) {
        const [j,m,a]=d.date_of_birth.split('/');
        DOM.dateNaissance.value = `${a}-${m.padStart(2,'0')}-${j.padStart(2,'0')}`;
      }
      DOM.nom.value  = d.last_name || '';
      DOM.prenom.value = d.first_name || '';
      DOM.cin.value = d.id_number || '';
      DOM.adresse.value = d.address || '';
      DOM.ville.value   = d.city || '';
      DOM.sexe.value    = d.gender==='F'?'F':'M';
      clearErrors();
      showMessage('message','Formulaire pré-rempli automatiquement.','info');
    }

    // Search patient
    async function handlePatientSearch() {
      const cin = DOM.getCin.value.trim();
      if (!cin) { showToast('Entrez un CIN','error'); return; }
      showToast('Recherche en cours...','success');
      try {
        const res = await fetchWithAuth(CONFIG.API_BASE_URL+`/webhook/get-patient?cin=${encodeURIComponent(cin)}`);
        const data = await res.json();
        if (data?.data) {
          const p = data.data;
          let dn='N/A';
          if (p.date_naissance) {
            const [y,m,d]=p.date_naissance.split('-');
            dn = `${d}/${m}/${y}`;
          }
          const qr = generateQrData(p.ipp);
          DOM.resultDiv.innerHTML = `
            <div class="patient-result-container">
              <div class="patient-result-info">
                <div><strong>Nom:</strong> ${sanitize(p.nom)}</div>
                <div><strong>Prénom:</strong> ${sanitize(p.prenom)}</div>
                <div><strong>CIN:</strong> ${sanitize(p.cin||'')}</div>
                <div><strong>Téléphone:</strong> ${sanitize(p.telephone||'')}</div>
                <div><strong>Adresse:</strong> ${sanitize(p.adresse||'')}</div>
                <div><strong>Ville:</strong> ${sanitize(p.ville||'')}</div>
                <div><strong>Naissance:</strong> ${dn}</div>
                <div><strong>Sexe:</strong> ${p.sexe==='M'?'Homme':'Femme'}</div>
                <div><strong>Mutuelle:</strong> ${sanitize(p.mutuelle||'')}</div>
                <div><strong>IPP:</strong> ${sanitize(p.ipp)}</div>
              </div>
              <div class="patient-result-qr">
                <img src="${qr.qrImageUrl}" alt="QR Code Patient">
                <button onclick="printQRCode('${qr.qrImageUrl}')" class="btn btn-secondary btn-sm">
                  <i class="fas fa-print"></i> Imprimer QR
                </button>
              </div>
            </div>`;
        } else {
          DOM.resultDiv.innerHTML = '<p>Patient non trouvé.</p>';
        }
      } catch(err){
        showToast(`Erreur: ${err.message}`,'error');
      }
    }

    // Create patient
    async function handleCreatePatient(e) {
      e.preventDefault();
      if (!validateForm()) return;
      showToast('Création patient en cours...','success');
      DOM.createPatientBtn.disabled = true;

      // extract medecin_referent matricule
      const mrText = DOM.medecinReferent.value.trim();
      let medecin_referent = '';
      if (mrText) {
        const sel = doctorsList.find(d => 
          `${d.nom} ${d.prenom} - ${d.specialite}`.toLowerCase() === mrText.toLowerCase()
        );
        if (sel) medecin_referent = sel.matricule;
      }
      const mut = DOM.hasInsurance.checked ? DOM.mutuelle.value.trim() : null;

      const payload = {
        nom: DOM.nom.value.trim(),
        prenom: DOM.prenom.value.trim(),
        cin: DOM.cin.value.trim(),
        telephone: DOM.telephone.value.trim(),
        adresse: DOM.adresse.value.trim(),
        ville: DOM.ville.value.trim(),
        date_naissance: DOM.dateNaissance.value,
        sexe: DOM.sexe.value,
        mutuelle: mut,
        medecin_referent
      };

      try {
        const res = await fetchWithAuth(CONFIG.API_BASE_URL + '/webhook/create-patient', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data?.data?.ipp) {
          const qr = generateQrData(data.data.ipp);
          DOM.createQrCodeImage.src = qr.qrImageUrl;
          DOM.createPrintButton.disabled = false;
          DOM.createPrintButton.onclick = () => printQRCode(qr.qrImageUrl);
          showToast('Patient créé avec succès !','success');
          resetForm();
        } else {
          throw new Error(data.message||'Erreur création');
        }
      } catch(err) {
        showToast(`Erreur: ${err.message}`,'error');
      } finally {
        DOM.createPatientBtn.disabled = false;
      }
    }

    // Logout
    function logout() {
      localStorage.removeItem(CONFIG.TOKEN_KEY);
      window.location = CONFIG.LOGIN_PAGE_URL;
    }

    // Init on load
    window.onload = () => {
      if (!localStorage.getItem(CONFIG.TOKEN_KEY)) return logout();
      resetSessionTimeout();
      populateMedecinReferent();
      populateMutuelles();
      handleMutuelleChange();
      DOM.hasInsurance.addEventListener('change', handleMutuelleChange);
      DOM.createForm.addEventListener('submit', handleCreatePatient);
      DOM.searchBtn.addEventListener('click', handlePatientSearch);
      DOM.getCin.addEventListener('keypress', e => { if (e.key==='Enter') handlePatientSearch(); });
      DOM.captureIdButton.addEventListener('click', startIdCapture);
      DOM.takePhotoButton.addEventListener('click', takePhotoAndExtract);
      DOM.cancelCaptureButton.addEventListener('click', () => stopIdCapture(true));
      ['mousemove','keypress','click','scroll'].forEach(evt =>
        document.addEventListener(evt, resetSessionTimeout, { passive: true })
      );
    };
  })();
  </script>
</body>
</html>
