<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - R√©ception</title>
  <!-- Using Consistent Fonts & Font Awesome -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- Using Consistent CSS -->
  <style>
      /* --- CSS remains exactly the same as your previous Reception version --- */
    :root {
      --primary: #5d74f2; --primary-light: #ebeffe; --success: #31c971; --success-light: #e0fbea; --warning: #ffb648; --warning-light: #fff8ec; --danger: #ff5a5a; --danger-light: #ffeded; --gray-100: #f9fafb; --gray-200: #f1f3f9; --gray-300: #e5e7eb; --gray-400: #d1d5db; --gray-500: #9ca3af; --gray-600: #6b7280; --gray-700: #4b5563; --gray-800: #374151; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px rgba(0,0,0,0.04); --border-radius: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.5; min-height: 100vh; padding: 0; visibility: hidden; /* Hide body initially */ }
    body.loaded { visibility: visible; /* Show body once JS check passes */ }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 0 0 30px 0; margin-bottom: 30px; border-bottom: 1px solid var(--gray-200); }
    .header-title { color: var(--primary); font-size: 1.5rem; font-weight: 600; }
    .logo { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; }
    .logo i { margin-right: 8px; }
    .card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-md); overflow: hidden; margin-bottom: 25px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--gray-200); }
    .card-title { font-size: 1rem; font-weight: 600; color: var(--gray-800); display: flex; align-items: center; }
    .card-title i { margin-right: 10px; color: var(--primary); }
    .card-actions { color: white; background: var(--primary); border-radius: var(--border-radius); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
    .card-body { padding: 20px; }
    .flex-row { display: flex; gap: 25px; margin-bottom: 25px; flex-wrap: wrap; }
    .flex-col { flex: 1; min-width: 350px; }
    label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--gray-600); }
    .input-group { margin-bottom: 15px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
    input[type="text"], input[type="date"], input[type="tel"], select { width: 100%; padding: 10px 12px; font-size: 0.9rem; border-radius: var(--border-radius); border: 1px solid var(--gray-300); background: white; transition: all 0.2s ease; font-family: 'Inter', sans-serif; }
    input[type="text"]:focus, input[type="date"]:focus, input[type="tel"]:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(93, 116, 242, 0.1); }
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; }
    .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--gray-700); margin-bottom: 0; }
    .checkbox-label input[type="checkbox"] { width: 1em; height: 1em; margin-right: 6px; }
    .mutuelle-group { grid-column: span 2; display: flex; flex-direction: column; gap: 10px; }
    .mutuelle-group > div:first-child { display: flex; align-items: center; }
    .btn-group { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-start; }
    .btn { padding: 8px 16px; font-size: 0.85rem; font-weight: 500; border-radius: var(--border-radius); border: none; cursor: pointer; transition: background-color 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
    .btn i { margin-right: 6px; }
    .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: #4a62d8; }
    .btn-success { background: var(--success); color: white; } .btn-success:hover { background: #28a960; }
    .btn-secondary { background: var(--gray-600); color: white; } .btn-secondary:hover { background: var(--gray-700); }
    .btn-outline { background: white; color: var(--primary); border: 1px solid var(--gray-300); } .btn-outline:hover { border-color: var(--primary); background: var(--primary-light); }
    .btn:disabled { background-color: var(--gray-300); cursor: not-allowed; }
    .form-submit-button { grid-column: span 2; }
    .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-bar input { flex-grow: 1; }
    .message { padding: 10px; border-radius: 6px; margin-top: 15px; font-size: 0.85rem; font-weight: 500; display: none; grid-column: span 2; }
    .message-success { background: var(--success-light); color: var(--success); }
    .message-warning { background: var(--warning-light); color: var(--warning); }
    .message-error { background: var(--danger-light); color: var(--danger); }
    #getResult { margin-top: 20px; padding: 0; background-color: transparent; border-radius: 0; border-left: none; display: none; }
    .patient-result-container { background-color: var(--gray-100); padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--primary); }
    .patient-result-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px 15px; margin-bottom: 15px; }
    .patient-result-info .info-group { margin-bottom: 0; }
    .info-group { margin-bottom: 5px; }
    .info-label { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px; }
    .info-value { font-size: 0.9rem; color: var(--gray-800); font-weight: 500; }
    .patient-result-qr { text-align: center; margin-top: 20px; }
    .patient-result-qr img { max-width: 200px; display: block; margin: 0 auto 15px auto; border: 1px solid var(--gray-300); padding: 5px; background: white; }
    #createResult { display: none; margin-top: 20px; text-align: center; background-color: var(--success-light); padding: 15px; border-radius: var(--border-radius); border-left: 4px solid var(--success); }
    #createResult p { color: var(--success); font-weight: 500; margin-bottom: 15px;}
    #createResult img { max-width: 180px; display: block; margin: 0 auto 15px auto; border: 1px solid var(--gray-300); padding: 5px; background: white; }
    @media (max-width: 768px) { .flex-row { flex-direction: column; } .form-grid { grid-template-columns: 1fr; } .mutuelle-group, .form-submit-button, .message { grid-column: span 1; } .patient-result-info { grid-template-columns: 1fr; } }
  </style>
</head>
<!-- Body starts hidden, made visible by JS after token check -->
<body >
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="header-title">üéØ Dashboard R√©ception</h1>
      <div class="logo">
        <i class="fas fa-clinic-medical"></i> MediClinic
        <!-- Added Logout Button -->
        <button onclick="logout()" style="margin-left: 20px; padding: 5px 10px; cursor: pointer;" title="D√©connexion" class="btn btn-outline">
            <i class="fas fa-sign-out-alt"></i> D√©connexion
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-row">

      <!-- Create Patient Card -->
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-user-plus"></i> Cr√©er un Patient</h2>
            <div class="card-actions"><i class="fas fa-pen"></i></div>
          </div>
          <div class="card-body">
            <form id="createForm">
              <div class="form-grid">
                <div class="input-group"> <label for="nom">Nom</label> <input id="nom" name="nom" placeholder="Nom de famille" required /> </div>
                <div class="input-group"> <label for="prenom">Pr√©nom</label> <input id="prenom" name="prenom" placeholder="Pr√©nom" required /> </div>
                <div class="input-group"> <label for="cin">CIN</label> <input id="cin" name="cin" placeholder="Carte d'Identit√© Nationale" required /> </div>
                <div class="input-group"> <label for="telephone">T√©l√©phone</label> <input id="telephone" name="telephone" type="tel" placeholder="Num√©ro de t√©l√©phone" required /> </div>
                <div class="input-group"> <label for="adresse">Adresse</label> <input id="adresse" name="adresse" placeholder="Adresse compl√®te" required /> </div>
                <div class="input-group"> <label for="ville">Ville</label> <input id="ville" name="ville" placeholder="Ville" required /> </div>
                <div class="input-group"> <label for="date_naissance">Date de Naissance</label> <input id="date_naissance" name="date_naissance" type="date" required /> </div>
                <div class="input-group"> <label for="sexe">Sexe</label> <select id="sexe" name="sexe"> <option value="M">Homme</option> <option value="F">Femme</option> </select> </div>
                <div class="input-group mutuelle-group"> <div> <input type="checkbox" id="has_insurance" name="has_insurance" style="width: auto; height: auto; margin-right: 8px;" /> <label for="has_insurance" class="checkbox-label">A une mutuelle ?</label> </div> <input name="mutuelle" placeholder="Nom Mutuelle (si case coch√©e)" /> </div>
                <div class="form-submit-button"> <button type="submit" class="btn btn-success"> <i class="fas fa-plus-circle"></i> Cr√©er Patient </button> </div>
                <div id="message" class="message"></div>
              </div>
            </form>
            <!-- DIV for Create Result -->
            <div id="createResult">
                <p id="createResultMessage"></p>
                <img id="createQrCodeImage" src="" alt="QR Code Patient" />
                <button id="createPrintButton" class="btn btn-secondary"> <i class="fas fa-print"></i> Imprimer QR Code </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Search Patient Card -->
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-search"></i> Rechercher un Patient</h2>
            <div class="card-actions"><i class="fas fa-users"></i></div>
          </div>
          <div class="card-body">
            <div class="search-bar">
              <input id="getCin" placeholder="Entrer le CIN du patient" />
              <button onclick="getPatient()" class="btn btn-primary"> <i class="fas fa-search"></i> Rechercher </button>
            </div>
            <div id="getResult"></div> <!-- Result Area -->
          </div>
        </div>
      </div>

    </div> <!-- End flex-row -->
  </div> <!-- End container -->

  <script>
    // --- Start Embedded Javascript ---
    const BASE_URL = 'https://workflows.aphelionxinnovations.com';
    const QR_TARGET_BASE_URL = 'app://medilink/patient'; // Or 'https://yourclinic.com/app/view' - CHOOSE

    // Get references to frequently used elements
    const resultDiv = document.getElementById("getResult");
    const messageDiv = document.getElementById("message");
    const createForm = document.getElementById("createForm");
    const createResultDiv = document.getElementById("createResult");

     // --- fetchWithAuth Helper Function ---
    function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('authToken');
        if (!token) {
            console.error('Reception: Auth token not found. Redirecting to login.');
            alert('Session expir√©e ou non connect√©. Veuillez vous reconnecter.');
            // *** PATH CORRECTED ***
            window.location.href = '/test/login/'; // Root-relative path to login
            return Promise.reject(new Error('Authentication token not found.'));
        }
        const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
        if (options.body && !(options.body instanceof FormData)) { headers['Content-Type'] = 'application/json'; }
        else if (options.body instanceof FormData) { delete headers['Content-Type']; }
        return fetch(url, { ...options, headers: headers })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                     console.error('Reception: Auth error:', response.status); localStorage.removeItem('authToken'); alert('Session expir√©e ou invalide. Veuillez vous reconnecter.');
                     // *** PATH CORRECTED ***
                     window.location.href = '/test/login/'; // Root-relative path to login
                     throw new Error(`Authentication failed: ${response.status}`);
                }
                 if (!response.ok) { return response.text().then(text => { throw new Error(`Erreur ${response.status}: ${text || response.statusText}`); }); }
                return response;
            });
    }
    // --- END: fetchWithAuth Helper Function ---

    // --- Logout Function ---
    function logout() {
        localStorage.removeItem('authToken');
        alert('Vous avez √©t√© d√©connect√©.');
        // *** PATH CORRECTED ***
        window.location.href = '/test/login/'; // Root-relative path to login
    }
    // --- END: Logout Function ---

    // --- window.onload Check ---
    window.onload = () => {
      if (!localStorage.getItem('authToken')) {
          console.log("Reception Dash: No auth token found on load, redirecting to login.");
           // *** PATH CORRECTED ***
          window.location.href = '/test/login/'; // Root-relative path to login
          return;
      }
      document.body.classList.add('loaded');
      console.log("Reception dashboard loaded with valid token.");
    };
    // --- END: window.onload Check ---


    // --- Show Message Function ---
    function showMessage(elementId, message, type) {
        const messageElement = document.getElementById(elementId);
        if (!messageElement) { console.error(`Msg Element "${elementId}" not found.`); return; }
        if (elementId === 'getResult' && type !== 'result') { messageElement.innerHTML = ''; }
        if (elementId === 'createResult' && type !== 'result') { messageElement.innerHTML = ''; }
        messageElement.innerHTML = message || ""; messageElement.style.display = message ? "block" : "none";
        if (type === 'result') { messageElement.className = ""; } else { messageElement.className = "message"; if (type === "success") messageElement.classList.add("message-success"); else if (type === "warning") messageElement.classList.add("message-warning"); else if (type === "error") messageElement.classList.add("message-error"); }
        if(elementId === 'createResult') { const isResult = type === 'result'; const baseBg = isResult ? 'var(--success-light)' : (type === 'warning' ? 'var(--warning-light)' : (type === 'error' ? 'var(--danger-light)' : 'transparent')); const baseBorder = isResult ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'transparent')); const textColor = isResult ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'inherit')); messageElement.style.backgroundColor = baseBg; messageElement.style.borderLeft = `4px solid ${baseBorder}`; messageElement.style.textAlign = 'center'; messageElement.style.marginTop = '20px'; messageElement.style.padding = '15px'; messageElement.style.borderRadius = 'var(--border-radius)'; const msgP = messageElement.querySelector('#createResultMessage'); const img = messageElement.querySelector('#createQrCodeImage'); const btn = messageElement.querySelector('#createPrintButton'); if(msgP) msgP.style.color = textColor; if(img) img.style.display = isResult ? 'block' : 'none'; if(btn) btn.style.display = isResult ? 'inline-block' : 'none'; }
        if (elementId === 'message' && type === "success" && message) { setTimeout(() => { if (messageElement.classList.contains("message-success") && messageElement.innerHTML === message) { messageElement.style.display = "none"; } }, 5000); }
    }

    // --- Generate QR Data Function ---
    function generateQrData(ipp) { if (!ipp) { console.error("IPP missing for QR data."); return null; } const qrTargetUrl = `${QR_TARGET_BASE_URL}?ipp=${encodeURIComponent(ipp)}`; const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrTargetUrl)}`; console.log("QR Target:", qrTargetUrl); console.log("QR Image:", qrImageUrl); return { qrTargetUrl, qrImageUrl }; }

    // --- Search Patient Function ---
    function getPatient() { const cin = document.getElementById("getCin").value.trim(); if (!cin) { showMessage('getResult', '<div class="message message-warning" style="display:block;"><i class="fas fa-exclamation-triangle"></i> Entrez CIN.</div>', 'result'); return; } resultDiv.innerHTML = '<div class="patient-result-container" style="text-align:center; padding: 20px;"><p><i class="fas fa-spinner fa-spin"></i> Recherche...</p></div>'; resultDiv.style.display = 'block'; resultDiv.className = ""; const url = `${BASE_URL}/webhook/get-patient?cin=${cin}`; fetchWithAuth(url) .then(res => res.json()) .then(data => { if (!data || !data.nom || !data.ipp) { throw new Error("Donn√©es patient invalides/IPP manquant."); } const qrData = generateQrData(data.ipp); if (!qrData) throw new Error("Erreur QR code."); const { qrImageUrl } = qrData; const formatDate = (d) => d ? new Date(d + 'T00:00:00Z').toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'}) : 'N/A'; const formatDateTime = (d) => d ? new Date(d).toLocaleString('fr-FR', { dateStyle: 'medium', timeStyle: 'short'}) : 'N/A'; const resultHTML = `<div class="patient-result-container"><div style="margin-bottom: 15px;"><h3 style="color: var(--primary);"><i class="fas fa-user-check"></i> ${data.prenom} ${data.nom}</h3></div><div class="patient-result-info"><div class="info-group"><div class="info-label">IPP</div><div class="info-value">${data.ipp||'N/A'}</div></div><div class="info-group"><div class="info-label">CIN</div><div class="info-value">${data.cin||'N/A'}</div></div><div class="info-group"><div class="info-label">T√©l√©phone</div><div class="info-value">${data.telephone||'N/A'}</div></div><div class="info-group"><div class="info-label">Naissance</div><div class="info-value">${formatDate(data.date_naissance)}</div></div><div class="info-group"><div class="info-label">Sexe</div><div class="info-value">${data.sexe==='M'?'Homme':'Femme'}</div></div><div class="info-group"><div class="info-label">Mutuelle</div><div class="info-value">${data.mutuelle||"Non"}</div></div><div class="info-group" style="grid-column:span 2;"><div class="info-label">Adresse</div><div class="info-value">${data.adresse||'N/A'}, ${data.ville||''}</div></div><div class="info-group"><div class="info-label">Cr√©√© le</div><div class="info-value">${formatDateTime(data.created_at)}</div></div></div><div class="patient-result-qr"><img src="${qrImageUrl}" alt="QR Code Patient" /><button onclick="printQRCode('${qrImageUrl}')" class="btn btn-secondary"><i class="fas fa-print"></i> Imprimer QR Code</button></div></div>`; showMessage('getResult', resultHTML, 'result'); }) .catch((err) => { console.error("Error fetching:", err); if (!err.message.startsWith('Auth')) { showMessage('getResult', `<div class="message message-error" style="display:block;"><i class="fas fa-exclamation-triangle"></i> ${err.message || "Erreur r√©cup√©ration."}</div>`, 'result'); }}); }

    // --- Print QR Code Function ---
    function printQRCode(qrImageUrl) { const printWindow = window.open('', '_blank', 'width=400,height=450'); if (!printWindow) { alert('Veuillez autoriser les pop-ups.'); return; } printWindow.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Imprimer QR</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet"/><style>body{font-family:'Inter',sans-serif;text-align:center;margin:0;padding-top:20px} img.logo{display:block;width:60px;margin:0 auto 10px auto} img.qrcode{display:block;width:200px;height:200px;margin:0 auto 15px auto;border:1px solid #eee;padding:5px;background:white} button{display:none;} @media print{body{margin:5mm;-webkit-print-color-adjust:exact;print-color-adjust:exact} img.logo, img.qrcode{margin-bottom:8px}}</style></head><body><img src="logo.webp" alt="Logo" class="logo" onerror="this.style.display='none'" /><img src="${qrImageUrl}" alt="QR Code" class="qrcode" /><script>let p=false;const a=()=>{if(!p){window.print();p=true;window.onafterprint=()=>window.close();setTimeout(()=>window.close(),1500)}};let i=document.querySelectorAll('img'),l=0,e=0,t=i.length;if(t===0)a();else{i.forEach(m=>{const c=()=>{if(l+e===t)a()};if(m.complete)l++,c();else{m.onload=()=>{l++;c()};m.onerror=()=>{e++;c()}}});setTimeout(()=>{if(!p)a()},3000)}<\/script></body></html>`); printWindow.document.close(); }

    // --- Create Patient Form Handler ---
    createForm?.addEventListener("submit", function (e) { e.preventDefault(); showMessage('message', '', ''); showMessage('createResult', '', ''); const form = e.target; const hasInsurance = form.has_insurance.checked; const mutuelleValue = form.mutuelle.value.trim(); if (hasInsurance && !mutuelleValue) { showMessage('message', '<i class="fas fa-exclamation-triangle"></i> Entrez nom mutuelle.', 'warning'); return; } const payload = { nom: form.nom.value.trim(), prenom: form.prenom.value.trim(), cin: form.cin.value.trim(), telephone: form.telephone.value.trim(), adresse: form.adresse.value.trim(), ville: form.ville.value.trim(), date_naissance: form.date_naissance.value, sexe: form.sexe.value, mutuelle: hasInsurance ? mutuelleValue : null }; if (!payload.nom || !payload.prenom || !payload.cin || !payload.telephone || !payload.date_naissance) { showMessage('message', '<i class="fas fa-exclamation-triangle"></i> Remplir champs obligatoires.', 'warning'); return; } const submitButton = form.querySelector('button[type="submit"]'); const originalButtonText = submitButton.innerHTML; submitButton.disabled = true; submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation...'; fetchWithAuth(`${BASE_URL}/webhook/create-patient`, { method: "POST", body: JSON.stringify(payload) }) .then(res => res.json()) .then(data => { if (!data || !data.ipp) { throw new Error("IPP manquant - cr√©ation √©chou√©e?"); } console.log("Create patient response:", data); const qrData = generateQrData(data.ipp); if (!qrData) { throw new Error("Erreur QR code post-cr√©ation."); } const { qrImageUrl } = qrData; document.getElementById('createResultMessage').innerHTML = `<i class="fas fa-check-circle"></i> Patient (${payload.prenom} ${payload.nom}) cr√©√©. IPP: ${data.ipp}`; document.getElementById('createQrCodeImage').src = qrImageUrl; const printButton = document.getElementById('createPrintButton'); printButton.onclick = () => printQRCode(qrImageUrl); showMessage('createResult', createResultDiv.innerHTML, 'result'); form.reset(); }) .catch((err) => { console.error("Error creating:", err); if (!err.message.startsWith('Auth')) { showMessage('message', `<i class="fas fa-exclamation-triangle"></i> ${err.message || "Erreur cr√©ation."}`, 'error'); } showMessage('createResult', '', ''); }) .finally(() => { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }); });

    // --- End Embedded Javascript ---
   </script>

</body>
</html>
