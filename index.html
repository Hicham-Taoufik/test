  <script>
    // --- Configuration & Constants ---
    const CONFIG = {
      API_BASE_URL: 'https://workflows.aphelionxinnovations.com',
      QR_TARGET_BASE_URL: 'app://medilink/patient', // Or 'https://yourclinic.com/app/view'
      LOGIN_PAGE_URL: 'https://hicham-taoufik.github.io/login/', // Absolute URL
      TOKEN_KEY: 'authToken',
      SESSION_TIMEOUT: 30 * 60 * 1000, // Example: 30 minutes (optional)
      MESSAGE_DISPLAY_TIME: 5000, // 5 seconds
      TOAST_DISPLAY_TIME: 3000 // 3 seconds for toasts
    };

    // --- DOM Elements Cache ---
    const DOM = {
      body: document.body,
      resultDiv: document.getElementById("getResult"),
      messageDiv: document.getElementById("message"), // Create form message
      createForm: document.getElementById("createForm"),
      createResultDiv: document.getElementById("createResult"),
      searchButton: document.getElementById("searchBtn"),
      cinInput: document.getElementById("getCin"),
      hasInsuranceCheckbox: document.getElementById("has_insurance"),
      mutuelleInput: document.getElementById("mutuelle"),
      mutuelleInputContainer: document.getElementById("mutuelle-input-container"), // Container for mutuelle input + error
      createPatientBtn: document.getElementById("createPatientBtn"),
      createResultMessage: document.getElementById("createResultMessage"),
      createQrCodeImage: document.getElementById("createQrCodeImage"),
      createPrintButton: document.getElementById("createPrintButton"),
      toast: document.getElementById("toast")
      // Add other form inputs if needed for validation access
    };

    // --- State Variables ---
    let currentIPP = null; // IPP of currently displayed patient (if any)
    let currentPatientInfo = null; // Full info of displayed patient
    let sessionTimeoutId = null; // For session timeout (optional)

    // --- Utility Functions ---

    /**
     * Shows toast notification
     * @param {string} message - Message to display
     * @param {string} type - 'success' or 'error'
     */
    function showToast(message, type = 'success') {
      if (!message || !DOM.toast) return;
      const icon = type === 'success' ? '<i class="fas fa-check-circle" aria-hidden="true"></i>' : '<i class="fas fa-exclamation-circle" aria-hidden="true"></i>';
      DOM.toast.innerHTML = `${icon} ${message}`;
      DOM.toast.className = `toast ${type}`; // Apply base and type class
      DOM.toast.classList.add('show');
      setTimeout(() => { DOM.toast.classList.remove('show'); }, CONFIG.TOAST_DISPLAY_TIME);
    }

    /**
     * Sanitizes text input (basic prevention)
     * @param {string} input - Text to sanitize
     * @return {string} Sanitized text
     */
    function sanitizeInput(input) {
      if (!input) return '';
      const temp = document.createElement('div');
      temp.textContent = input; // Relies on browser's textContent interpretation
      return temp.innerHTML;
    }

    /**
     * Shows message in specified element
     * @param {string} elementId - ID of message container
     * @param {string} message - Message content (HTML allowed)
     * @param {string} type - 'success', 'warning', 'error', 'info', 'result'
     */
    function showMessage(elementId, message, type) {
      const messageElement = document.getElementById(elementId);
      if (!messageElement) { console.error(`Msg Elem "${elementId}" not found.`); return; }

      const statusIcons = {'info':'fas fa-info-circle','success':'fas fa-check-circle','warning':'fas fa-exclamation-triangle','error':'fas fa-times-circle','loading':'fas fa-spinner fa-spin'};
      const iconClass = statusIcons[type] || statusIcons['info'];
      const iconHtml = message && type !== 'result' ? `<i class="${iconClass} me-2" aria-hidden="true"></i>` : ''; // Add icon only for non-result messages

      // Clear previous content safely
      while (messageElement.firstChild) { messageElement.removeChild(messageElement.firstChild); }

      // Set content and display
      if (message) {
          if (type === 'result') {
              // If it's a result, assume message is safe HTML generated elsewhere
              messageElement.innerHTML = message;
          } else {
              // For standard messages, ensure text is safe but allow icon HTML
              const textNode = document.createTextNode(message);
              messageElement.innerHTML = iconHtml; // Add icon first
              messageElement.appendChild(textNode); // Append sanitized text
          }
          messageElement.style.display = "block";
      } else {
           messageElement.style.display = "none";
      }


      // Set appropriate class based on type
      if (type === 'result') { messageElement.className = ""; /* Reset class for result containers */ }
      else { messageElement.className = "message"; if (type === "success") messageElement.classList.add("message-success"); else if (type === "warning") messageElement.classList.add("message-warning"); else if (type === "error") messageElement.classList.add("message-error"); else if (type === "info") messageElement.classList.add("message-info"); }

      // Style createResult container
       if(elementId === 'createResult') {
            const isResult = type === 'result';
            const baseBg = isResult ? 'var(--success-light)' : (type === 'warning' ? 'var(--warning-light)' : (type === 'error' ? 'var(--danger-light)' : 'transparent'));
            const baseBorder = isResult ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'transparent'));
            const textColor = isResult ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'inherit'));
            messageElement.style.backgroundColor = baseBg; messageElement.style.borderLeft = `4px solid ${baseBorder}`; messageElement.style.textAlign = 'center'; messageElement.style.marginTop = '20px'; messageElement.style.padding = '15px'; messageElement.style.borderRadius = 'var(--border-radius)';
            const msgP = messageElement.querySelector('#createResultMessage'); const img = messageElement.querySelector('#createQrCodeImage'); const btn = messageElement.querySelector('#createPrintButton');
            if(msgP) msgP.style.color = textColor;
            if(img) img.style.display = isResult ? 'block' : 'none';
            if(btn) btn.style.display = isResult ? 'inline-block' : 'none';
        }

      // Auto-hide non-error/warning messages
      if (type !== 'error' && type !== 'warning' && type !== 'loading' && message) {
           setTimeout(() => { if (messageElement.innerHTML.includes(message)) { messageElement.style.display = 'none'; } }, CONFIG.MESSAGE_DISPLAY_TIME);
      }
    }


    // --- Authentication & Session ---

    /**
     * Fetches data with Authorization header
     * @param {string} url - API endpoint URL
     * @param {object} options - Fetch options (method, body, etc.)
     * @returns {Promise<Response>} Fetch Response promise
     */
    function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem(CONFIG.TOKEN_KEY);
      if (!token) {
        console.error('Reception: No token.'); alert('Session expirée.');
        redirectToLogin();
        return Promise.reject(new Error('Token non trouvé.'));
      }
      resetSessionTimeout(); // Reset timeout on activity

      const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
      if (options.body && !(options.body instanceof FormData)) { headers['Content-Type'] = 'application/json'; }
      else if (options.body instanceof FormData) { delete headers['Content-Type']; }

      return fetch(url, { ...options, headers: headers })
        .then(response => {
          if (response.status === 401 || response.status === 403) {
            console.error('Reception: Auth error:', response.status); localStorage.removeItem(CONFIG.TOKEN_KEY); alert('Session invalide.');
            redirectToLogin();
            throw new Error(`Auth failed: ${response.status}`);
          }
          if (!response.ok) { return response.text().then(text => { throw new Error(`Erreur ${response.status}: ${text || response.statusText}`); }); }
          return response;
        });
    }

    /** Redirects to the login page */
    function redirectToLogin() {
      window.location.href = CONFIG.LOGIN_PAGE_URL;
    }

    /** Handles user logout */
    function logout() {
      localStorage.removeItem(CONFIG.TOKEN_KEY);
      clearTimeout(sessionTimeoutId); // Clear timeout on logout
      showToast('Déconnecté avec succès.', 'success');
      setTimeout(redirectToLogin, 1000); // Redirect after showing toast briefly
    }

    /** Resets the session timeout timer */
    function resetSessionTimeout() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      sessionTimeoutId = setTimeout(() => {
        console.warn("Session timeout reached.");
        logout(); // Logout on timeout
      }, CONFIG.SESSION_TIMEOUT);
    }

    // --- Form Validation ---

    /**
     * Validates the Create Patient form
     * @returns {boolean} True if valid, false otherwise
     */
    function validateCreateForm() {
        let isValid = true;
        const requiredFields = ['nom', 'prenom', 'cin', 'telephone', 'adresse', 'ville', 'date_naissance', 'sexe'];

        // Clear previous errors
        DOM.createForm.querySelectorAll('.input-group.has-error').forEach(el => el.classList.remove('has-error'));
        DOM.createForm.querySelectorAll('input, select').forEach(el => el.classList.remove('input-error'));

        for (const fieldName of requiredFields) {
            const input = DOM.createForm[fieldName];
            if (!input) continue; // Should not happen if form is correct
            const value = input.value.trim();
            const inputGroup = input.closest('.input-group'); // Find parent group

            if (!value) {
                isValid = false;
                if(inputGroup) inputGroup.classList.add('has-error');
                input.classList.add('input-error');
                 // Focus the first invalid field
                 if (isValid === false && typeof input.focus === 'function') {
                      input.focus();
                 }
            } else {
                 // Add more specific validation if needed (e.g., CIN format, phone format)
                if(inputGroup) inputGroup.classList.remove('has-error');
                input.classList.remove('input-error');
            }
        }

        // Mutuelle validation
        const mutuelleInputGroup = DOM.mutuelleInputContainer.closest('.input-group');
        if (DOM.hasInsuranceCheckbox.checked && !DOM.mutuelleInput.value.trim()) {
            isValid = false;
            if(mutuelleInputGroup) mutuelleInputGroup.classList.add('has-error');
            DOM.mutuelleInput.classList.add('input-error');
            if (isValid === false && typeof DOM.mutuelleInput.focus === 'function') {
                 DOM.mutuelleInput.focus();
            }
        } else {
             if(mutuelleInputGroup) mutuelleInputGroup.classList.remove('has-error');
             DOM.mutuelleInput.classList.remove('input-error');
        }

        if (!isValid) {
            showMessage('message', 'Veuillez corriger les erreurs dans le formulaire.', 'error');
        } else {
             showMessage('message', '', ''); // Clear any previous error message
        }

        return isValid;
    }


    // --- API Calls ---
    const apiService = {
        async fetchPatient(patientCin) { try { const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/get-patient?cin=${patientCin}`); return await res.json(); } catch (e) { console.error("Patient fetch error:", e); throw e; } },
        async createPatient(payload) { try { const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/create-patient`, { method: 'POST', body: JSON.stringify(payload) }); return await res.json(); } catch (e) { console.error("Patient create error:", e); throw e; } },
        async getInvoiceDetails(factureId) { /* ... If needed ... */ } // Add other API calls if Billing functionality moves here
    };

    // --- QR Code Functions ---
    function generateQrData(ipp) { if (!ipp) { console.error("IPP missing for QR data."); return null; } const qrTargetUrl = `${CONFIG.QR_TARGET_BASE_URL}?ipp=${encodeURIComponent(ipp)}`; const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrTargetUrl)}`; console.log("QR Target:", qrTargetUrl); console.log("QR Image:", qrImageUrl); return { qrTargetUrl, qrImageUrl }; }
    function printQRCode(qrImageUrl) { const printWindow = window.open('', '_blank', 'width=400,height=450'); if (!printWindow) { alert('Veuillez autoriser les pop-ups.'); return; } printWindow.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Imprimer QR</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet"/><style>body{font-family:'Inter',sans-serif;text-align:center;margin:0;padding-top:20px} img.logo{display:block;width:60px;margin:0 auto 10px auto} img.qrcode{display:block;width:200px;height:200px;margin:0 auto 15px auto;border:1px solid #eee;padding:5px;background:white} button{display:none;} @media print{body{margin:5mm;-webkit-print-color-adjust:exact;print-color-adjust:exact} img.logo, img.qrcode{margin-bottom:8px}}</style></head><body><img src="logo.webp" alt="Logo" class="logo" onerror="this.style.display='none'" /><img src="${qrImageUrl}" alt="QR Code" class="qrcode" /><script>let p=false;const a=()=>{if(!p){window.print();p=true;window.onafterprint=()=>window.close();setTimeout(()=>window.close(),1500)}};let i=document.querySelectorAll('img'),l=0,e=0,t=i.length;if(t===0)a();else{i.forEach(m=>{const c=()=>{if(l+e===t)a()};if(m.complete)l++,c();else{m.onload=()=>{l++;c()};m.onerror=()=>{e++;c()}}});setTimeout(()=>{if(!p)a()},3000)}<\/script></body></html>`); printWindow.document.close(); }


    // --- Event Handlers ---

    /** Handles Patient Search */
    async function handlePatientSearch() {
      const cin = DOM.cinInput.value.trim();
      if (!cin) {
          showMessage('getResult', '<div class="message message-warning" style="display:block;"><i class="fas fa-exclamation-triangle"></i> Veuillez entrer un CIN.</div>', 'result');
          return;
      }
      DOM.resultDiv.innerHTML = '<div class="patient-result-container" style="text-align:center; padding: 20px;"><p><i class="fas fa-spinner fa-spin"></i> Recherche...</p></div>';
      DOM.resultDiv.style.display = 'block'; DOM.resultDiv.className = "";
      
      try {
        const data = await apiService.fetchPatient(cin);
        if (!data || !data.nom || !data.ipp) { throw new Error("Données patient invalides ou IPP manquant."); }
        currentIPP = data.ipp; // Store current IPP
        currentPatientInfo = data; // Store patient info

        const qrData = generateQrData(data.ipp);
        if (!qrData) throw new Error("Erreur QR code.");
        const { qrImageUrl } = qrData;

        const formatDate = (d) => d ? new Date(d + 'T00:00:00Z').toLocaleDateString('fr-FR') : '-';
        const formatDateTime = (d) => d ? new Date(d).toLocaleString('fr-FR',{dateStyle:'medium',timeStyle:'short'}) : '-';

        const resultHTML = `
          <div class="patient-result-container">
              <div style="margin-bottom: 15px;"><h3 style="color: var(--primary);"><i class="fas fa-user-check"></i> ${data.prenom} ${data.nom}</h3></div>
              <div class="patient-result-info">
                   <div class="info-group"><div class="info-label">IPP</div><div class="info-value">${data.ipp||'-'}</div></div>
                   <div class="info-group"><div class="info-label">CIN</div><div class="info-value">${data.cin||'-'}</div></div>
                   <div class="info-group"><div class="info-label">Téléphone</div><div class="info-value">${data.telephone||'-'}</div></div>
                   <div class="info-group"><div class="info-label">Naissance</div><div class="info-value">${formatDate(data.date_naissance)}</div></div>
                   <div class="info-group"><div class="info-label">Sexe</div><div class="info-value">${data.sexe==='M'?'Homme':'Femme'}</div></div>
                   <div class="info-group"><div class="info-label">Mutuelle</div><div class="info-value">${data.mutuelle||"Non"}</div></div>
                   <div class="info-group" style="grid-column: span 2;"><div class="info-label">Adresse</div><div class="info-value">${data.adresse||'-'}, ${data.ville||''}</div></div>
                   <div class="info-group"><div class="info-label">Créé le</div><div class="info-value">${formatDateTime(data.created_at)}</div></div>
              </div>
              <div class="patient-result-qr">
                <img src="${qrImageUrl}" alt="QR Code Patient" />
                <button onclick="printQRCode('${qrImageUrl}')" class="btn btn-secondary"><i class="fas fa-print"></i> Imprimer QR Code</button>
              </div>
          </div>`;
         showMessage('getResult', resultHTML, 'result');
      } catch(err) {
         console.error("Error fetching patient:", err);
         if (!err.message.startsWith('Auth')) {
             showMessage('getResult', `<div class="message message-error" style="display:block;"><i class="fas fa-exclamation-triangle"></i> ${err.message || "Erreur récupération."}</div>`, 'result');
         }
      }
    }

    /** Handles Create Patient Form Submission */
    async function handleCreatePatient(event) {
      event.preventDefault();
      showMessage('message', '', ''); // Clear previous messages
      showMessage('createResult', '', ''); // Clear previous QR result

      if (!validateCreateForm()) {
        return; // Stop if validation fails
      }

      const form = event.target;
      const hasInsurance = DOM.hasInsuranceCheckbox.checked;
      const mutuelleValue = DOM.mutuelleInput.value.trim();

      const payload = {
        nom: form.nom.value.trim(), prenom: form.prenom.value.trim(), cin: form.cin.value.trim(), telephone: form.telephone.value.trim(), adresse: form.adresse.value.trim(), ville: form.ville.value.trim(), date_naissance: form.date_naissance.value, sexe: form.sexe.value, mutuelle: hasInsurance ? mutuelleValue : null
      };

      DOM.createPatientBtn.disabled = true;
      DOM.createPatientBtn.innerHTML = '<span class="loading-spinner" role="status" aria-hidden="true"></span> Création...';

      try {
          const data = await apiService.createPatient(payload);
          if (!data || !data.ipp) { throw new Error("IPP manquant - création échouée?"); }
          console.log("Create patient response:", data);
          form.reset(); // Reset form on success
          DOM.mutuelleInput.disabled = true; // Reset mutuelle input state

          const qrData = generateQrData(data.ipp);
          if (!qrData) { throw new Error("Erreur QR code post-création."); }
          const { qrImageUrl } = qrData;

          // Display success message and QR code
          DOM.createResultMessage.innerHTML = `<i class="fas fa-check-circle"></i> Patient (${payload.prenom} ${payload.nom}) créé. IPP: ${data.ipp}`;
          DOM.createQrCodeImage.src = qrImageUrl;
          DOM.createPrintButton.onclick = () => printQRCode(qrImageUrl); // Set print handler
          showMessage('createResult', DOM.createResultDiv.innerHTML, 'result'); // Show the result div

          showToast('Patient créé avec succès!', 'success');

      } catch(err) {
         console.error("Error creating patient:", err);
         if (!err.message.startsWith('Auth')) {
            showMessage('message', `<i class="fas fa-exclamation-triangle"></i> ${err.message || "Erreur création."}`, 'error');
         }
         showMessage('createResult', '', ''); // Hide create result on error
      } finally {
         DOM.createPatientBtn.disabled = false;
         DOM.createPatientBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Créer Patient';
      }
    }

    /** Handles Mutuelle Checkbox Change */
    function handleMutuelleChange() {
        DOM.mutuelleInput.disabled = !DOM.hasInsuranceCheckbox.checked;
        if (!DOM.hasInsuranceCheckbox.checked) {
            DOM.mutuelleInput.value = ''; // Clear value if unchecked
            DOM.mutuelleInput.classList.remove('input-error'); // Clear error state
            DOM.mutuelleInputContainer.closest('.input-group')?.classList.remove('has-error');
        }
         DOM.mutuelleInput.required = DOM.hasInsuranceCheckbox.checked; // Make required only if checked
    }


    // --- Event Listeners ---
    DOM.searchButton?.addEventListener('click', handlePatientSearch);
    DOM.cinInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handlePatientSearch(); }); // Allow search on Enter
    DOM.createForm?.addEventListener('submit', handleCreatePatient);
    DOM.hasInsuranceCheckbox?.addEventListener('change', handleMutuelleChange);

    // --- Initial Setup ---
    window.onload = () => {
      if (!localStorage.getItem(CONFIG.TOKEN_KEY)) {
          console.log("Reception: No token, redirecting.");
          redirectToLogin(); // Use centralized redirect function
          return;
      }
      DOM.body.classList.add('loaded');
      console.log("Reception: Authenticated.");
      resetSessionTimeout(); // Start session timer on load
      handleMutuelleChange(); // Set initial state of mutuelle input
      // Optionally load something on start? Or just wait for user action.
    };

    // Add listeners for activity to reset timeout (optional but good)
    // document.addEventListener('mousemove', resetSessionTimeout);
    // document.addEventListener('keypress', resetSessionTimeout);
    // document.addEventListener('click', resetSessionTimeout);

  </script>
</body>
</html>
