<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Dashboard de réception pour la gestion des patients - MediClinic" />
  <title>Réception - MediClinic</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    /* --- CSS (Includes styles for ID Capture) --- */
    :root { --primary: #5d74f2; --primary-light: #ebeffe; --primary-dark: #4a62d8; --success: #31c971; --success-light: #e0fbea; --success-dark: #28a960; --warning: #ffb648; --warning-light: #fff8ec; --danger: #ff5a5a; --danger-light: #ffeded; --gray-100: #f9fafb; --gray-200: #f1f3f9; --gray-300: #e5e7eb; --gray-400: #d1d5db; --gray-500: #9ca3af; --gray-600: #6b7280; --gray-700: #4b5563; --gray-800: #374151; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px rgba(0,0,0,0.04); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05); --shadow-focus: 0 0 0 3px rgba(93, 116, 242, 0.2); --border-radius: 0.5rem; --transition-speed: 0.2s; font-size: 15px; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.5; min-height: 100vh; padding: 0; visibility: hidden; }
    body.loaded { visibility: visible; animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .header { display: flex; align-items: center; padding: 15px 0; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--gray-200); }
    .header-main-content { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; }
    .logo { display: flex; align-items: center; }
    .logo-img { height: 38px; width: auto; margin-right: 10px; }
    .header-title { color: var(--gray-800); font-size: 1.4rem; font-weight: 600; margin: 0; white-space: nowrap; }
    .header-logout { flex-shrink: 0; margin-left: auto; }
    .logout-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: var(--border-radius); }
    .flex-row { display: flex; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .flex-col { flex: 1; min-width: 380px; }
    .card { background: #ffffff; padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow-md); margin-bottom: 1.5rem; transition: var(--transition); overflow: hidden; }
    .card:hover { box-shadow: var(--shadow-lg); }
    .card-header { padding: 0 0 1.25rem 0; margin-bottom: 1.25rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 1.15rem; font-weight: 600; color: var(--dark-color); margin: 0; display: flex; align-items: center; }
    .card-title i { margin-right: 0.5rem; font-size: 1.2rem; color: var(--primary-color); }
    .card-actions { color: white; background: var(--primary); border-radius: 0.5rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
    .card-body { /* Padding now applied to .card */ }
    label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--gray-600); font-weight: 500; }
    .input-group { margin-bottom: 1.25rem; position: relative; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 1rem; }
    input[type="text"], input[type="date"], input[type="tel"], input[type="email"], select { width: 100%; padding: 0.7rem 0.9rem; font-size: 0.9rem; border-radius: var(--border-radius); border: 1px solid #dfe3e8; background: white; transition: all var(--transition-speed) ease; font-family: 'Inter', sans-serif; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: var(--shadow-focus); }
    .input-error { border-color: var(--danger) !important; }
    .input-error:focus { box-shadow: 0 0 0 3px rgba(255, 90, 90, 0.2); }
    .error-text { color: var(--danger); font-size: 0.75rem; margin-top: 4px; display: none; }
    .input-group.has-error .error-text { display: block; }
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--gray-700); margin-bottom: 0; cursor: pointer; }
    .checkbox-label input[type="checkbox"] { width: 1.1em; height: 1.1em; margin-right: 0.4rem; cursor: pointer; accent-color: var(--primary); }
    .mutuelle-group { grid-column: span 2; display: flex; flex-direction: column; gap: 0.75rem; }
    .mutuelle-group > div:first-child { display: flex; align-items: center; }
    input[name="mutuelle"]:disabled { background-color: var(--gray-100); cursor: not-allowed; opacity: 0.7; border: 1px solid var(--gray-300); }
    .btn-group { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .btn { padding: 0.6rem 1.2rem; font-size: 0.85rem; font-weight: 500; border-radius: var(--border-radius); cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; width: auto; line-height: 1.5; border: 1px solid transparent; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: var(--primary-dark); } .btn-primary:disabled { background-color: var(--primary-light); border-color: var(--primary-light); cursor: not-allowed; }
    .btn-success { background: var(--success); color: white; } .btn-success:hover { background: var(--success-dark); }
    .btn-secondary { background: var(--gray-600); color: white; } .btn-secondary:hover { background: var(--gray-700); }
    .btn-outline { background: white; color: var(--primary); border: 1px solid var(--gray-300); } .btn-outline:hover { border-color: var(--primary); background: var(--primary-light); }
    .btn:disabled { background-color: var(--gray-300); cursor: not-allowed; opacity: 0.7; }
    .form-submit-button { grid-column: span 2; }
    .search-bar { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; }
    .search-bar input { flex-grow: 1; }
    .message { padding: 0.8rem 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; font-weight: 500; display: none; grid-column: span 2; animation: fadeIn 0.3s ease; word-break: break-word; }
    .message-success { background: var(--success-light); color: var(--success-dark); border-left: 4px solid var(--success); }
    .message-warning { background: var(--warning-light); color: var(--warning); border-left: 4px solid var(--warning); }
    .message-error { background: var(--danger-light); color: var(--danger); border-left: 4px solid var(--danger); }
    .message-info { background: var(--primary-light); color: var(--primary-dark); border-left: 4px solid var(--primary);}
    #getResult { margin-top: 1.25rem; padding: 0; background-color: transparent; border-radius: 0; border-left: none; display: none; } /* Adjusted result container styling */
    .patient-result-container { background-color: var(--gray-100); padding: 1.25rem; border-radius: var(--border-radius); border-left: 4px solid var(--primary); animation: slideIn 0.3s ease-out; margin-bottom: 1rem; } /* Added margin-bottom */
    /* Specific styling for messages within result containers */
    .patient-result-container.message { background-color: transparent; border-left-width: 4px; padding: 1rem; margin-bottom: 1rem; }
    .patient-result-container.message-warning { border-left-color: var(--warning); background-color: var(--warning-light); color: var(--warning); }
    .patient-result-container.message-error { border-left-color: var(--danger); background-color: var(--danger-light); color: var(--danger); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .patient-result-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem 1rem; margin-bottom: 1rem; }
    .patient-result-info .info-group { margin-bottom: 0; }
    .info-group { margin-bottom: 5px; }
    .info-label { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px; }
    .info-value { font-size: 0.9rem; color: var(--gray-800); font-weight: 500; }
    .patient-result-qr { text-align: center; margin-top: 1.25rem; }
    .patient-result-qr img { max-width: 180px; display: block; margin: 0 auto 1rem auto; border: 1px solid var(--gray-300); padding: 5px; background: white; transition: transform 0.3s ease; }
    .patient-result-qr img:hover { transform: scale(1.03); }
    /* Specific styling for #createResult div */
    #createResult { display: none; margin-top: 1.25rem; text-align: center; padding: 1rem; border-radius: var(--border-radius); border-left-width: 4px; border-left-style: solid; animation: fadeIn 0.3s ease; }
    #createResult.message-success { background-color: var(--success-light); border-left-color: var(--success); }
    #createResult.message-warning { background-color: var(--warning-light); border-left-color: var(--warning); }
    #createResult p { margin-bottom: 1rem; font-weight: 500; }
    #createResult.message-success p { color: var(--success-dark); }
    #createResult.message-warning p { color: var(--warning); }
    #createResult img { max-width: 160px; display: block; margin: 0 auto 1rem auto; border: 1px solid var(--gray-300); padding: 5px; background: white; }
    .loading-spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-left: -2px; margin-right: 8px; vertical-align: middle; } /* Added vertical-align */
    .btn .loading-spinner { border-top-color: white; }
    .btn-outline .loading-spinner { border-top-color: var(--primary); }
    .message .loading-spinner { border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--gray-600); width: 0.9em; height: 0.9em; } /* Spinner for messages */
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--gray-800); color: white; padding: 0.8rem 1.25rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); display: flex; align-items: center; z-index: 1000; transform: translateY(120px); opacity: 0; transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1); }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background-color: var(--success-dark); }
    .toast.error { background-color: var(--danger); }
    .toast i { margin-right: 0.75rem; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; box-shadow: none; }
    .skip-link { position: absolute; left: -9999px; z-index: 999; padding: 1em; background-color: white; color: var(--primary); opacity: 0; }
    .skip-link:focus { left: 50%; transform: translateX(-50%); opacity: 1; }
    #idCaptureContainer { display: none; margin-top: 1rem; border: 1px dashed var(--gray-400); padding: 1rem; border-radius: var(--border-radius); background-color: var(--gray-100); text-align: center; }
    #idVideo { display: block; width: 100%; max-width: 400px; height: auto; margin: 0 auto 1rem auto; border: 1px solid var(--gray-300); background-color: #000; }
    #idCaptureContainer .btn-group { justify-content: center; }
    .capture-preview { max-width: 150px; height: auto; margin: 0 5px; border: 1px solid var(--gray-400); border-radius: 4px; }
    #captureMessage { margin-top: 1rem; grid-column: span 1; } /* Make capture message span full width */
    .mb-4 { margin-bottom: 1.5rem !important; } /* Utility class */
    .me-2 { margin-right: 0.5rem !important; } /* Utility class */
    @media (max-width: 768px) { .flex-row { flex-direction: column; } .form-grid { grid-template-columns: 1fr; } .mutuelle-group, .form-submit-button, .message { grid-column: span 1; } .patient-result-info { grid-template-columns: 1fr; } .header { flex-direction: column; align-items: flex-start; gap: 15px; } .header-main-content { width: 100%; } .header-logout { width: 100%; margin-left: 0; } .logout-btn { width: 100%; justify-content: center; } .search-bar { flex-direction: column; } .search-bar .btn { width: 100%; } }
    @media (max-width: 480px) { .app-container { padding: 1rem; } .header-title { font-size: 1.2rem; } .card { padding: 1rem; } .btn { padding: 0.6rem 1rem; font-size: 0.8rem; } .patient-info { grid-template-columns: 1fr; } .btn-group { gap: 0.5rem; } }
    /* Print specific styles */
    @media print {
      body { visibility: visible !important; background: #fff !important; } /* Ensure body is visible for print */
      .no-print, .header, .search-bar, #createForm, #captureIdButton, #idCaptureContainer, .skip-link, .card-actions, .toast, #message, .logout-btn { display: none !important; }
      .container { max-width: 100%; padding: 0; margin: 0; }
      .flex-row { flex-direction: column; gap: 0; }
      .flex-col { min-width: auto; width: 100%; }
      .card { box-shadow: none; border: none; padding: 0; margin-bottom: 1cm; page-break-inside: avoid; }
      .card-header { border-bottom: 1px solid #ccc; padding-bottom: 0.5cm; margin-bottom: 0.5cm; }
      #getResult, #createResult { display: block !important; margin-top: 0; } /* Ensure results are shown */
      .patient-result-container { border-left: none; padding: 0; background: transparent; }
      .patient-result-qr img { max-width: 150px; margin-bottom: 5px; }
      .patient-result-qr p { display: none; } /* Hide descriptive text in print */
      .patient-result-qr button { display: none !important; } /* Hide print button in print view */
      #createResult img { max-width: 150px; }
      #createResult button { display: none !important; }
      /* Optional: adjust font size for print */
      /* body { font-size: 10pt; } */
      /* .info-label { font-size: 8pt; } */
      /* .info-value { font-size: 10pt; } */
    }

  </style>
</head>
<body >
  <a href="#main-content" class="skip-link">Passer au contenu principal</a>
  <div class="container">
    <div class="header no-print">
      <div class="header-main-content">
        <div class="logo"> <img src="./clinique-nakhil-logo-horizontal.webp" alt="MediClinic Logo" class="logo-img"> </div>
        <h1 class="header-title">Réception</h1>
      </div>
      <div class="header-logout"> <button onclick="logout()" class="btn btn-outline logout-btn no-print" aria-label="Déconnexion"> <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion </button> </div>
    </div>

    <main id="main-content" class="flex-row">
      <div class="flex-col">
        <section class="card" aria-labelledby="create-patient-heading">
          <div class="card-header"> <h2 id="create-patient-heading" class="card-title"><i class="fas fa-user-plus" aria-hidden="true"></i> Créer un Patient</h2> <div class="card-actions no-print" aria-hidden="true"><i class="fas fa-pen"></i></div> </div>
          <div class="card-body">

            <!-- ID Capture Section -->
            <div class="id-capture-section mb-4 no-print">
              <button id="captureIdButton" type="button" class="btn btn-primary"> <i class="fas fa-camera"></i> Scanner CIN </button>
              <div id="idCaptureContainer">
                  <p id="captureInstruction">Positionnez le RECTO de la CIN et prenez la photo.</p>
                  <video id="idVideo" playsinline></video>
                  <canvas id="idCanvas" style="display:none;"></canvas>
                   <div class="d-flex justify-content-center gap-2 my-2">
                        <img id="frontPreview" class="capture-preview" alt="Aperçu Recto" style="display: none;">
                        <img id="backPreview" class="capture-preview" alt="Aperçu Verso" style="display: none;">
                   </div>
                  <div class="btn-group mt-2">
                     <button id="takePhotoButton" type="button" class="btn btn-success" disabled> <i class="fas fa-camera-retro"></i> Prendre Photo </button>
                     <button id="cancelCaptureButton" type="button" class="btn btn-secondary" disabled> Annuler </button>
                  </div>
                  <div id="captureMessage" class="message mt-2"></div>
              </div>
            </div>
             <!-- END ID Capture Section -->

            <form id="createForm" novalidate class="no-print">
              <div class="form-grid">
                <div class="input-group"> <label for="nom">Nom <span aria-hidden="true">*</span></label> <input id="nom" name="nom" type="text" placeholder="Nom de famille" required aria-required="true" autocomplete="family-name"/> <div class="error-text">Veuillez entrer un nom</div> </div>
                <div class="input-group"> <label for="prenom">Prénom <span aria-hidden="true">*</span></label> <input id="prenom" name="prenom" type="text" placeholder="Prénom" required aria-required="true" autocomplete="given-name"/> <div class="error-text">Veuillez entrer un prénom</div> </div>
                <div class="input-group"> <label for="cin">CIN <span aria-hidden="true">*</span></label> <input id="cin" name="cin" type="text" placeholder="Ex: AB123456" required aria-required="true" pattern="^[A-Za-z]{1,2}\d{5,6}$"/> <div class="error-text">Format CIN invalide (ex: AB123456)</div> </div>
                <div class="input-group"> <label for="telephone">Téléphone <span aria-hidden="true">*</span></label> <input id="telephone" name="telephone" type="tel" placeholder="Ex: 0612345678" required aria-required="true" autocomplete="tel" pattern="^0[5-7]\d{8}$"/> <div class="error-text">Format téléphone invalide (0xxxxxxxx)</div> </div>
                <div class="input-group"> <label for="adresse">Adresse <span aria-hidden="true">*</span></label> <input id="adresse" name="adresse" type="text" placeholder="Adresse complète" required aria-required="true" autocomplete="address-line1"/> <div class="error-text">Veuillez entrer une adresse</div> </div>
                <div class="input-group"> <label for="ville">Ville <span aria-hidden="true">*</span></label> <input id="ville" name="ville" type="text" placeholder="Ville" required aria-required="true" autocomplete="address-level2"/> <div class="error-text">Veuillez entrer une ville</div> </div>
                <div class="input-group"> <label for="date_naissance">Date de Naissance <span aria-hidden="true">*</span></label> <input id="date_naissance" name="date_naissance" type="date" required aria-required="true" autocomplete="bday" max="9999-12-31"/> <div class="error-text">Veuillez entrer une date valide</div> </div>
                <div class="input-group"> <label for="sexe">Sexe <span aria-hidden="true">*</span></label> <select id="sexe" name="sexe" required aria-required="true" autocomplete="sex"> <option value="M">Homme</option> <option value="F">Femme</option> </select> <div class="error-text">Veuillez sélectionner un sexe</div> </div>
                <div class="input-group mutuelle-group"> <div> <input type="checkbox" id="has_insurance" name="has_insurance" /> <label for="has_insurance" class="checkbox-label">A une mutuelle ?</label> </div> <div id="mutuelle-input-container"> <input name="mutuelle" id="mutuelle" type="text" placeholder="Nom Mutuelle (si cochée)" aria-labelledby="has_insurance" disabled /> <div class="error-text">Veuillez entrer le nom de la mutuelle</div> </div> </div>
                <div class="form-submit-button"> <button type="submit" class="btn btn-success" id="createPatientBtn"> <i class="fas fa-plus-circle" aria-hidden="true"></i> Créer Patient </button> </div>
                <div id="message" class="message" role="alert" aria-live="polite"></div>
              </div>
            </form>
            <div id="createResult">
                <p id="createResultMessage"></p>
                <img id="createQrCodeImage" src="" alt="" loading="lazy" />
                <button id="createPrintButton" class="btn btn-secondary no-print" disabled> <i class="fas fa-print" aria-hidden="true"></i> Imprimer QR Code </button>
            </div>
          </div>
        </section>
      </div>

      <div class="flex-col">
        <section class="card" aria-labelledby="search-patient-heading">
          <div class="card-header"> <h2 id="search-patient-heading" class="card-title"><i class="fas fa-search" aria-hidden="true"></i> Rechercher un Patient</h2> <div class="card-actions no-print" aria-hidden="true"><i class="fas fa-users"></i></div> </div>
          <div class="card-body">
            <div class="search-bar no-print"> <input id="getCin" type="text" placeholder="Entrer le CIN du patient" aria-label="Numéro CIN du patient"/> <button id="searchBtn" class="btn btn-primary"> <i class="fas fa-search" aria-hidden="true"></i> Rechercher </button> </div>
            <div id="getResult" role="region" aria-live="polite">
                <!-- Search results will be injected here -->
            </div>
          </div>
        </section>
      </div>
    </main>

    <div id="toast" class="toast no-print" role="alert" aria-live="assertive"></div>
  </div>

  <script>
    // --- Configuration & Constants ---
    const CONFIG = { API_BASE_URL: 'https://workflows.aphelionxinnovations.com', QR_TARGET_BASE_URL: 'app://medilink/patient', LOGIN_PAGE_URL: 'https://hicham-taoufik.github.io/login/', TOKEN_KEY: 'authToken', SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutes
     MESSAGE_DISPLAY_TIME: 7000, // 7 seconds for info messages
     TOAST_DISPLAY_TIME: 4000 // 4 seconds for toasts
    };
    const DOM = { body: document.body, resultDiv: document.getElementById("getResult"), messageDiv: document.getElementById("message"), createForm: document.getElementById("createForm"), createResultDiv: document.getElementById("createResult"), searchButton: document.getElementById("searchBtn"), cinInput: document.getElementById("getCin"), hasInsuranceCheckbox: document.getElementById("has_insurance"), mutuelleInput: document.getElementById("mutuelle"), mutuelleInputContainer: document.getElementById("mutuelle-input-container"), createPatientBtn: document.getElementById("createPatientBtn"), createResultMessage: document.getElementById("createResultMessage"), createQrCodeImage: document.getElementById("createQrCodeImage"), createPrintButton: document.getElementById("createPrintButton"), toast: document.getElementById("toast"), captureIdButton: document.getElementById('captureIdButton'), idCaptureContainer: document.getElementById('idCaptureContainer'), idVideo: document.getElementById('idVideo'), takePhotoButton: document.getElementById('takePhotoButton'), cancelCaptureButton: document.getElementById('cancelCaptureButton'), captureMessage: document.getElementById('captureMessage'), idCanvas: document.getElementById('idCanvas'), frontPreview: document.getElementById('frontPreview'), backPreview: document.getElementById('backPreview'), captureInstruction: document.getElementById('captureInstruction') };
    let currentIPP = null; let currentPatientInfo = null; let sessionTimeoutId = null; let idCaptureStream = null; let frontImageBlob = null; let backImageBlob = null; let isCapturingFront = true;

    // --- Utility Functions ---
    function showToast(message, type = 'success') { if (!message || !DOM.toast) return; const icon = type === 'success' ? '<i class="fas fa-check-circle" aria-hidden="true"></i>' : '<i class="fas fa-exclamation-circle" aria-hidden="true"></i>'; DOM.toast.innerHTML = `${icon} ${message}`; DOM.toast.className = `toast ${type} no-print`; // Add no-print
     DOM.toast.classList.add('show'); setTimeout(() => { DOM.toast.classList.remove('show'); }, CONFIG.TOAST_DISPLAY_TIME); }
    function sanitizeInput(input) { if (!input) return ''; const temp = document.createElement('div'); temp.textContent = input; return temp.innerHTML; }
    function showMessage(elementId, message, type) { const el = document.getElementById(elementId); if (!el) { console.error(`Message Element "${elementId}" not found.`); return; } const statusIcons = {'info':'fas fa-info-circle','success':'fas fa-check-circle','warning':'fas fa-exclamation-triangle','error':'fas fa-times-circle','loading':'fas fa-spinner fa-spin'}; const iconClass = statusIcons[type] || statusIcons['info']; const iconHtml = message && type !== 'result' && type !== 'print-result' ? `<i class="${iconClass} me-2" aria-hidden="true"></i>` : ''; el.innerHTML = message ? `${iconHtml}${message}` : ""; el.style.display = message ? "block" : "none"; // Always set display based on message content
     // Base classes and specific type classes
     el.className = ""; // Reset classes
     if (elementId === 'getResult') { el.className = 'getResult'; // Base class for result area
     } else if (elementId === 'createResult') { el.className = 'createResult'; // Base class for create result
     } else if (elementId === 'captureMessage') { el.className = 'message mt-2'; // Base class for capture message
     } else if (elementId === 'message') { el.className = 'message'; // Base class for general form message
     }
     // Apply type-specific styling classes
     if (type === "success") el.classList.add("message-success"); else if (type === "warning") el.classList.add("message-warning"); else if (type === "error") el.classList.add("message-error"); else if (type === "info" || type === 'loading') el.classList.add("message-info"); // Use info style for loading too
     // Special handling for createResult styling and content visibility
     if(elementId === 'createResult') { const isSuccessResult = type === 'success'; // Specifically check for success result type
        const isWarningResult = type === 'warning';
        const msgP = el.querySelector('#createResultMessage'); const img = el.querySelector('#createQrCodeImage'); const btn = el.querySelector('#createPrintButton'); if(msgP) { msgP.innerHTML = message ? `${iconHtml}${message}` : ""; // Update paragraph content
         }
         if(img) img.style.display = isSuccessResult ? 'block' : 'none'; // Show img only on success
         if(btn) btn.style.display = isSuccessResult ? 'inline-block' : 'none'; // Show button only on success
         el.style.display = (isSuccessResult || isWarningResult) ? 'block' : 'none'; // Show div only for success/warning results
     }

     // Auto-hide non-error/warning/loading messages in the main form message area
     if (type !== 'error' && type !== 'warning' && type !== 'loading' && message && elementId === 'message') { setTimeout(() => { const currentElement = document.getElementById(elementId); if (currentElement && currentElement.style.display !== 'none' && currentElement.innerHTML.includes(message)) { // Check if still visible and has same message
          currentElement.style.display = 'none'; currentElement.innerHTML = ''; } }, CONFIG.MESSAGE_DISPLAY_TIME); } }

    // --- Authentication & Session ---
    function fetchWithAuth(url, options={}) { const token=localStorage.getItem(CONFIG.TOKEN_KEY); if(!token){console.error('No auth token found.');alert('Votre session a expiré. Veuillez vous reconnecter.');redirectToLogin();return Promise.reject(new Error('Token non trouvé.'));} resetSessionTimeout(); const headers={...options.headers,'Authorization':`Bearer ${token}`}; if(options.body&&!(options.body instanceof FormData)){headers['Content-Type']='application/json';} else if(options.body instanceof FormData){delete headers['Content-Type'];} // Let browser set Content-Type for FormData
     return fetch(url,{...options,headers:headers}).then(r=>{if(r.status===401||r.status===403){console.error('Authentication error:',r.status);localStorage.removeItem(CONFIG.TOKEN_KEY);alert('Session invalide ou expirée. Veuillez vous reconnecter.');redirectToLogin();throw new Error(`Authentication failed:${r.status}`);} if(!r.ok){return r.text().then(text=>{console.error(`API Error ${r.status}: ${text}`);throw new Error(`Erreur ${r.status}: ${text||r.statusText}`);});} return r;}); }
    function redirectToLogin() { window.location.href = CONFIG.LOGIN_PAGE_URL; }
    function logout() { localStorage.removeItem(CONFIG.TOKEN_KEY); clearTimeout(sessionTimeoutId); showToast('Déconnexion réussie.', 'success'); setTimeout(redirectToLogin, 1000); }
    function resetSessionTimeout() { if (sessionTimeoutId) clearTimeout(sessionTimeoutId); sessionTimeoutId = setTimeout(logout, CONFIG.SESSION_TIMEOUT); }

    // --- Form Validation ---
    function validateField(input, validationFn, errorMessage) { const value = input.value.trim(); const group = input.closest('.input-group'); if (!group) return true; // Skip if not in a group
     const isValid = validationFn(value); group.classList.toggle('has-error', !isValid); input.classList.toggle('input-error', !isValid); const errorDiv = group.querySelector('.error-text'); if (errorDiv) { errorDiv.textContent = isValid ? '' : errorMessage; errorDiv.style.display = isValid ? 'none' : 'block'; // Explicitly show/hide
     } return isValid; }
    function validateCreateForm() { let isValid = true; showMessage('message', '', ''); // Clear previous general messages
     DOM.createForm.querySelectorAll('.input-group.has-error').forEach(el => el.classList.remove('has-error')); DOM.createForm.querySelectorAll('input.input-error, select.input-error').forEach(el => el.classList.remove('input-error')); DOM.createForm.querySelectorAll('.error-text').forEach(el => { el.textContent = ''; el.style.display = 'none'; }); // Clear and hide all error texts initially
     isValid &= validateField(DOM.createForm.nom, val => val.length > 0, "Nom requis"); isValid &= validateField(DOM.createForm.prenom, val => val.length > 0, "Prénom requis"); isValid &= validateField(DOM.createForm.cin, val => /^[A-Za-z]{1,2}\d{5,6}$/.test(val), "Format CIN invalide (ex: AB123456)"); isValid &= validateField(DOM.createForm.telephone, val => /^0[5-7]\d{8}$/.test(val), "Format téléphone 0Xxxxxxxxx requis"); isValid &= validateField(DOM.createForm.adresse, val => val.length > 0, "Adresse requise"); isValid &= validateField(DOM.createForm.ville, val => val.length > 0, "Ville requise"); isValid &= validateField(DOM.createForm.date_naissance, val => val !== '' && new Date(val) < new Date(), "Date naissance valide requise"); // Ensure date is not empty and in the past
     isValid &= validateField(DOM.createForm.sexe, val => val === 'M' || val === 'F', "Sélection sexe requise"); const mutuelleGroup = DOM.mutuelleInput.closest('.input-group'); if (DOM.hasInsuranceCheckbox.checked) { isValid &= validateField(DOM.mutuelleInput, val => val.length > 0, "Nom mutuelle requis si cochée"); } else { // Clear potential error if unchecked and previously invalid
       if(mutuelleGroup) mutuelleGroup.classList.remove('has-error'); DOM.mutuelleInput.classList.remove('input-error'); const errorDiv = mutuelleGroup?.querySelector('.error-text'); if(errorDiv) {errorDiv.textContent = ''; errorDiv.style.display='none';} } if (!isValid) { showMessage('message', 'Veuillez corriger les erreurs indiquées dans le formulaire.', 'error'); const firstError = DOM.createForm.querySelector('.input-error, .has-error select'); if(firstError) { firstError.focus(); firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); } } return !!isValid; // Ensure boolean return
    }

    // --- API Service ---
    const apiService = { async fetchPatient(cin) { try { const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/get-patient?cin=${encodeURIComponent(cin)}`); return await res.json(); // Assuming API returns JSON directly
      } catch (e) { console.error("Patient fetch error:", e); throw e; // Re-throw to be caught by caller
      } }, async createPatient(payload) { try { const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/create-patient`, { method: 'POST', body: JSON.stringify(payload) }); return await res.json(); } catch (e) { console.error("Patient create error:", e); throw e; } }, async extractIdInfo(formData) { try { const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/extract-id-info`, { method: 'POST', body: formData // FormData is passed directly
      }); return await res.json(); } catch (e) { console.error("ID Extraction error:", e); throw e; } }};

    // --- QR Code Functions ---
    function generateQrData(ipp) { if (!ipp) { console.warn("IPP manquant pour la génération du QR Code."); return null; } const qrTargetUrl = `${CONFIG.QR_TARGET_BASE_URL}?ipp=${encodeURIComponent(ipp)}`; const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrTargetUrl)}&ecc=M`; // Use ECC M for better readability
     console.log("QR Target URL:", qrTargetUrl); console.log("QR Image URL:", qrImageUrl); return { qrTargetUrl, qrImageUrl }; }
    function printQRCode(qrImageUrl) { const printWindow = window.open('', '_blank', 'width=400,height=450,scrollbars=yes,resizable=yes'); if (!printWindow) { alert("Impossible d'ouvrir la fenêtre d'impression. Veuillez vérifier les paramètres de blocage des pop-ups de votre navigateur."); return; } printWindow.document.write(`<!DOCTYPE html>
     <html lang="fr">
     <head>
      <meta charset="UTF-8">
      <title>Imprimer QR Code Patient</title>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet"/>
      <style>
        body { font-family: 'Inter', sans-serif; text-align: center; margin: 0; padding: 20px; }
        img.logo { display: block; max-width: 80px; height: auto; margin: 0 auto 10px auto; }
        img.qrcode { display: block; width: 200px; height: 200px; margin: 0 auto 15px auto; border: 1px solid #eee; padding: 5px; background: white; }
        p.ipp-info { font-size: 9pt; color: #555; margin-top: 0; }
        @media print {
          body { margin: 5mm; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          img.logo, img.qrcode { margin-bottom: 8px; }
        }
      </style>
     </head>
     <body>
      <img src="./clinique-nakhil-logo-horizontal.webp" alt="Logo MediClinic" class="logo" onerror="this.style.display='none'" />
      <img src="${qrImageUrl}" alt="QR Code Patient" class="qrcode" id="qrImageToPrint" />
      ${currentIPP ? `<p class="ipp-info">IPP: ${sanitizeInput(currentIPP)}</p>` : ''}

      <script>
        let printed = false;
        const attemptPrint = () => {
          if (!printed) {
            try {
              window.print();
              printed = true;
              window.onafterprint = () => window.close();
              // Fallback close after a delay
              setTimeout(() => { try { window.close(); } catch(e){} }, 2000);
            } catch (e) {
              console.error("Print error:", e);
              // Optionally alert the user if printing fails immediately
              // alert("Erreur lors du lancement de l'impression.");
              try { window.close(); } catch(e){} // Try closing anyway
            }
          }
        };

        const img = document.getElementById('qrImageToPrint');
        if (img) {
          if (img.complete && img.naturalWidth > 0) {
            console.log('QR Image already complete. Printing.');
            attemptPrint();
          } else {
            img.onload = () => { console.log('QR Image loaded. Printing.'); attemptPrint(); };
            img.onerror = () => { console.error('QR Image failed to load.'); alert("Erreur: L'image QR Code n'a pas pu être chargée pour l'impression."); window.close(); };
             // Safety timeout if onload/onerror somehow fail
            setTimeout(() => {
                console.log('Print fallback timeout reached.');
                if (!printed) attemptPrint();
             }, 3000);
          }
        } else {
          console.log('No QR image found, attempting print anyway.');
          attemptPrint(); // Try printing even without the image if something went wrong
        }
      </script>
     </body>
     </html>`); printWindow.document.close(); // Close the document stream
    }


    // --- ID Capture Functions ---
    function updateCaptureMessage(message, type = 'info') { showMessage('captureMessage', message, type); }
    async function startIdCapture() { if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { updateCaptureMessage('Demande d\'accès à la caméra...', 'loading'); DOM.captureIdButton.disabled = true; DOM.idCaptureContainer.style.display = 'block'; DOM.frontPreview.style.display = 'none'; DOM.backPreview.style.display = 'none'; DOM.frontPreview.src = ''; DOM.backPreview.src = ''; frontImageBlob = null; backImageBlob = null; isCapturingFront = true; DOM.captureInstruction.textContent = "Positionnez le RECTO de la CIN et prenez la photo."; try { const constraints = { video: { facingMode: 'environment', // Prefer back camera
              width: { ideal: 1920 }, height: { ideal: 1080 }, // Request higher resolution
              frameRate: { ideal: 15 } // Lower framerate might help stability
             }, audio: false }; idCaptureStream = await navigator.mediaDevices.getUserMedia(constraints); DOM.idVideo.srcObject = idCaptureStream; await DOM.idVideo.play(); updateCaptureMessage('Caméra prête. Cadrez le RECTO de la CIN.', 'info'); DOM.takePhotoButton.disabled = false; DOM.cancelCaptureButton.disabled = false; } catch (err) { console.error("Camera access error:", err); updateCaptureMessage(`Erreur accès caméra: ${err.message}. Vérifiez les permissions.`, 'error'); stopIdCapture(false); // Don't clear blobs if we didn't capture any
        } } else { alert("Votre navigateur ne supporte pas l'accès à la caméra."); updateCaptureMessage("Fonctionnalité caméra non supportée par ce navigateur.", 'error'); DOM.captureIdButton.disabled = false; // Re-enable button if feature not supported
       } }
    function stopIdCapture(clearBlobs = true) { if (idCaptureStream) { idCaptureStream.getTracks().forEach(track => track.stop()); console.log("Camera stream stopped."); } DOM.idVideo.srcObject = null; DOM.idCaptureContainer.style.display = 'none'; DOM.takePhotoButton.disabled = true; DOM.cancelCaptureButton.disabled = true; DOM.captureIdButton.disabled = false; // Always re-enable the start button
     idCaptureStream = null; updateCaptureMessage('', ''); // Clear message
     if (clearBlobs) { frontImageBlob = null; backImageBlob = null; DOM.frontPreview.src = ''; DOM.backPreview.src = ''; DOM.frontPreview.style.display = 'none'; DOM.backPreview.style.display = 'none'; console.log("ID Capture cancelled and blobs cleared."); } else { console.log("ID Capture stopped, blobs preserved."); } }
    async function takePhotoAndExtract() { if (!idCaptureStream || !DOM.idVideo || DOM.idVideo.readyState < DOM.idVideo.HAVE_CURRENT_DATA) { // More robust check
        console.warn("Camera not ready or stream ended unexpectedly."); updateCaptureMessage('Caméra non prête ou flux interrompu.', 'warning'); DOM.takePhotoButton.disabled = false; // Re-enable button if capture failed early
        DOM.cancelCaptureButton.disabled = false; return; } updateCaptureMessage('Capture en cours...', 'loading'); DOM.takePhotoButton.disabled = true; DOM.cancelCaptureButton.disabled = true; // Disable during capture/processing
     const canvas = DOM.idCanvas; canvas.width = DOM.idVideo.videoWidth; canvas.height = DOM.idVideo.videoHeight; const context = canvas.getContext('2d'); if (!context) { console.error("Failed to get 2D context from canvas"); updateCaptureMessage('Erreur interne (canvas).', 'error'); stopIdCapture(); return; } context.drawImage(DOM.idVideo, 0, 0, canvas.width, canvas.height); canvas.toBlob(async (blob) => { if (!blob) { console.error("Canvas toBlob failed to create blob."); updateCaptureMessage('Erreur lors de la création de l\'image.', 'error'); stopIdCapture(); DOM.takePhotoButton.disabled = false; DOM.cancelCaptureButton.disabled = false; return; } if (isCapturingFront) { frontImageBlob = blob; console.log("Recto captured (size:", blob.size, "type:", blob.type, ")"); DOM.frontPreview.src = URL.createObjectURL(frontImageBlob); DOM.frontPreview.style.display = 'inline-block'; isCapturingFront = false; DOM.captureInstruction.textContent = "Positionnez le VERSO de la CIN et prenez la photo."; updateCaptureMessage('Recto capturé. Préparez le VERSO.', 'info'); DOM.takePhotoButton.disabled = false; // Re-enable for next shot
           DOM.cancelCaptureButton.disabled = false; } else { backImageBlob = blob; console.log("Verso captured (size:", blob.size, "type:", blob.type, ")"); DOM.backPreview.src = URL.createObjectURL(backImageBlob); DOM.backPreview.style.display = 'inline-block'; stopIdCapture(false); // Stop video stream but keep blobs
           updateCaptureMessage('Verso capturé. Analyse des données en cours...', 'loading'); if (frontImageBlob && backImageBlob) { const formData = new FormData(); formData.append('id_image_front', frontImageBlob, 'id_card_front.jpeg'); // Use jpeg extension
               formData.append('id_image_back', backImageBlob, 'id_card_back.jpeg'); try { console.log("Sending ID images for extraction..."); const extractedData = await apiService.extractIdInfo(formData); console.log("Extracted ID Data Response:", extractedData); if (extractedData && extractedData.data && Object.keys(extractedData.data).length > 0) { autofillCreateForm(extractedData); showToast('Formulaire pré-rempli avec succès !', 'success'); updateCaptureMessage('Données extraites et formulaire rempli.', 'success'); } else { const errorMessage = extractedData?.message || "Aucune donnée pertinente n'a pu être extraite automatiquement."; console.warn("ID Extraction Warning:", errorMessage, extractedData); updateCaptureMessage(`Extraction échouée: ${errorMessage}`, 'warning'); // Show warning in capture area
                 } } catch (error) { console.error("Error during ID extraction API call:", error); updateCaptureMessage(`Erreur lors de l'analyse : ${error.message}`, 'error'); } finally { // Clean up blobs regardless of success/error after API call
                 console.log("Cleaning up image blobs."); frontImageBlob = null; backImageBlob = null; // Don't clear previews here, keep them visible
                 // URL.revokeObjectURL(DOM.frontPreview.src); // Optional: revoke URLs later if needed
                 // URL.revokeObjectURL(DOM.backPreview.src);
               } } else { console.error("Missing front or back image blob before sending API request."); updateCaptureMessage('Erreur: Image recto ou verso manquante.', 'error'); } // Re-enable main capture button after process finishes or fails
            DOM.captureIdButton.disabled = false; } }, 'image/jpeg', 0.9); // Use JPEG format, quality 0.9
    }
    function autofillCreateForm(data) {
        const form = DOM.createForm;
        if (!form || !data || typeof data.data !== 'object' || data.data === null) {
            console.error("Autofill failed: Invalid or missing data object provided.", data);
            updateCaptureMessage('Erreur interne lors du pré-remplissage du formulaire.', 'error');
            return;
        }

        const extracted = data.data;
        console.log("Data received for Autofill:", extracted);

        // --- Date of Birth Formatting ---
        let formattedDateOfBirth = "";
        if (extracted.date_of_birth && typeof extracted.date_of_birth === 'string') {
            const originalDateString = extracted.date_of_birth.trim();
            // More flexible regex: DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD, YYYY-MM-DD
             const datePartsDMY = originalDateString.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
             const datePartsYMD = originalDateString.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);

             let day, month, year;

            if (datePartsDMY && datePartsDMY.length === 4) {
                day = datePartsDMY[1];
                month = datePartsDMY[2];
                year = datePartsDMY[3];
                console.log("Parsed date as DD/MM/YYYY format");
            } else if (datePartsYMD && datePartsYMD.length === 4) {
                year = datePartsYMD[1];
                month = datePartsYMD[2];
                day = datePartsYMD[3];
                console.log("Parsed date as YYYY/MM/DD format");
            }

            if (day && month && year) {
                 // Basic validation
                const monthInt = parseInt(month, 10);
                const dayInt = parseInt(day, 10);
                const yearInt = parseInt(year, 10);
                if (monthInt >= 1 && monthInt <= 12 && dayInt >= 1 && dayInt <= 31 && yearInt > 1900 && yearInt <= new Date().getFullYear()) {
                    formattedDateOfBirth = `${year}-${String(monthInt).padStart(2, '0')}-${String(dayInt).padStart(2, '0')}`;
                    console.log("Formatted date_of_birth for input:", formattedDateOfBirth);
                } else {
                    console.warn("Invalid date components parsed from:", originalDateString);
                }
            } else {
                console.warn("Date of birth format not recognized:", originalDateString);
            }
        } else {
            console.warn("Date of birth missing, null, or not a string in extracted data.");
        }

        // Fill form fields safely using nullish coalescing
        form.nom.value = extracted.last_name ?? '';
        form.prenom.value = extracted.first_name ?? '';
        form.cin.value = extracted.id_number ?? '';
        form.date_naissance.value = formattedDateOfBirth; // Use formatted or empty string
        form.adresse.value = extracted.address ?? '';
        form.ville.value = extracted.city ?? ''; // Assuming API provides 'city', adjust if key is different

        // Handle Gender - Check for different possible values if API is inconsistent
        const gender = (typeof extracted.gender === 'string') ? extracted.gender.toUpperCase().charAt(0) : ''; // Take first char, uppercase
        form.sexe.value = (gender === 'F') ? 'F' : 'M'; // Default to 'M' if not 'F'

        // ---- Clear potential previous validation errors on filled fields ----
        form.querySelectorAll('.input-group').forEach(group => {
            const input = group.querySelector('input:not([type=checkbox]), select');
            if (input && input.value !== '') { // Clear error only if field got a value
                group.classList.remove('has-error');
                input.classList.remove('input-error');
                const errorDiv = group.querySelector('.error-text');
                if (errorDiv) {
                    errorDiv.textContent = '';
                    errorDiv.style.display = 'none';
                }
            }
        });
        // ----

        // Provide user feedback via the main message area of the form
        showMessage('message', 'Formulaire pré-rempli. Veuillez vérifier et compléter les informations manquantes.', 'info');

        // Focus the first empty required field for better UX, or the first field if all filled
        const firstEmptyRequired = form.querySelector('input[required]:not([disabled]):placeholder-shown, input[required]:not([disabled])[value=""], select[required]:not([disabled])[value=""]');
        if(firstEmptyRequired) {
            firstEmptyRequired.focus();
            firstEmptyRequired.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (form.nom) {
            form.nom.focus(); // Fallback to the first field
        }
    }


    // --- Event Handlers ---
    async function handlePatientSearch() {
      showMessage('getResult', '', ''); // Clear previous search results immediately
      const cinInput = DOM.cinInput;
      if (!cinInput) { console.error("Search CIN input element not found"); return; }
      const cin = cinInput.value.trim().toUpperCase(); // Standardize CIN input
      if (!cin) { // Show message directly in getResult
         DOM.resultDiv.innerHTML = `<div class="patient-result-container message message-warning"><i class="fas fa-exclamation-triangle me-2"></i> Veuillez entrer un CIN pour la recherche.</div>`;
         DOM.resultDiv.style.display = 'block';
         cinInput.focus(); return; }
      if (!/^[A-Za-z]{1,2}\d{5,6}$/.test(cin)) { // Basic CIN format check before API call
         DOM.resultDiv.innerHTML = `<div class="patient-result-container message message-warning"><i class="fas fa-exclamation-triangle me-2"></i> Format CIN invalide pour la recherche (ex: AB123456).</div>`;
         DOM.resultDiv.style.display = 'block';
         cinInput.focus(); return; }

      // Show loading message within the result container
      DOM.resultDiv.innerHTML = `<div class="patient-result-container message message-info"><span class="loading-spinner"></span> Recherche du patient avec CIN : ${sanitizeInput(cin)}...</div>`;
      DOM.resultDiv.style.display = 'block'; // Ensure container is visible
      DOM.searchButton.disabled = true; // Disable button during search

      try {
          const patientData = await apiService.fetchPatient(cin);
          console.log("Search Patient API Response:", patientData);

          if (patientData && patientData.data && patientData.data.ipp) {
              currentPatientInfo = patientData.data;
              currentIPP = currentPatientInfo.ipp; // Store IPP for potential printing

              const qrCodeData = generateQrData(currentIPP);

              let displayDate = "N/A";
              if (currentPatientInfo.date_naissance) {
                  // Assuming DB format is YYYY-MM-DD
                  const date = new Date(currentPatientInfo.date_naissance + 'T00:00:00Z'); // Treat as UTC midnight
                  if (!isNaN(date.getTime())) {
                      displayDate = date.toLocaleDateString('fr-MA', { day: '2-digit', month: '2-digit', year: 'numeric' }); // Format DD/MM/YYYY for Morocco locale
                  } else {
                      displayDate = sanitizeInput(currentPatientInfo.date_naissance); // Fallback
                  }
              }


              const patientHtml = `
                  <div class="patient-result-info">
                      <div class="info-group"><div class="info-label">Nom:</div><div class="info-value">${sanitizeInput(currentPatientInfo.nom)}</div></div>
                      <div class="info-group"><div class="info-label">Prénom:</div><div class="info-value">${sanitizeInput(currentPatientInfo.prenom)}</div></div>
                      <div class="info-group"><div class="info-label">CIN:</div><div class="info-value">${sanitizeInput(currentPatientInfo.cin)}</div></div>
                      <div class="info-group"><div class="info-label">Téléphone:</div><div class="info-value">${sanitizeInput(currentPatientInfo.telephone) || 'N/A'}</div></div>
                      <div class="info-group"><div class="info-label">Adresse:</div><div class="info-value">${sanitizeInput(currentPatientInfo.adresse) || 'N/A'}</div></div>
                      <div class="info-group"><div class="info-label">Ville:</div><div class="info-value">${sanitizeInput(currentPatientInfo.ville) || 'N/A'}</div></div>
                      <div class="info-group"><div class="info-label">Date Naissance:</div><div class="info-value">${displayDate}</div></div>
                      <div class="info-group"><div class="info-label">Sexe:</div><div class="info-value">${sanitizeInput(currentPatientInfo.sexe === 'M' ? 'Homme' : 'Femme')}</div></div>
                      <div class="info-group"><div class="info-label">Mutuelle:</div><div class="info-value">${sanitizeInput(currentPatientInfo.mutuelle || 'Non renseignée')}</div></div>
                      <div class="info-group"><div class="info-label">IPP:</div><div class="info-value">${sanitizeInput(currentIPP)}</div></div>
                  </div>
                  ${qrCodeData ? `
                  <div class="patient-result-qr">
                      <img src="${qrCodeData.qrImageUrl}" alt="QR Code pour IPP ${sanitizeInput(currentIPP)}" loading="lazy" />
                      <p style="font-size: 0.8rem; color: var(--gray-600);">Scannez pour accéder au dossier via l'appli mobile.</p>
                      <button onclick="printQRCode('${qrCodeData.qrImageUrl}')" class="btn btn-secondary btn-sm no-print"><i class="fas fa-print"></i> Imprimer QR</button>
                  </div>` : '<p class="text-center text-muted mt-3" style="font-size: 0.8rem;">QR Code indisponible (IPP manquant)</p>'}`;

              // Wrap the result in the standard container for consistent styling
              DOM.resultDiv.innerHTML = `<div class="patient-result-container">${patientHtml}</div>`;

          } else {
              // Patient not found or data structure invalid from API
              const message = patientData?.message || `Aucun patient trouvé avec le CIN ${sanitizeInput(cin)}.`;
              console.warn("Patient search:", message, patientData);
              DOM.resultDiv.innerHTML = `<div class="patient-result-container message message-warning"><i class="fas fa-exclamation-triangle me-2"></i> ${sanitizeInput(message)}</div>`;
          }
      } catch (error) {
          console.error("Search Patient Error:", error);
          // Display error within the result container
          DOM.resultDiv.innerHTML = `<div class="patient-result-container message message-error"><i class="fas fa-times-circle me-2"></i> Erreur lors de la recherche: ${sanitizeInput(error.message)}</div>`;
      } finally {
          DOM.searchButton.disabled = false; // Re-enable button after search completes or fails
          // Consider NOT clearing the input: cinInput.value = '';
      }
    }


    async function handleCreatePatient(event) {
      event.preventDefault();
      if (!validateCreateForm()) return; // Stop if validation fails

      showMessage('message', '<span class="loading-spinner"></span> Création du patient en cours...', 'loading');
      DOM.createPatientBtn.disabled = true;
      DOM.createResultDiv.style.display = 'none'; // Hide previous create result
      DOM.createPrintButton.disabled = true;

      // Ensure date is in YYYY-MM-DD format before sending
      let birthDateToSend = DOM.createForm.date_naissance.value; // Already in YYYY-MM-DD

      const payload = {
        nom: DOM.createForm.nom.value.trim(),
        prenom: DOM.createForm.prenom.value.trim(),
        cin: DOM.createForm.cin.value.trim().toUpperCase(), // Standardize CIN
        telephone: DOM.createForm.telephone.value.trim(),
        adresse: DOM.createForm.adresse.value.trim(),
        ville: DOM.createForm.ville.value.trim(),
        date_naissance: birthDateToSend,
        sexe: DOM.createForm.sexe.value,
        mutuelle: DOM.hasInsuranceCheckbox.checked ? DOM.mutuelleInput.value.trim() : null,
      };

      console.log("Payload for Create Patient:", payload);

      try {
        const response = await apiService.createPatient(payload);
        console.log("Create Patient API Response:", response);

        if (response && response.data && response.data.ipp) {
          currentIPP = response.data.ipp; // Store the new IPP
          const qrCodeData = generateQrData(currentIPP);

          if (qrCodeData) {
             // Show success message and QR in the dedicated createResult div
            showMessage('createResult', `Patient créé avec succès ! IPP: ${sanitizeInput(currentIPP)}`, 'success');
            DOM.createQrCodeImage.src = qrCodeData.qrImageUrl;
            DOM.createQrCodeImage.alt = `QR Code pour IPP ${currentIPP}`; // Add alt text
            DOM.createPrintButton.onclick = () => printQRCode(qrCodeData.qrImageUrl); // Assign print action

             // Clear the main form message area
            showMessage('message', '', '');
            DOM.createForm.reset(); // Reset form fields
            handleMutuelleChange(); // Reset mutuelle field state after form reset
            showToast('Patient créé avec succès !', 'success'); // Also show a toast

          } else {
            // Patient created but QR generation failed (should be rare if IPP exists)
            console.error("Patient created but QR generation failed for IPP:", currentIPP);
             showMessage('createResult', `Patient créé (IPP: ${sanitizeInput(currentIPP)}), mais une erreur est survenue lors de la génération du QR Code.`, 'warning');
             showMessage('message', '', ''); // Clear main message
             DOM.createForm.reset();
             handleMutuelleChange();
          }
        } else {
           // Handle cases where API indicated failure or returned unexpected structure
           const errorMessage = response?.message || "Réponse invalide ou erreur lors de la création par le serveur.";
           console.error("Create Patient Failed Logically:", errorMessage, response);
           throw new Error(errorMessage); // Throw error to be caught by the catch block
        }
      } catch (apiError) {
        console.error("Create Patient API Error Catch:", apiError);
        // Show error in the main message area below the form
        showMessage('message', `Erreur lors de la création du patient: ${apiError.message}`, 'error');
        DOM.createResultDiv.style.display = 'none'; // Ensure create result area is hidden on error
      } finally {
        DOM.createPatientBtn.disabled = false; // Re-enable button
      }
    }


    function handleMutuelleChange() {
      if (!DOM.hasInsuranceCheckbox || !DOM.mutuelleInput || !DOM.mutuelleInputContainer) {
          console.warn("Mutuelle elements not found in DOM."); return;
      }
      const isChecked = DOM.hasInsuranceCheckbox.checked;
      DOM.mutuelleInput.disabled = !isChecked;
      DOM.mutuelleInput.required = isChecked; // Make required only if checked
      DOM.mutuelleInputContainer.style.opacity = isChecked ? '1' : '0.6'; // Visual cue

      if (!isChecked) {
          DOM.mutuelleInput.value = ''; // Clear value if disabled/unchecked
          const mutuelleGroup = DOM.mutuelleInput.closest('.input-group'); // Find parent group
          if(mutuelleGroup) {
              mutuelleGroup.classList.remove('has-error'); // Remove error state if any
              DOM.mutuelleInput.classList.remove('input-error');
              const errorDiv = mutuelleGroup.querySelector('.error-text');
              if(errorDiv) {
                  errorDiv.textContent = '';
                  errorDiv.style.display = 'none';
              }
          }
      }
    }

    // --- Event Listeners ---
    DOM.searchButton?.addEventListener('click', handlePatientSearch);
    DOM.cinInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handlePatientSearch(); } }); // Prevent form submission if inside one
    DOM.createForm?.addEventListener('submit', handleCreatePatient);
    DOM.hasInsuranceCheckbox?.addEventListener('change', handleMutuelleChange);
    // ID Capture Listeners
    DOM.captureIdButton?.addEventListener('click', startIdCapture);
    DOM.takePhotoButton?.addEventListener('click', takePhotoAndExtract);
    DOM.cancelCaptureButton?.addEventListener('click', () => stopIdCapture(true)); // true clears blobs


    // --- Initial Setup ---
    window.onload = () => {
        console.log("Window loaded. Checking authentication...");
        // Set max date for birth date input to today
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('date_naissance');
        if(dateInput) {
           dateInput.max = today;
        }

        if (!localStorage.getItem(CONFIG.TOKEN_KEY)) {
            console.log("Reception: No token found. Redirecting to login.");
            redirectToLogin();
            return; // Stop further execution if not authenticated
        }
        DOM.body.classList.add('loaded');
        console.log("Reception: Authenticated. Setting up page.");
        resetSessionTimeout(); // Start session timeout
        handleMutuelleChange(); // Set initial state of mutuelle field
        // Add activity listeners to reset timeout for user activity
        ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'].forEach(event =>
            document.addEventListener(event, resetSessionTimeout, { passive: true })
        );
        console.log("Initial setup complete. Session timeout active.");
    };

  </script>
</body>
</html>
