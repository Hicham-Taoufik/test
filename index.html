<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Dashboard de réception pour la gestion des patients - MediClinic" />
  <title>Réception - MediClinic</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- Select2 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />
  <style>
    /* --- CSS (Includes styles for ID Capture) --- */
    :root { --primary: #5d74f2; --primary-light: #ebeffe; --primary-dark: #4a62d8; --success: #31c971; --success-light: #e0fbea; --success-dark: #28a960; --warning: #ffb648; --warning-light: #fff8ec; --danger: #ff5a5a; --danger-light: #ffeded; --gray-100: #f9fafb; --gray-200: #f1f3f9; --gray-300: #e5e7eb; --gray-400: #d1d5db; --gray-500: #9ca3af; --gray-600: #6b7280; --gray-700: #4b5563; --gray-800: #374151; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px rgba(0,0,0,0.04); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05); --shadow-focus: 0 0 0 3px rgba(93, 116, 242, 0.2); --border-radius: 0.5rem; --transition-speed: 0.2s; font-size: 15px; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.5; min-height: 100vh; padding: 0; visibility: hidden; }
    body.loaded { visibility: visible; animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .header { display: flex; align-items: center; padding: 15px 0; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--gray-200); }
    .header-main-content { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; }
    .logo { display: flex; align-items: center; }
    .logo-img { height: 38px; width: auto; margin-right: 10px; }
    .header-title { color: var(--gray-800); font-size: 1.4rem; font-weight: 600; margin: 0; white-space: nowrap; }
    .header-logout { flex-shrink: 0; margin-left: auto; }
    .logout-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: var(--border-radius); }
    .flex-row { display: flex; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .flex-col { flex: 1; min-width: 380px; }
    .card { background: #ffffff; padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow-md); margin-bottom: 1.5rem; transition: var(--transition); overflow: hidden; }
    .card:hover { box-shadow: var(--shadow-lg); }
    .card-header { padding: 0 0 1.25rem 0; margin-bottom: 1.25rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 1.15rem; font-weight: 600; color: var(--dark-color); margin: 0; display: flex; align-items: center; }
    .card-title i { margin-right: 0.5rem; font-size: 1.2rem; color: var(--primary-color); }
    .card-actions { color: white; background: var(--primary); border-radius: 0.5rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
    .card-body { /* Padding now applied to .card */ }
    label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--gray-600); font-weight: 500; }
    .input-group { margin-bottom: 1.25rem; position: relative; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 1rem; }
    input[type="text"], input[type="date"], input[type="tel"], input[type="email"], select { width: 100%; padding: 0.7rem 0.9rem; font-size: 0.9rem; border-radius: var(--border-radius); border: 1px solid #dfe3e8; background: white; transition: all var(--transition-speed) ease; font-family: 'Inter', sans-serif; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: var(--shadow-focus); }
    .input-error { border-color: var(--danger) !important; }
    .input-error:focus { box-shadow: 0 0 0 3px rgba(255, 90, 90, 0.2); }
    .error-text { color: var(--danger); font-size: 0.75rem; margin-top: 4px; display: none; }
    .input-group.has-error .error-text { display: block; }
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--gray-700); margin-bottom: 0; cursor: pointer; }
    .mutuelle-group { grid-column: span 2; display: flex; flex-direction: column; gap: 0.75rem; }
    .mutuelle-group > div:first-child { display: flex; align-items: center; }
    input[name="mutuelle"]:disabled { background-color: var(--gray-100); cursor: not-allowed; opacity: 0.7; border: 1px solid var(--gray-300); }
    .btn-group { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .btn { padding: 0.6rem 1.2rem; font-size: 0.85rem; font-weight: 500; border-radius: var(--border-radius); cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; width: auto; line-height: 1.5; border: 1px solid transparent; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: var(--primary-dark); } .btn-primary:disabled { background-color: var(--primary-light); border-color: var(--primary-light); cursor: not-allowed; }
    .btn-success { background: var(--success); color: white; } .btn-success:hover { background: var(--success-dark); }
    .btn-secondary { background: var(--gray-600); color: white; } .btn-secondary:hover { background: var(--gray-700); }
    .btn-outline { background: white; color: var(--primary); border: 1px solid var(--gray-300); } .btn-outline:hover { border-color: var(--primary); background: var(--primary-light); }
    .btn:disabled { background-color: var(--gray-300); cursor: not-allowed; opacity: 0.7; }
    .form-submit-button { grid-column: span 2; }
    .search-bar { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; }
    .search-bar input { flex-grow: 1; }
    .message { padding: 0.8rem 1rem; border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; font-weight: 500; display: none; grid-column: span 2; animation: fadeIn 0.3s ease; word-break: break-word; }
    .message-success { background: var(--success-light); color: var(--success-dark); border-left: 4px solid var(--success); }
    .message-warning { background: var(--warning-light); color: var(--warning); border-left: 4px solid var(--warning); }
    .message-error { background: var(--danger-light); color: var(--danger); border-left: 4px solid var(--danger); }
    .message-info { background: var(--primary-light); color: var(--primary-dark); border-left: 4px solid var(--primary); }
    #getResult { margin-top: 1.25rem; padding: 0; background-color: transparent; border-radius: 0; border-left: none; display: none; }
    .patient-result-container { background-color: var(--gray-100); padding: 1.25rem; border-radius: var(--border-radius); border-left: 4px solid var(--primary); animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .patient-result-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem 1rem; margin-bottom: 1rem; }
    .patient-result-info .info-group { margin-bottom: 0; }
    .info-group { margin-bottom: 5px; }
    .info-label { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px; }
    .info-value { font-size: 0.9rem; color: var(--gray-800); font-weight: 500; }
    .patient-result-qr { text-align: center; margin-top: 1.25rem; }
    .patient-result-qr img { max-width: 180px; display: block; margin: 0 auto 1rem auto; border: 1px solid var(--gray-300); padding: 5px; background: white; transition: transform 0.3s ease; }
    .patient-result-qr img:hover { transform: scale(1.03); }
    #createResult { display: none; margin-top: 1.25rem; text-align: center; background-color: var(--success-light); padding: 1rem; border-radius: var(--border-radius); border-left: 4px solid var(--success); animation: fadeIn 0.3s ease; }
    #createResult p { color: var(--success-dark); font-weight: 500; margin-bottom: 1rem;}
    #createResult img { max-width: 160px; display: block; margin: 0 auto 1rem auto; border: 1px solid var(--gray-300); padding: 5px; background: white; }
    .loading-spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-left: -2px; margin-right: 8px; }
    .btn .loading-spinner { border-top-color: white; }
    .btn-outline .loading-spinner { border-top-color: var(--primary); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--gray-800); color: white; padding: 0.8rem 1.25rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); display: flex; align-items: center; z-index: 1000; transform: translateY(120px); opacity: 0; transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1); }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background-color: var(--success-dark); }
    .toast.error { background-color: var(--danger); }
    .toast i { margin-right: 0.75rem; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; box-shadow: none; }
    .skip-link { position: absolute; left: -9999px; z-index: 999; padding: 1em; background-color: white; color: var(--primary); opacity: 0; }
    .skip-link:focus { left: 50%; transform: translateX(-50%); opacity: 1; }
    #idCaptureContainer { display: none; margin-top: 1rem; border: 1px dashed var(--gray-400); padding: 1rem; border-radius: var(--border-radius); background-color: var(--gray-100); text-align: center; }
    #idVideo { display: block; width: 100%; max-width: 400px; height: auto; margin: 0 auto 1rem auto; border: 1px solid var(--gray-300); background-color: #000; }
    #idCaptureContainer .btn-group { justify-content: center; }
    .capture-preview { max-width: 150px; height: auto; margin: 0 5px; border: 1px solid var(--gray-400); border-radius: 4px; }
    .capture-status { margin-top: 1rem; }
    @media (max-width: 768px) { .flex-row { flex-direction: column; } .form-grid { grid-template-columns: 1fr; } .mutuelle-group, .form-submit-button, .message { grid-column: span 1; } .patient-result-info { grid-template-columns: 1fr; } .header { flex-direction: column; align-items: flex-start; gap: 15px; } .header-main-content { width: 100%; } .header-logout { width: 100%; margin-left: 0; } .logout-btn { width: 100%; justify-content: center; } .search-bar { flex-direction: column; } .search-bar .btn { width: 100%; } }
    @media (max-width: 480px) { .app-container { padding: 1rem; } .header-title { font-size: 1.2rem; } .card { padding: 1rem; } .btn { padding: 0.6rem 1rem; font-size: 0.8rem; } .patient-info { grid-template-columns: 1fr; } .btn-group { gap: 0.5rem; } }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Passer au contenu principal</a>
  <div class="container">
    <div class="header">
      <div class="header-main-content">
        <div class="logo"> <img src="./clinique-nakhil-logo-horizontal.webp" alt="MediClinic Logo" class="logo-img"> </div>
        <h1 class="header-title">Réception</h1>
      </div>
      <div class="header-logout"> <button onclick="logout()" class="btn btn-outline logout-btn no-print" aria-label="Déconnexion"> <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion </button> </div>
    </div>

    <main id="main-content" class="flex-row">
      <div class="flex-col">
        <section class="card" aria-labelledby="create-patient-heading">
          <div class="card-header"> <h2 id="create-patient-heading" class="card-title"><i class="fas fa-user-plus" aria-hidden="true"></i> Créer un Patient</h2> <div class="card-actions" aria-hidden="true"><i class="fas fa-pen"></i></div> </div>
          <div class="card-body">

            <!-- ID Capture Section -->
            <div class="id-capture-section mb-4 no-print">
              <button id="captureIdButton" type="button" class="btn btn-primary"> <i class="fas fa-camera"></i> Scanner CIN </button>
              <div id="idCaptureContainer">
                  <p id="captureInstruction">Positionnez le RECTO de la CIN et prenez la photo.</p>
                  <video id="idVideo" playsinline></video>
                  <canvas id="idCanvas" style="display:none;"></canvas>
                   <div class="d-flex justify-content-center gap-2 my-2">
                        <img id="frontPreview" class="capture-preview" alt="Aperçu Recto" style="display: none;">
                        <img id="backPreview" class="capture-preview" alt="Aperçu Verso" style="display: none;">
                   </div>
                  <div class="btn-group mt-2">
                     <button id="takePhotoButton" type="button" class="btn btn-success" disabled> <i class="fas fa-camera-retro"></i> Prendre Photo </button>
                     <button id="cancelCaptureButton" type="button" class="btn btn-secondary" disabled> Annuler </button>
                  </div>
                  <div id="captureMessage" class="message message-info mt-2"></div>
              </div>
            </div>
             <!-- END ID Capture Section -->

            <form id="createForm" novalidate>
              <div class="form-grid">
                <div class="input-group"> <label for="nom">Nom <span aria-hidden="true">*</span></label> <input id="nom" name="nom" type="text" placeholder="Nom de famille" required aria-required="true" autocomplete="family-name"/> <div class="error-text">Veuillez entrer un nom</div> </div>
                <div class="input-group"> <label for="prenom">Prénom <span aria-hidden="true">*</span></label> <input id="prenom" name="prenom" type="text" placeholder="Prénom" required aria-required="true" autocomplete="given-name"/> <div class="error-text">Veuillez entrer un prénom</div> </div>
                <div class="input-group"> <label for="cin">CIN <span aria-hidden="true">*</span></label> <input id="cin" name="cin" type="text" placeholder="Ex: AB123456" required aria-required="true" pattern="^[A-Za-z]{1,2}\d{5,6}$"/> <div class="error-text">Format CIN invalide (ex: AB123456)</div> </div>
                <div class="input-group"> <label for="telephone">Téléphone <span aria-hidden="true">*</span></label> <input id="telephone" name="telephone" type="tel" placeholder="Ex: 0612345678" required aria-required="true" autocomplete="tel" pattern="^0[5-7]\d{8}$"/> <div class="error-text">Format téléphone invalide (0xxxxxxxx)</div> </div>
                <div class="input-group"> <label for="adresse">Adresse <span aria-hidden="true">*</span></label> <input id="adresse" name="adresse" type="text" placeholder="Adresse complète" required aria-required="true" autocomplete="address-line1"/> <div class="error-text">Veuillez entrer une adresse</div> </div>
                <div class="input-group"> <label for="ville">Ville <span aria-hidden="true">*</span></label> <input id="ville" name="ville" type="text" placeholder="Ville" required aria-required="true" autocomplete="address-level2"/> <div class="error-text">Veuillez entrer une ville</div> </div>
                <div class="input-group"> <label for="date_naissance">Date de Naissance <span aria-hidden="true">*</span></label> <input id="date_naissance" name="date_naissance" type="date" required aria-required="true" autocomplete="bday"/> <div class="error-text">Veuillez entrer une date valide</div> </div>
                <div class="input-group"> <label for="sexe">Sexe <span aria-hidden="true">*</span></label> <select id="sexe" name="sexe" required aria-required="true" autocomplete="sex"> <option value="M">Homme</option> <option value="F">Femme</option> </select> <div class="error-text">Veuillez sélectionner un sexe</div> </div>
                <div class="input-group mutuelle-group">
                  <label for="mutuelle">Mutuelle</label>
                  <select name="mutuelle" id="mutuelle" class="searchable-dropdown">
                    <option value="" disabled selected>Choisir une mutuelle</option>
                  </select>
                  <div class="error-text">Veuillez entrer le nom de la mutuelle</div>
                </div>
                <div class="form-submit-button"> <button type="submit" class="btn btn-success" id="createPatientBtn"> <i class="fas fa-plus-circle" aria-hidden="true"></i> Créer Patient </button> </div>
                <div id="message" class="message" role="alert" aria-live="polite"></div>
              </div>
            </form>
            <div id="createResult"> <p id="createResultMessage"></p> <img id="createQrCodeImage" src="" alt="" loading="lazy" /> <button id="createPrintButton" class="btn btn-secondary" disabled> <i class="fas fa-print" aria-hidden="true"></i> Imprimer QR Code </button> </div>
          </div>
        </section>
      </div>

      <div class="flex-col">
        <section class="card" aria-labelledby="search-patient-heading">
          <div class="card-header"> <h2 id="search-patient-heading" class="card-title"><i class="fas fa-search" aria-hidden="true"></i> Rechercher un Patient</h2> <div class="card-actions" aria-hidden="true"><i class="fas fa-users"></i></div> </div>
          <div class="card-body">
            <div class="search-bar"> <input id="getCin" type="text" placeholder="Entrer le CIN du patient" aria-label="Numéro CIN du patient"/> <button id="searchBtn" class="btn btn-primary"> <i class="fas fa-search" aria-hidden="true"></i> Rechercher </button> </div>
            <div id="getResult" role="region" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </main>

    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
  <script>
    // --- Configuration & Constants ---
    const CONFIG = { API_BASE_URL: 'https://workflows.aphelionxinnovations.com', QR_TARGET_BASE_URL: 'app://medilink/patient', LOGIN_PAGE_URL: 'https://hicham-taoufik.github.io/login/', TOKEN_KEY: 'authToken', SESSION_TIMEOUT: 30 * 60 * 1000, MESSAGE_DISPLAY_TIME: 7000, TOAST_DISPLAY_TIME: 4000 };
    const DOM = {
      body: document.body,
      resultDiv: document.getElementById("getResult"),
      messageDiv: document.getElementById("message"),
      createForm: document.getElementById("createForm"),
      createResultDiv: document.getElementById("createResult"),
      searchButton: document.getElementById("searchBtn"),
      cinInput: document.getElementById("getCin"),
      mutuelleInput: document.getElementById("mutuelle"),
      mutuelleInputContainer: document.getElementById("mutuelle-input-container"),
      createPatientBtn: document.getElementById("createPatientBtn"),
      createResultMessage: document.getElementById("createResultMessage"),
      createQrCodeImage: document.getElementById("createQrCodeImage"),
      createPrintButton: document.getElementById("createPrintButton"),
      toast: document.getElementById("toast"),
      captureIdButton: document.getElementById('captureIdButton'),
      idCaptureContainer: document.getElementById('idCaptureContainer'),
      idVideo: document.getElementById('idVideo'),
      takePhotoButton: document.getElementById('takePhotoButton'),
      cancelCaptureButton: document.getElementById('cancelCaptureButton'),
      captureMessage: document.getElementById('captureMessage'),
      idCanvas: document.getElementById('idCanvas'),
      frontPreview: document.getElementById('frontPreview'),
      backPreview: document.getElementById('backPreview'),
      captureInstruction: document.getElementById('captureInstruction')
    };
    let currentIPP = null; let currentPatientInfo = null; let sessionTimeoutId = null; let idCaptureStream = null; let frontImageBlob = null; let backImageBlob = null; let isCapturingFront = true;

    // --- Utility Functions ---
    function showToast(message, type = 'success') { 
      if (!message || !DOM.toast) return; 
      const icon = type === 'success' ? '<i class="fas fa-check-circle" aria-hidden="true"></i>' : '<i class="fas fa-exclamation-circle" aria-hidden="true"></i>'; 
      DOM.toast.innerHTML = `${icon} ${message}`; 
      DOM.toast.className = `toast ${type}`; 
      DOM.toast.classList.add('show'); 
      setTimeout(() => { DOM.toast.classList.remove('show'); }, CONFIG.TOAST_DISPLAY_TIME); 
    }
    function sanitizeInput(input) { 
      if (!input) return ''; 
      const temp = document.createElement('div'); 
      temp.textContent = input; 
      return temp.innerHTML; 
    }
    function showMessage(elementId, message, type) { 
      const el = document.getElementById(elementId); 
      if (!el) { console.error(`Msg Elem "${elementId}" not found.`); return; } 
      const statusIcons = {'info':'fas fa-info-circle','success':'fas fa-check-circle','warning':'fas fa-exclamation-triangle','error':'fas fa-times-circle','loading':'fas fa-spinner fa-spin'}; 
      const iconClass = statusIcons[type] || statusIcons['info']; 
      const iconHtml = message && type !== 'result' ? `<i class="${iconClass} me-2" aria-hidden="true"></i>` : ''; 
      el.innerHTML = message ? `${iconHtml}${message}` : ""; 
      el.style.display = message ? "block" : "none"; 
      el.className = ""; 
      if (type === 'result') {
      } else { 
        el.className = "message"; 
        if (type === "success") el.classList.add("message-success"); 
        else if (type === "warning") el.classList.add("message-warning"); 
        else if (type === "error") el.classList.add("message-error"); 
        else if (type === "info") el.classList.add("message-info"); 
      } 
      if(elementId === 'createResult') { 
        const isResult = type === 'result'; 
        const baseBg = isResult ? 'var(--success-light)' : (type === 'warning' ? 'var(--warning-light)' : (type === 'error' ? 'var(--danger-light)' : 'transparent')); 
        const baseBorder = isResult ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'transparent')); 
        const textColor = isResult ? 'var(--success-dark)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'inherit')); 
        el.style.backgroundColor = baseBg; 
        el.style.borderLeft = `4px solid ${baseBorder}`; 
        el.style.textAlign = 'center'; 
        el.style.marginTop = '20px'; 
        el.style.padding = '1rem'; 
        el.style.borderRadius = 'var(--border-radius)'; 
        const msgP = el.querySelector('#createResultMessage'); 
        const img = el.querySelector('#createQrCodeImage'); 
        const btn = el.querySelector('#createPrintButton'); 
        if(msgP) msgP.style.color = textColor; 
        if(img) img.style.display = isResult ? 'block' : 'none'; 
        if(btn) btn.style.display = isResult ? 'inline-block' : 'none'; 
      } 
      if (type !== 'error' && type !== 'warning' && type !== 'loading' && message && elementId === 'message') { 
        setTimeout(() => { 
          const currentElement = document.getElementById(elementId); 
          if (currentElement && currentElement.innerHTML && currentElement.innerHTML.includes(message)) { 
            currentElement.style.display = 'none'; 
          } 
        }, CONFIG.MESSAGE_DISPLAY_TIME); 
      } 
    }

    // --- Authentication & Session ---
    function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem(CONFIG.TOKEN_KEY);
      if (!token) {
        console.error('No token found. Redirecting to login.');
        alert('Session expirée. Veuillez vous reconnecter.');
        redirectToLogin();
        return Promise.reject(new Error('Token non trouvé.'));
      }
      resetSessionTimeout();
      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`,
      };
      if (options.body && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
      }
      return fetch(url, { ...options, headers })
        .then(response => {
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              console.error('Authentication error:', response.status);
              localStorage.removeItem(CONFIG.TOKEN_KEY);
              alert('Session invalide. Veuillez vous reconnecter.');
              redirectToLogin();
            }
            return response.text().then(text => {
              throw new Error(`Erreur ${response.status}: ${text || response.statusText}`);
            });
          }
          return response.json();
        })
        .catch(error => {
          console.error('Fetch error:', error);
          throw error;
        });
    }
    function redirectToLogin() { window.location.href = CONFIG.LOGIN_PAGE_URL; }
    function logout() { localStorage.removeItem(CONFIG.TOKEN_KEY); clearTimeout(sessionTimeoutId); showToast('Déconnecté.', 'success'); setTimeout(redirectToLogin, 1000); }
    function resetSessionTimeout() { if (sessionTimeoutId) clearTimeout(sessionTimeoutId); sessionTimeoutId = setTimeout(logout, CONFIG.SESSION_TIMEOUT); }

    // --- Form Validation ---
    function validateField(input, validationFn, errorMessage) { 
      const value = input.value.trim(); 
      const group = input.closest('.input-group'); 
      if (!group) return true; 
      const isValid = validationFn(value); 
      group.classList.toggle('has-error', !isValid); 
      input.classList.toggle('input-error', !isValid); 
      const errorDiv = group.querySelector('.error-text'); 
      if (errorDiv) errorDiv.textContent = isValid ? '' : errorMessage; 
      return isValid; 
    }
    function validateCreateForm() { 
      let isValid = true; 
      showMessage('message', '', ''); 
      DOM.createForm.querySelectorAll('.input-group.has-error').forEach(el => el.classList.remove('has-error')); 
      DOM.createForm.querySelectorAll('input, select').forEach(el => el.classList.remove('input-error')); 
      isValid &= validateField(DOM.createForm.nom, val => val.length > 0, "Nom requis"); 
      isValid &= validateField(DOM.createForm.prenom, val => val.length > 0, "Prénom requis"); 
      isValid &= validateField(DOM.createForm.cin, val => /^[A-Za-z]{1,2}\d{5,6}$/.test(val), "Format CIN invalide (ex: AB123456)"); 
      isValid &= validateField(DOM.createForm.telephone, val => /^0[5-7]\d{8}$/.test(val), "Format téléphone 0Xxxxxxxxx"); 
      isValid &= validateField(DOM.createForm.adresse, val => val.length > 0, "Adresse requise"); 
      isValid &= validateField(DOM.createForm.ville, val => val.length > 0, "Ville requise"); 
      isValid &= validateField(DOM.createForm.date_naissance, val => val !== '', "Date naissance requise"); 
      isValid &= validateField(DOM.createForm.sexe, val => val !== '', "Sélection sexe requise"); 
      isValid &= validateField(DOM.mutuelle, val => val.length > 0, "Nom mutuelle requis");
      if (!isValid) { 
        showMessage('message', 'Veuillez corriger les erreurs.', 'error'); 
        const firstError = DOM.createForm.querySelector('.input-error'); 
        if(firstError) firstError.focus(); 
      } 
      return !!isValid; 
    }

    // --- API Service ---
    const apiService = { 
      async fetchPatient(cin) { 
        try { 
          const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/get-patient?cin=${cin}`); 
          return await res.json(); 
        } catch (e) { 
          console.error("Pat fetch err:", e); 
          throw e; 
        } 
      }, 
      async createPatient(payload) { 
        try { 
          const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/create-patient`, { method: 'POST', body: JSON.stringify(payload) }); 
          return await res.json(); 
        } catch (e) { 
          console.error("Pat create err:", e); 
          throw e; 
        } 
      }, 
      async extractIdInfo(formData) { 
        try { 
          const res = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/extract-id-info`, { method: 'POST', body: formData }); 
          return await res.json(); 
        } catch (e) { 
          console.error("ID Extract err:", e); 
          throw e; 
        } 
      }, 
      async fetchMutuelles() { 
        try { 
          const data = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/get-mutuelles`); 
          if (data.success && Array.isArray(data.mutuelles)) { 
            populateMutuelleDropdown(data.mutuelles); 
          } else { 
            console.error('Failed to fetch mutuelles:', data); 
          } 
        } catch (error) { 
          console.error('Error fetching mutuelles:', error); 
        } 
      }
    };

    // --- QR Code Functions ---
    function generateQrData(ipp) { 
      if (!ipp) { 
        console.error("IPP missing QR."); 
        return null; 
      } 
      const qrTargetUrl = `${CONFIG.QR_TARGET_BASE_URL}?ipp=${encodeURIComponent(ipp)}`; 
      const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrTargetUrl)}&q=M`; 
      console.log("QR Target:", qrTargetUrl); 
      console.log("QR Image:", qrImageUrl); 
      return { qrTargetUrl, qrImageUrl }; 
    }
    function printQRCode(qrImageUrl) { 
      const printWindow = window.open('', '_blank', 'width=400,height=450'); 
      if (!printWindow) { 
        alert('Veuillez autoriser les pop-ups.'); 
        return; 
      } 
      printWindow.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Imprimer QR</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet"/><style>body{font-family:'Inter',sans-serif;text-align:center;margin:0;padding-top:20px} img.logo{display:block;width:60px;margin:0 auto 10px auto} img.qrcode{display:block;width:200px;height:200px;margin:0 auto 15px auto;border:1px solid #eee;padding:5px;background:white} button{display:none;} @media print{body{margin:5mm;-webkit-print-color-adjust:exact;print-color-adjust:exact} img.logo, img.qrcode{margin-bottom:8px}}</style></head><body><img src="./clinique-nakhil-logo-horizontal.webp" alt="Logo" class="logo" onerror="this.style.display='none'" /><img src="${qrImageUrl}" alt="QR Code" class="qrcode" /><script>let p=false;const a=()=>{if(!p){window.print();p=true;window.onafterprint=()=>window.close();setTimeout(()=>window.close(),1500)}};let i=document.querySelectorAll('img'),l=0,e=0,t=i.length;if(t===0)a();else{i.forEach(m=>{const c=()=>{if(l+e===t)a()};if(m.complete)l++,c();else{m.onload=()=>{l++;c();m.onerror=()=>{e++;c()}}});setTimeout(()=>{if(!p)a()},3000)}<\/script></body></html>`);
      printWindow.document.close(); 
    }

    // --- ID Capture Functions ---
    function updateCaptureMessage(message, type = 'info') { 
      showMessage('captureMessage', message, type); 
    }
    async function startIdCapture() { 
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { 
        updateCaptureMessage('Demande caméra...', 'loading'); 
        DOM.captureIdButton.disabled = true; 
        DOM.idCaptureContainer.style.display = 'block'; 
        DOM.frontPreview.style.display = 'none'; 
        DOM.backPreview.style.display = 'none'; 
        isCapturingFront = true; 
        DOM.captureInstruction.textContent = "Positionnez le RECTO et prenez la photo."; 
        try { 
          idCaptureStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } }); 
          DOM.idVideo.srcObject = idCaptureStream; 
          await DOM.idVideo.play(); 
          updateCaptureMessage('Caméra prête. Prenez la photo du RECTO.', 'info'); 
          DOM.takePhotoButton.disabled = false; 
          DOM.cancelCaptureButton.disabled = false; 
        } catch (err) { 
          updateCaptureMessage(`Erreur caméra: ${err.message}`, 'error'); 
          stopIdCapture(false); 
        } 
      } else { 
        alert("Accès caméra non supporté."); 
        updateCaptureMessage("Caméra non supportée.", 'error'); 
        DOM.captureIdButton.disabled = false;
      }
    }
    function stopIdCapture(clearBlobs = true) {
      if (idCaptureStream) {
        idCaptureStream.getTracks().forEach(track => track.stop());
      }
      DOM.idVideo.srcObject = null;
      DOM.idCaptureContainer.style.display = 'none';
      DOM.takePhotoButton.disabled = true;
      DOM.cancelCaptureButton.disabled = true;
      DOM.captureIdButton.disabled = false;
      idCaptureStream = null;
      updateCaptureMessage('', '');
      if (clearBlobs) {
        frontImageBlob = null;
        backImageBlob = null;
        DOM.frontPreview.src = '';
        DOM.backPreview.src = '';
        DOM.frontPreview.style.display = 'none';
        DOM.backPreview.style.display = 'none';
        console.log("ID Capture cancelled and blobs cleared.");
      }
    }
    async function takePhotoAndExtract() { 
      if (!idCaptureStream || !DOM.idVideo || DOM.idVideo.readyState < 2) { 
        updateCaptureMessage('Caméra non prête.', 'warning'); 
        return; 
      } 
      updateCaptureMessage('Capture et analyse...', 'loading'); 
      DOM.takePhotoButton.disabled = true; 
      DOM.cancelCaptureButton.disabled = true; 
      const canvas = DOM.idCanvas; 
      canvas.width = DOM.idVideo.videoWidth; 
      canvas.height = DOM.idVideo.videoHeight; 
      const context = canvas.getContext('2d'); 
      context.drawImage(DOM.idVideo, 0, 0, canvas.width, canvas.height); 
      canvas.toBlob(async (blob) => { 
        if (!blob) { 
          updateCaptureMessage('Erreur capture image.', 'error'); 
          stopIdCapture(); 
          return; 
        } 
        if (isCapturingFront) { 
          frontImageBlob = blob; 
          console.log("Recto captured"); 
          DOM.frontPreview.src = URL.createObjectURL(frontImageBlob); 
          DOM.frontPreview.style.display = 'inline-block'; 
          isCapturingFront = false; 
          DOM.captureInstruction.textContent = "Positionnez le VERSO et prenez la photo."; 
          updateCaptureMessage('Recto OK. Préparez le verso.', 'info'); 
          DOM.takePhotoButton.disabled = false; 
          DOM.cancelCaptureButton.disabled = false; 
        } else { 
          backImageBlob = blob; 
          console.log("Verso captured"); 
          DOM.backPreview.src = URL.createObjectURL(backImageBlob); 
          DOM.backPreview.style.display = 'inline-block'; 
          stopIdCapture(false); 
          updateCaptureMessage('Verso OK. Analyse en cours...', 'loading'); 
          if (frontImageBlob && backImageBlob) { 
            const formData = new FormData(); 
            formData.append('id_image_front', frontImageBlob, 'id_card_front.jpg'); 
            formData.append('id_image_back', backImageBlob, 'id_card_back.jpg'); 
            try { 
              const extractedData = await apiService.extractIdInfo(formData); 
              console.log("Extracted ID Data:", extractedData); 
              if (extractedData && extractedData.data) { 
                autofillCreateForm(extractedData); 
                showToast('Formulaire pré-rempli!', 'success'); 
                updateCaptureMessage('Données extraites!', 'success'); 
              } else { 
                const errorMessage = extractedData && extractedData.message ? extractedData.message : "Aucune donnée extraite."; 
                throw new Error(errorMessage); 
              } 
            } catch (error) { 
              console.error("Error extraction API call:", error); 
              updateCaptureMessage(`Erreur extraction: ${error.message}`, 'error'); 
            } finally { 
              frontImageBlob = null; 
              backImageBlob = null; 
            } 
          } else { 
            console.error("Missing blobs."); 
            updateCaptureMessage('Erreur: Images manquantes.', 'error'); 
          } 
        } 
      }, 'image/jpeg', 0.9); 
    }
    function autofillCreateForm(data) {
      const form = DOM.createForm;
      if (!form || !data || !data.data) {
        console.warn("Autofill failed: Form or data object missing.");
        return;
      }
      const extracted = data.data;
      console.log("Extracted from API for Autofill:", extracted);
      let formattedDateOfBirth = "";
      if (extracted.date_of_birth) {
        const originalDateString = extracted.date_of_birth;
        const dateParts = originalDateString.split('/');
        if (dateParts.length === 3) {
          const day = dateParts[0];
          const month = dateParts[1];
          const year = dateParts[2];
          formattedDateOfBirth = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
          console.log("Formatted date_of_birth:", formattedDateOfBirth);
        } else {
          console.warn("Date of birth format not as expected (DD/MM/YYYY):", originalDateString);
          formattedDateOfBirth = "";
        }
      } else {
          console.warn("Date of birth missing from extracted data.");
      }
      form.nom.value = extracted.last_name ?? '';
      form.prenom.value = extracted.first_name ?? '';
      form.cin.value = extracted.id_number ?? '';
      form.date_naissance.value = formattedDateOfBirth;
      form.adresse.value = extracted.address ?? '';
      form.ville.value = extracted.city ?? '';
      form.sexe.value = extracted.gender === 'F' ? 'F' : 'M';
      form.querySelectorAll('.input-group.has-error').forEach(el => el.classList.remove('has-error'));
      form.querySelectorAll('input, select').forEach(el => el.classList.remove('input-error'));
      form.querySelectorAll('.error-text').forEach(el => el.textContent = '');
      showMessage('message', 'Formulaire pré-rempli automatiquement. Veuillez vérifier les informations.', 'info');
    }

    // --- Event Handlers ---
    async function handlePatientSearch() {
      showMessage('getResult', '', ''); 
      const cinInput = DOM.cinInput;
      if (!cinInput) {
        console.error("Search CIN input not found");
        return;
      }
      const cin = cinInput.value.trim();
      if (!cin) {
        showMessage('getResult', 'Veuillez entrer un CIN pour la recherche.', 'warning');
        return;
      }
      showMessage('getResult', '<span class="loading-spinner"></span> Recherche patient...', 'info');
      DOM.getResult.style.display = 'block';
      try {
        const patientData = await apiService.fetchPatient(cin);
        if (patientData && patientData.data) {
          currentPatientInfo = patientData.data;
          currentIPP = currentPatientInfo.ipp;
          if (!currentIPP) {
              console.warn("IPP not found in patient data for CIN:", cin);
          }
          const qrCodeData = generateQrData(currentIPP);
          let displayDate = "N/A";
          if (currentPatientInfo.date_naissance) {
              const dateParts = currentPatientInfo.date_naissance.split('-');
              if (dateParts.length === 3) {
                  displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
              } else {
                  displayDate = sanitizeInput(currentPatientInfo.date_naissance);
              }
          }
          const qrCodeHTML = `<div class="patient-result-container">
                                  <div class="patient-result-info">
                                      <div class="info-group"><div class="info-label">Nom:</div><div class="info-value">${sanitizeInput(currentPatientInfo.nom)}</div></div>
                                      <div class="info-group"><div class="info-label">Prénom:</div><div class="info-value">${sanitizeInput(currentPatientInfo.prenom)}</div></div>
                                      <div class="info-group"><div class="info-label">CIN:</div><div class="info-value">${sanitizeInput(currentPatientInfo.cin)}</div></div>
                                      <div class="info-group"><div class="info-label">Téléphone:</div><div class="info-value">${sanitizeInput(currentPatientInfo.telephone)}</div></div>
                                      <div class="info-group"><div class="info-label">Adresse:</div><div class="info-value">${sanitizeInput(currentPatientInfo.adresse)}</div></div>
                                      <div class="info-group"><div class="info-label">Ville:</div><div class="info-value">${sanitizeInput(currentPatientInfo.ville)}</div></div>
                                      <div class="info-group"><div class="info-label">Date Naissance:</div><div class="info-value">${displayDate}</div></div>
                                      <div class="info-group"><div class="info-label">Sexe:</div><div class="info-value">${sanitizeInput(currentPatientInfo.sexe === 'M' ? 'Homme' : 'Femme')}</div></div>
                                      <div class="info-group"><div class="info-label">Mutuelle:</div><div class="info-value">${sanitizeInput(currentPatientInfo.mutuelle || 'N/A')}</div></div>
                                      <div class="info-group"><div class="info-label">IPP:</div><div class="info-value">${sanitizeInput(currentIPP || 'N/A')}</div></div>
                                  </div>
                                  ${qrCodeData ? `
                                  <div class="patient-result-qr">
                                      <img src="${qrCodeData.qrImageUrl}" alt="QR Code Patient" loading="lazy" />
                                      <p>Scannez ce QR Code avec l'appli patient pour accéder à votre dossier médical.</p>
                                      <button onclick="printQRCode('${qrCodeData.qrImageUrl}')" class="btn btn-secondary btn-sm"><i class="fas fa-print"></i> Imprimer QR</button>
                                  </div>` : '<p class="text-center text-muted mt-3">QR Code non généré (IPP manquant)</p>'}
                               </div>`;
          DOM.getResult.innerHTML = qrCodeHTML;
        } else {
          showMessage('getResult', 'Patient non trouvé.', 'warning');
          DOM.getResult.innerHTML = '<div class="patient-result-container"><p>Patient non trouvé.</p></div>';
        }
      } catch (error) {
        showMessage('getResult', `Erreur recherche patient: ${error.message}`, 'error');
        DOM.getResult.innerHTML = `<div class="patient-result-container"><p class="message message-error">Erreur: ${error.message}</p></div>`;
      }
    }

    async function handleCreatePatient(event) {
      event.preventDefault();
      if (!validateCreateForm()) return;
      showMessage('message', '<span class="loading-spinner"></span> Création patient...', 'loading');
      DOM.createPatientBtn.disabled = true;
      DOM.createResultDiv.style.display = 'none';
      DOM.createPrintButton.disabled = true;
      let birthDateToSend = DOM.createForm.date_naissance.value;
      const payload = {
        nom: DOM.createForm.nom.value.trim(),
        prenom: DOM.createForm.prenom.value.trim(),
        cin: DOM.createForm.cin.value.trim(),
        telephone: DOM.createForm.telephone.value.trim(),
        adresse: DOM.createForm.adresse.value.trim(),
        ville: DOM.createForm.ville.value.trim(),
        date_naissance: birthDateToSend,
        sexe: DOM.createForm.sexe.value,
        mutuelle: DOM.mutuelle.value.trim()
      };
      console.log("Payload for Create Patient:", payload);
      try {
        const response = await apiService.createPatient(payload);
        console.log("Create Patient API Response:", response);
        if (response && response.data && response.data.ipp) {
          currentIPP = response.data.ipp;
          const qrCodeData = generateQrData(currentIPP);
          if (qrCodeData) {
            showMessage('createResult', 'Patient créé avec succès !', 'result');
            DOM.createQrCodeImage.src = qrCodeData.qrImageUrl;
            DOM.createPrintButton.disabled = false;
            DOM.createPrintButton.onclick = () => printQRCode(qrCodeData.qrImageUrl);
            DOM.createForm.reset();
          } else {
            showMessage('createResult', `Patient créé (IPP: ${currentIPP}), mais erreur QR Code.`, 'warning');
            DOM.createForm.reset();
          }
        } else {
           const errorMessage = response?.message || "Erreur inconnue lors de la création du patient.";
           throw new Error(errorMessage);
        }
      } catch (apiError) {
        console.error("Create Patient API Error:", apiError);
        showMessage('message', `Erreur création patient: ${apiError.message}`, 'error');
        DOM.createResultDiv.style.display = 'none';
      } finally {
        DOM.createPatientBtn.disabled = false;
      }
    }

    // --- Event Listeners ---
    DOM.searchButton?.addEventListener('click', handlePatientSearch);
    DOM.cinInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handlePatientSearch(); });
    DOM.createForm?.addEventListener('submit', handleCreatePatient);
    DOM.captureIdButton?.addEventListener('click', startIdCapture);
    DOM.takePhotoButton?.addEventListener('click', takePhotoAndExtract);
    DOM.cancelCaptureButton?.addEventListener('click', () => stopIdCapture(true));

    // --- Initial Setup ---
    window.onload = () => {
        console.log("Window loaded. Checking authentication...");
        if (!localStorage.getItem(CONFIG.TOKEN_KEY)) {
            console.log("Reception: No token found. Redirecting to login.");
            redirectToLogin();
            return;
        }
        DOM.body.classList.add('loaded');
        console.log("Reception: Authenticated. Setting up page.");
        resetSessionTimeout();
        ['mousemove', 'keypress', 'click', 'scroll'].forEach(event =>
            document.addEventListener(event, resetSessionTimeout, { passive: true })
        );
        console.log("Initial setup complete.");
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const mutuelleDropdown = document.getElementById('mutuelle');
      async function fetchMutuelles() {
        try {
          const data = await fetchWithAuth(`${CONFIG.API_BASE_URL}/webhook/get-mutuelles`);
          if (data.success && Array.isArray(data.mutuelles)) {
            populateMutuelleDropdown(data.mutuelles);
          } else {
            console.error('Failed to fetch mutuelles:', data);
          }
        } catch (error) {
          console.error('Error fetching mutuelles:', error);
        }
      }
      function populateMutuelleDropdown(mutuelles) {
        mutuelleDropdown.innerHTML = '<option value="" disabled selected>Choisir une mutuelle</option>';
        mutuelles.forEach(mutuelle => {
          const option = document.createElement('option');
          option.value = mutuelle;
          option.textContent = mutuelle;
          mutuelleDropdown.appendChild(option);
        });
        $(mutuelleDropdown).select2({
          placeholder: 'Choisir une mutuelle',
          allowClear: true,
          width: '100%'
        });
      }
      fetchMutuelles();
    });
  </script>
</body>
</html>
