<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta
      name="description"
      content="Dashboard de réception pour la gestion des patients - MediClinic"
    />
    <title>Réception - MediClinic</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css"
      rel="stylesheet"
    />
  <link rel="stylesheet" href="style.css">
  <script src="script.js" defer></script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Passer au contenu principal</a>
    <div class="container">
      <div class="header">
        <div class="header-main-content">
          <div class="logo">
            <img
              src="./clinique-nakhil-logo-horizontal.webp"
              alt="MediClinic Logo"
              class="logo-img"
            />
          </div>
          <h1 class="header-title">Réception</h1>
        </div>
        <div class="header-logout">
          <button
            onclick="logout()"
            class="btn btn-outline logout-btn no-print"
            aria-label="Déconnexion"
          >
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion
          </button>
        </div>
      </div>

      <main id="main-content" class="flex-row">
        <div class="flex-col">
          <section class="card" aria-labelledby="create-patient-heading">
            <div class="card-header">
              <h2 id="create-patient-heading" class="card-title">
                <i class="fas fa-user-plus" aria-hidden="true"></i> Créer un
                Patient
              </h2>
              <div class="card-actions" aria-hidden="true">
                <i class="fas fa-pen"></i>
              </div>
            </div>
            <div class="card-body">
              <!-- ID Capture Section -->
              <div class="id-capture-section mb-4 no-print">
                <button
                  id="captureIdButton"
                  type="button"
                  class="btn btn-primary"
                >
                  <i class="fas fa-camera"></i> Scanner CIN
                </button>
                <div id="idCaptureContainer">
                  <p id="captureInstruction">
                    Positionnez le RECTO de la CIN et prenez la photo.
                  </p>
                  <video id="idVideo" playsinline></video>
                  <canvas id="idCanvas" style="display: none"></canvas>
                  <div class="d-flex justify-content-center gap-2 my-2">
                    <img
                      id="frontPreview"
                      class="capture-preview"
                      alt="Aperçu Recto"
                      style="display: none"
                    />
                    <img
                      id="backPreview"
                      class="capture-preview"
                      alt="Aperçu Verso"
                      style="display: none"
                    />
                  </div>
                  <div class="btn-group mt-2">
                    <button
                      id="takePhotoButton"
                      type="button"
                      class="btn btn-success"
                      disabled
                    >
                      <i class="fas fa-camera-retro"></i> Prendre Photo
                    </button>
                    <button
                      id="cancelCaptureButton"
                      type="button"
                      class="btn btn-secondary"
                      disabled
                    >
                      Annuler
                    </button>
                  </div>
                  <div
                    id="captureMessage"
                    class="message message-info mt-2"
                  ></div>
                </div>
              </div>
              <!-- END ID Capture Section -->

              <form id="createForm" novalidate>
                <div class="form-grid">
                  <div class="input-group">
                    <label for="nom"
                      >Nom <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="nom"
                      name="nom"
                      type="text"
                      placeholder="Nom de famille"
                      required
                      aria-required="true"
                      autocomplete="family-name"
                    />
                    <div class="error-text">Veuillez entrer un nom</div>
                  </div>
                  <div class="input-group">
                    <label for="prenom"
                      >Prénom <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="prenom"
                      name="prenom"
                      type="text"
                      placeholder="Prénom"
                      required
                      aria-required="true"
                      autocomplete="given-name"
                    />
                    <div class="error-text">Veuillez entrer un prénom</div>
                  </div>
                  <div class="input-group">
                    <label for="cin"
                      >CIN <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="cin"
                      name="cin"
                      type="text"
                      placeholder="Ex: AB123456"
                      required
                      aria-required="true"
                      pattern="^[A-Za-z]{1,2}\d{5,6}$"
                    />
                    <div class="error-text">
                      Format CIN invalide (ex: AB123456)
                    </div>
                  </div>
                  <div class="input-group">
                    <label for="telephone"
                      >Téléphone <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="telephone"
                      name="telephone"
                      type="tel"
                      placeholder="Ex: 0612345678"
                      required
                      aria-required="true"
                      autocomplete="tel"
                      pattern="^0[5-7]\d{8}$"
                    />
                    <div class="error-text">
                      Format téléphone invalide (0Xxxxxxxxx)
                    </div>
                  </div>
                  <div class="input-group">
                    <label for="adresse"
                      >Adresse <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="adresse"
                      name="adresse"
                      type="text"
                      placeholder="Adresse complète"
                      required
                      aria-required="true"
                      autocomplete="address-line1"
                    />
                    <div class="error-text">Veuillez entrer une adresse</div>
                  </div>
                  <div class="input-group">
                    <label for="ville"
                      >Ville <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="ville"
                      name="ville"
                      type="text"
                      placeholder="Ville"
                      required
                      aria-required="true"
                      autocomplete="address-level2"
                    />
                    <div class="error-text">Veuillez entrer une ville</div>
                  </div>
                  <div class="input-group">
                    <label for="date_naissance"
                      >Date de Naissance
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      id="date_naissance"
                      name="date_naissance"
                      type="date"
                      required
                      aria-required="true"
                      autocomplete="bday"
                    />
                    <div class="error-text">
                      Veuillez entrer une date valide
                    </div>
                  </div>
                  <div class="input-group">
                    <label for="sexe"
                      >Sexe <span aria-hidden="true">*</span></label
                    >
                    <select
                      id="sexe"
                      name="sexe"
                      required
                      aria-required="true"
                      autocomplete="sex"
                    >
                      <option value="" disabled selected>Choisir...</option> <!-- Added placeholder -->
                      <option value="M">Homme</option>
                      <option value="F">Femme</option>
                    </select>
                    <div class="error-text">Veuillez sélectionner un sexe</div>
                  </div>
                  <!-- Updated Mutuelle Dropdown -->
                  <div class="input-group mutuelle-group">
                    <label for="mutuelle">Mutuelle</label>
                    <select name="mutuelle" id="mutuelle" class="form-select">
                      <option value="" disabled selected>
                        Choisir une mutuelle...
                      </option>
                       <!-- Options populated by JS -->
                    </select>
                    <div class="error-text">
                      Veuillez choisir une mutuelle (si applicable)
                    </div>
                  </div>
                  <!-- New Doctor Dropdown -->
                  <div class="input-group">
                    <label for="doctor">Médecin</label>
                    <select name="doctor" id="doctor" class="form-select">
                      <option value="" disabled selected>
                        Choisir un médecin...
                      </option>
                       <!-- Options populated by JS -->
                    </select>
                    <div class="error-text">Veuillez choisir un médecin</div>
                  </div>
                  <!-- End Doctor Dropdown -->

                  <div class="form-submit-button">
                    <button
                      type="submit"
                      class="btn btn-success"
                      id="createPatientBtn"
                    >
                      <i class="fas fa-plus-circle" aria-hidden="true"></i>
                      Créer Patient & Démarrer Visite <!-- Updated Text -->
                    </button>
                  </div>
                  <div
                    id="message"
                    class="message"
                    role="alert"
                    aria-live="polite"
                  ></div>
                </div>
              </form>
              <div id="createResult">
                <p id="createResultMessage"></p>
                <img id="createQrCodeImage" src="" alt="" loading="lazy" />
                <button
                  id="createPrintButton"
                  class="btn btn-secondary"
                  disabled
                >
                  <i class="fas fa-print" aria-hidden="true"></i> Imprimer QR
                  Code
                </button>
              </div>
            </div>
          </section>
        </div>

        <div class="flex-col">
          <section class="card" aria-labelledby="search-patient-heading">
            <div class="card-header">
              <h2 id="search-patient-heading" class="card-title">
                <i class="fas fa-search" aria-hidden="true"></i> Rechercher un
                Patient
              </h2>
              <div class="card-actions" aria-hidden="true">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="card-body">
              <div class="search-bar">
                <input
                  id="getCin"
                  type="text"
                  placeholder="Entrer le CIN du patient"
                  aria-label="Numéro CIN du patient"
                />
                <button id="searchBtn" class="btn btn-primary">
                  <i class="fas fa-search" aria-hidden="true"></i> Rechercher & Démarrer Visite <!-- Updated Text -->
                </button>
              </div>
              <div id="getResult" role="region" aria-live="polite"></div>
            </div>
          </section>
        </div>
      </main>

      <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
    <script>
      // --- Configuration & Constants ---
      const CONFIG = {
        API_BASE_URL: "https://workflows.aphelionxinnovations.com",
        QR_TARGET_BASE_URL: "app://medilink/patient",
        LOGIN_PAGE_URL: "https://hicham-taoufik.github.io/login/", // Absolute URL
        TOKEN_KEY: "authToken",
        SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutes
        MESSAGE_DISPLAY_TIME: 7000,
        TOAST_DISPLAY_TIME: 4000,
        // Define Endpoint Paths
        CREATE_PATIENT_ENDPOINT: "/webhook/create-patient",
        GET_PATIENT_ENDPOINT: "/webhook/get-patient", // By CIN
        EXTRACT_ID_ENDPOINT: "/webhook/extract-id-info",
        GET_MUTUELLES_ENDPOINT: "/webhook/get-mutuelles",
        GET_DOCTORS_ENDPOINT: "/webhook/get-doctors",
        START_VISIT_ENDPOINT: "/webhook/start-visit", // New endpoint
      };
      const DOM = {
        body: document.body,
        resultDiv: document.getElementById("getResult"),
        messageDiv: document.getElementById("message"),
        createForm: document.getElementById("createForm"),
        createResultDiv: document.getElementById("createResult"),
        searchButton: document.getElementById("searchBtn"),
        cinInput: document.getElementById("getCin"),
        mutuelleInput: document.getElementById("mutuelle"),
        doctorInput: document.getElementById("doctor"), // Corrected reference
        createPatientBtn: document.getElementById("createPatientBtn"),
        createResultMessage: document.getElementById("createResultMessage"),
        createQrCodeImage: document.getElementById("createQrCodeImage"),
        createPrintButton: document.getElementById("createPrintButton"),
        toast: document.getElementById("toast"),
        captureIdButton: document.getElementById("captureIdButton"),
        idCaptureContainer: document.getElementById("idCaptureContainer"),
        idVideo: document.getElementById("idVideo"),
        takePhotoButton: document.getElementById("takePhotoButton"),
        cancelCaptureButton: document.getElementById("cancelCaptureButton"),
        captureMessage: document.getElementById("captureMessage"),
        idCanvas: document.getElementById("idCanvas"),
        frontPreview: document.getElementById("frontPreview"),
        backPreview: document.getElementById("backPreview"),
        captureInstruction: document.getElementById("captureInstruction"),
      };
      let currentIPP = null; // Keep track of the IPP after creation/search
      // let currentPatientInfo = null; // Less necessary now, we mostly need IPP
      let sessionTimeoutId = null;
      let idCaptureStream = null;
      let frontImageBlob = null;
      let backImageBlob = null;
      let isCapturingFront = true;

      // --- Utility Functions ---
      function showToast(message, type = "success") {
        if (!message || !DOM.toast) return;
        const icon =
          type === "success"
            ? '<i class="fas fa-check-circle" aria-hidden="true"></i>'
            : '<i class="fas fa-exclamation-circle" aria-hidden="true"></i>';
        DOM.toast.innerHTML = `${icon} ${message}`;
        DOM.toast.className = `toast ${type}`;
        DOM.toast.classList.add("show");
        setTimeout(() => {
          DOM.toast.classList.remove("show");
        }, CONFIG.TOAST_DISPLAY_TIME);
      }

      function sanitizeInput(input) {
        if (input === null || input === undefined) return "";
        const temp = document.createElement("div");
        temp.textContent = String(input); // Ensure input is a string
        return temp.innerHTML;
      }

      function showMessage(elementId, message, type = 'info') {
        const el = document.getElementById(elementId);
        if (!el) { console.error(`showMessage Error: Element ID "${elementId}" not found.`); return; }

        const statusIcons = { 'info':'fas fa-info-circle','success':'fas fa-check-circle','warning':'fas fa-exclamation-triangle','error':'fas fa-times-circle','loading':'fas fa-spinner fa-spin' };
        const iconClass = statusIcons[type] || statusIcons['info'];
        const iconHtml = message && type !== 'result' ? `<i class="${iconClass}" style="margin-right: 6px;" aria-hidden="true"></i>` : '';

        el.innerHTML = message ? `${iconHtml}${message}` : "";
        el.style.display = message ? "block" : "none";
        el.className = ""; // Reset classes first

        if (type === 'result') {
            // Specific styling for #getResult if needed, otherwise handled by container
        } else if (elementId === 'createResult') {
            const isResult = type === 'result'; // Assuming 'result' means QR code display
            const baseBg = isResult ? 'var(--success-light)' : (type === 'warning' ? 'var(--warning-light)' : (type === 'error' ? 'var(--danger-light)' : 'transparent'));
            const baseBorder = isResult ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'transparent'));
            const textColor = isResult ? 'var(--success-dark)' : (type === 'warning' ? 'var(--warning)' : (type === 'error' ? 'var(--danger)' : 'inherit'));

            el.style.backgroundColor = baseBg;
            el.style.borderLeft = `4px solid ${baseBorder}`;
            el.style.textAlign = 'center';
            el.style.marginTop = '20px';
            el.style.padding = '1rem';
            el.style.borderRadius = 'var(--border-radius)';

            const msgP = el.querySelector('#createResultMessage');
            const img = el.querySelector('#createQrCodeImage');
            const btn = el.querySelector('#createPrintButton');

            if (msgP) {
                msgP.style.color = textColor;
                msgP.textContent = message ? message : ''; // Use textContent for the message part
            }
            if (img) img.style.display = isResult ? 'block' : 'none';
            if (btn) btn.style.display = isResult ? 'inline-block' : 'none';
        } else {
            // General message styling
            el.className = "message";
            if (type) {
                el.classList.add(`message-${type}`);
            }
        }

         // Auto-hide for non-persistent messages
         if (type !== 'error' && type !== 'result' && type !== 'loading' && message && elementId === 'message') {
            setTimeout(() => {
                const currentElement = document.getElementById(elementId);
                // Check if the message content is still the same before hiding
                if (currentElement && currentElement.innerHTML && currentElement.innerHTML.includes(message)) {
                    currentElement.style.display = 'none';
                }
            }, CONFIG.MESSAGE_DISPLAY_TIME);
        }
    }

      // --- Authentication & Session ---
      function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem(CONFIG.TOKEN_KEY);
        if (!token) {
          console.error("No token found. Redirecting to login.");
          alert("Session expirée. Veuillez vous reconnecter.");
          redirectToLogin();
          return Promise.reject(new Error("Token non trouvé."));
        }
        resetSessionTimeout(); // Reset timeout on authenticated request
        const headers = {
          ...options.headers,
          Authorization: `Bearer ${token}`,
        };
        // Set Content-Type for JSON if body exists and is not FormData
        if (options.body && !(options.body instanceof FormData)) {
          headers["Content-Type"] = "application/json";
        } else if (options.body instanceof FormData) {
            // Let the browser set the Content-Type for FormData
            delete headers['Content-Type'];
        }

        return fetch(url, { ...options, headers })
          .then(async (response) => { // Added async here
            if (!response.ok) {
              if (response.status === 401 || response.status === 403) {
                console.error("Authentication error:", response.status);
                localStorage.removeItem(CONFIG.TOKEN_KEY);
                alert("Session invalide. Veuillez vous reconnecter.");
                redirectToLogin();
                // Throw an error to stop promise chain
                throw new Error(`Authentication Failed: ${response.status}`);
              }
              // Try to get more specific error from response body
              const errorText = await response.text();
              console.error(`API Error ${response.status}: ${errorText || response.statusText}`);
              throw new Error(
                `Erreur ${response.status}: ${errorText || response.statusText}`
              );
            }
            // Check if response has content before trying to parse JSON
             const contentType = response.headers.get("content-type");
             if (contentType && contentType.indexOf("application/json") !== -1) {
                 return response.json(); // Parse JSON only if header indicates it
             } else {
                 return response.text(); // Otherwise return text (or handle as needed)
             }
          })
          .catch((error) => {
            // Avoid duplicate logging if already logged above
            if (!error.message.startsWith('Authentication Failed')) {
                 console.error("Fetch error caught:", error);
            }
            // Re-throw the error so calling functions know it failed
            throw error;
          });
      }
      function redirectToLogin() {
        window.location.href = CONFIG.LOGIN_PAGE_URL;
      }
      function logout() {
        localStorage.removeItem(CONFIG.TOKEN_KEY);
        clearTimeout(sessionTimeoutId);
        showToast("Déconnecté.", "success");
        setTimeout(redirectToLogin, 1000);
      }
      function resetSessionTimeout() {
        if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
        sessionTimeoutId = setTimeout(logout, CONFIG.SESSION_TIMEOUT);
      }

      // --- Form Validation ---
      function validateField(input, validationFn, errorMessage) {
        if (!input) return true; // Skip if element doesn't exist
        const value = input.value.trim();
        const group = input.closest(".input-group");
        if (!group) return true; // Skip if structure is wrong
        const isValid = validationFn(value);
        group.classList.toggle("has-error", !isValid);
        input.classList.toggle("input-error", !isValid);
        const errorDiv = group.querySelector(".error-text");
        if (errorDiv) errorDiv.textContent = isValid ? "" : errorMessage;
        return isValid;
      }
      function validateCreateForm() {
        let isValid = true;
        showMessage("message", "", ""); // Clear general message
        // Clear previous errors
        DOM.createForm?.querySelectorAll(".input-group.has-error")
          .forEach((el) => el.classList.remove("has-error"));
        DOM.createForm?.querySelectorAll("input, select")
          .forEach((el) => el.classList.remove("input-error"));

        // Validate required fields
        isValid &= validateField(DOM.createForm.nom, val => val.length > 0, "Nom requis");
        isValid &= validateField(DOM.createForm.prenom, val => val.length > 0, "Prénom requis");
        isValid &= validateField(DOM.createForm.cin, val => /^[A-Za-z]{1,2}\d{5,6}$/.test(val) || val === '', "Format CIN invalide (ex: AB123456)"); // Allow empty if not strictly required?
        isValid &= validateField(DOM.createForm.telephone, val => /^0[5-7]\d{8}$/.test(val), "Format téléphone 0Xxxxxxxxx requis");
        isValid &= validateField(DOM.createForm.adresse, val => val.length > 0, "Adresse requise");
        isValid &= validateField(DOM.createForm.ville, val => val.length > 0, "Ville requise");
        isValid &= validateField(DOM.createForm.date_naissance, val => val !== '', "Date naissance requise");
        isValid &= validateField(DOM.createForm.sexe, val => val !== '', "Sélection sexe requise");

        // Validate optional fields only if needed (adjust validation function if they can be empty)
        // isValid &= validateField(DOM.mutuelleInput, val => true, ""); // Example: Always valid if optional
        // isValid &= validateField(DOM.doctorInput, val => true, "");   // Example: Always valid if optional

        if (!isValid) {
          showMessage("message", "Veuillez corriger les erreurs.", "error");
          const firstError = DOM.createForm.querySelector(".input-error");
          firstError?.focus(); // Use optional chaining
        }
        return !!isValid; // Ensure boolean return
      }

      // --- API Service ---
      const apiService = {
            async fetchPatient(cin) {
                // N8N returns array directly, no top-level 'data' key needed
                return await fetchWithAuth(`${CONFIG.API_BASE_URL}${CONFIG.GET_PATIENT_ENDPOINT}?cin=${encodeURIComponent(cin)}`);
            },
            async createPatient(payload) {
                // N8N returns object, check for success flag if present
                 return await fetchWithAuth(`${CONFIG.API_BASE_URL}${CONFIG.CREATE_PATIENT_ENDPOINT}`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
            },
            async extractIdInfo(formData) {
                 return await fetchWithAuth(`${CONFIG.API_BASE_URL}${CONFIG.EXTRACT_ID_ENDPOINT}`, {
                    method: 'POST',
                    body: formData
                });
            },
             async fetchMutuelles() {
                return await fetchWithAuth(`${CONFIG.API_BASE_URL}${CONFIG.GET_MUTUELLES_ENDPOINT}`);
            },
             async fetchDoctors() {
                 return await fetchWithAuth(`${CONFIG.API_BASE_URL}${CONFIG.GET_DOCTORS_ENDPOINT}`);
            },
            async startVisit(ipp) {
                if (!ipp) {
                    console.error("startVisit called without IPP.");
                    throw new Error("IPP du patient manquant pour démarrer la visite.");
                }
                console.log(`Attempting to start visit for IPP: ${ipp}`);
                try {
                    const payload = { ipp: ipp };
                    const response = await fetchWithAuth(`${CONFIG.API_BASE_URL}${CONFIG.START_VISIT_ENDPOINT}`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    console.log("Start Visit API Response:", response);
                     // Assuming response structure is { success: true, visit_id: ..., message: ... }
                     if (!response || response.success === false) { // Check for explicit false success
                         throw new Error(response.message || "Échec du démarrage de la visite via API.");
                     }
                    return response;
                } catch (e) {
                    console.error("Start visit API err:", e);
                    throw e;
                }
            }
        };

      // --- QR Code Functions ---
      function generateQrData(ipp) {
        if (!ipp) { console.error("IPP missing for QR generation."); return null; }
        const qrTargetUrl = `${CONFIG.QR_TARGET_BASE_URL}?ipp=${encodeURIComponent(ipp)}`;
        // Using qrserver API for QR generation
        const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrTargetUrl)}&q=M`; // M for Medium error correction
        console.log("Generated QR Target URL:", qrTargetUrl);
        console.log("Generated QR Image URL:", qrImageUrl);
        return { qrTargetUrl, qrImageUrl };
      }

      function printQRCode(qrImageUrl) {
         if (!qrImageUrl) { console.error("No QR Image URL to print."); return; }
         const printWindow = window.open('', '_blank', 'width=400,height=450');
         if (!printWindow) { alert('Veuillez autoriser les pop-ups pour imprimer.'); return; }
         // Simplified print content
         printWindow.document.write(`
            <!DOCTYPE html><html><head><title>Imprimer QR Code</title>
            <style>
                body { text-align: center; margin: 20px; font-family: sans-serif; }
                img { max-width: 250px; max-height: 250px; border: 1px solid #ccc; padding: 5px; }
                @media print { body { margin: 5mm; } button { display: none; } }
            </style>
            </head><body>
            <img src="${qrImageUrl}" alt="QR Code Patient" />
  </body>
</html>
